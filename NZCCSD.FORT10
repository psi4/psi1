      PROGRAM NZCCSD
C
C     NEW VERSION OF ZCCSDT
C     WRITTEN BY GUSTAVO E. SCUSERIA
C     UPDATED  JULY  27, 1988
C
C***********************************************************************
C  NOTICE OF PROGRAM MODIFICATION
C***********************************************************************
c Moved to PSI area on 2/4/89 by clj.
C***********************************************************************
C      BY:  GUSTAVO E. SCUSERIA
C
C    DATE:  NOVEMBER 15,1988
C  REASON:  SUBROUTINE NFINTS: TRADE OFF IO FOR D AND F INTS IN CORE.
C
C    DATE:  OCTOBER 20, 1988
C  REASON:  SYMMETRY-PACKED EMAT.
C           REDUCE CORE REQUIREMENTS BY SPLITTING INTERMEDIATE AND
C           ITERATIVE PARTS (CCSDT1 WILL REQUIRE MORE CORE THAN CCSD)
C
C    DATE:  OCTOBER 24, 1988
C  REASON:  CCSDT-1 WORKING BUT NOT OPTIMIZED
C
C***********************************************************************
C
      IMPLICIT INTEGER (A-Z)
      REAL*8 CC(1),DELZ,ZCONV,TIMLIM,DELZ2
      REAL*4 EECPU,EETIME,EETCPU
      CHARACTER*32 DATTIM
      CHARACTER*4 CLABEL(20),ZLABEL(20),ZOPT,PRTS,CHAR,RSTR,OPTION,SORT
      COMMON/TIEMPO/EECPU,EETIME,EETCPU
      COMMON/RESTAR/TIMLIM
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
C     DIMENSION IC(3400000),I30(200),I68(30)
      DIMENSION IC( 600000),I30(200),I68(30)
      EQUIVALENCE (CC,IC)
      CALL NOUNFL
C     MAXCOR=1700000
      MAXCOR= 300000
      CALL ZERO(CC,MAXCOR)
C
      CALL TSTART(6)
      INPUT=5
      JOUT=6
      WRITE(JOUT,6000)
 6000 FORMAT(   56('-'),/,56('-'),/,
     .' THE  CLOSED-SHELL  CCSD  LINEAR  RESPONSE  PROGRAM       ',/,
     .'           WRITTEN  BY  GUSTAVO SCUSERIA'     ,/,
     .'        REFORMULATED VERSION JULY 27, 1988',/,56('-'),/,56('-') )
C
      FILE7=7
      FILE9=9
      ITAP30=30
      ITAP60=60
      ITAP61=61
      ITAP62=62
      ITAP63=63
      ITAP64=64
      ITAP65=65
      ITAP66=66
      ITAP68=86
      ITAP69=69
      ITAP71=71
      ITAP82=82
      ITAP83=83
      TPAMAT=90
      TPBMAT=91
      TPFMAT=92
      TPHMAT=93
      TPRMAT=94
      TPQMAT=95
      TPJMAT=96
      ITAP98=98
      ITAP97=97
      ITAP99=99
      NIOBF=100
      LENBUF=NIOBF*(SEC2I(1)/INTOWP(1))
C
      CALL RFILE(ITAP30)
      CALL RFILE(ITAP60)
      CALL RFILE(ITAP61)
      CALL RFILE(ITAP62)
      CALL RFILE(ITAP63)
      CALL RFILE(ITAP64)
      CALL RFILE(ITAP65)
      CALL RFILE(ITAP66)
      CALL RFILE(ITAP69)
      CALL RFILE(ITAP82)
      CALL RFILE(ITAP83)
      CALL RFILE(ITAP97)
      CALL RFILE(ITAP98)
      CALL RFILE(ITAP99)
      CALL DATETM(DATTIM,EECPU,EETIME,EETCPU)
C
      CALL WREADW(ITAP30,I30,200,101,LWORD)
      MPOINT=I30(2)
      MCONST=I30(3)
      MCALCS=I30(4)
      NCALCS=I30(5)
      NBF=I30(18)
      NBFAO=I30(22)
      NIRRED=I30(28)
      NSYMHF=I30(41)
      MXCOEF=I30(42)
      NTR=(NBF*(NBF+1))/2
      NTRAO=(NBFAO*(NBFAO+1))/2
      NT=NBF
C
      CALL ZERO(CC,MAXCOR)
C
      EIGVAL=1
      FOCK=EIGVAL+NBF
      NLAMDA=WPADTI(FOCK+NTR)
      PTOCC=NLAMDA+NSYMHF
      ITYP=PTOCC+NBF
      FLOV=ITYP+NSYMHF
      ORBSYM=FLOV+4*NIRRED
      FZO=ORBSYM+NBF
      FZV=FZO+NBF
      NFZO=FZV+NBF
      NFZV=NFZO+NIRRED
      NT3=NFZV+NIRRED
      ITEMP=NT3+NIRRED
      NC=ITEMP+MCALCS
      ITEP=NC+NSYMHF
      WTEMP=IADTWP(ITEP+NIRRED)
      TOP=WTEMP+NBF-1
C
      CALL READ30(ITAP30,MPOINT,MCONST,MCALCS,NCALCS,NBF,NSYMHF,MXCOEF,
     .            CC(EIGVAL),IC(NLAMDA),IC(ITEMP),JOUT,IC(NC)
     .            ,NO,CC(WTEMP),IC(PTOCC),IC(ITYP),IC(ORBSYM)
     .            ,IC(FLOV),NIRRED,IC(ITEP),ENUC,ESCF,CHAR,NORD)
      NV=NBF-NO
      NTRO=NO*(NO+1)/2
      NTRV=NV*(NV+1)/2
      NO2=NO*NO
      NV2=NV*NV
      NOV=MAX0(NO,NV)
      N2OV=MAX0(NTRV,NO*NV)
      NM=NO*NV
C
C    READ INPUT FOR NON-SCF ORBITALS
C
      CALL LOCATE (5,'# MONGO ###',IERR)
      IF(IERR.NE.0) THEN
      WRITE ( 6,6008)
      WRITE ( 4,6008)
 6008 FORMAT(//,2X,' NO INPUT TO MONGO HAS BEEN FOUND.',/,
     .          2X,' DIAGONAL FOCK MATRIX IS ASSUMED. ',//)
      FLAG=0
      ELSE
      READ(5,6014)FLAG
 6014 FORMAT(I5)
      ENDIF
C
C     FLAG=0 (DEFAULT) USE MO ENERGIES IN THE FOCK MATRIX
C
      IF (FLAG.EQ.0) THEN
      CALL ZERO(CC(FOCK),NTR)
      DO 42 I=1,NBF
      IJ=(I*(I+1))/2
   42 CC(FOCK+IJ-1)=CC(EIGVAL+I-1)
      ELSE
      WRITE(*,*)'NON-DIAGONAL FOCK MATRIX IS READ FROM FILE68'
      CALL RFILE(ITAP68)
      CALL WREADW(ITAP68,I68,9,1,IVEC68)
      IDIMZ=I68(1)
      IVEC68=IVEC68+INTOWP(IDIMZ)
      CALL WREADW(ITAP68,CC(FOCK),INTOWP(NTR),IVEC68,IVEC68)
      CALL RCLOSE(ITAP68,3)
      CALL PRINT(CC(FOCK),NTR,NBF,6)
      ENDIF
      EIGVAL=FOCK
C
C    READ CCSD INPUT
C
      CALL LOCATE (INPUT,'# CCSD ###',IERR)
      IF(IERR.NE.0) THEN
      WRITE (JOUT,6007)
      WRITE ( 4,6007)
 6007 FORMAT(//,2X,' WARNING! NO INPUT TO CCSD HAS BEEN FOUND.',/,
     .          2X,'          DEFAULT PARAMETERS WILL BE USED.',//)
      EPSI=5
      NGO=2
      NMIN =2
      MINDIM=2
      MAXDIM=8
      MAXIT=20
      CONVI=7
      DO 622 I=1,NIRRED
      IC(NFZO+I-1)=0
  622 IC(NFZV+I-1)=0
      ELSE
      READ(5,6004)CLABEL
 6004 FORMAT(20A4)
      READ(5,6002)EPSI,NGO,NMIN ,MINDIM,MAXDIM,FLDIIS,IRSTR
      IF(EPSI  .EQ.0)EPSI  =5
      IF(NGO   .EQ.0)NGO   =2
      IF(NMIN  .EQ.0)NMIN  =2
      IF(MINDIM.EQ.0)MINDIM=2
      IF(MAXDIM.EQ.0)MAXDIM=8
      IF(IRSTR.NE.1) RSTR='NO  '
      IF(IRSTR.EQ.1) RSTR='YES '
      READ(5,6002)CONVI,MAXIT
      IF(CONVI .EQ.0)CONVI =7
      IF(MAXIT .EQ.0)MAXIT =20
 6002 FORMAT(16I5)
      DO 623 I=1,NIRRED
  623 READ(INPUT,6051)IC(NFZO+I-1),IC(NFZV+I-1)
 6051 FORMAT(I2,1X,I2)
      READ(INPUT,6052)OPTION,SORT,PRTS
 6052 FORMAT(A4,1X,A4,1X,A4)
      ENDIF
C
C   FORCE SORT TO 'NO'
C
      SORT='NO  '
C
      WRITE(JOUT,6022)CLABEL,OPTION,SORT,RSTR,CONVI,MAXIT,
     .                FLDIIS,LENBUF,CHAR,NORD
 6022 FORMAT(//,2X,'***** CC PARAMETERS *****',
     .       //,2X,'LABEL  = ',20A4,
     .        /,2X,'OPTION = ',A4,
     .        /,2X,'SORT   = ',A4,
     .        /,2X,'RSTR   = ',A4,
     .        /,2X,'CONVI  = ',I4,
     .        /,2X,'MAXIT  = ',I4,
     .        /,2X,'FLDIIS = ',I4,
     .        /,2X,'LENBUF = ',I6,
     .        /,2X,'SYMM   = ',A4,I1)
C
C     READ ZCCSD INPUT
C
      CALL LOCATE (INPUT,'# ZCCSD ###',IERR)
      IF(IERR.NE.0) THEN
      WRITE (JOUT,6009)
      WRITE ( 4,6009)
 6009 FORMAT(//,2X,' WARNING! NO INPUT TO ZCCSD HAS BEEN FOUND.',/,
     .          2X,'          DEFAULT PARAMETERS WILL BE USED.',/)
      ICONV =10
      ZMAXIT = 30
      ZOPT='NORM'
      ELSE
      READ(5,6104) ZLABEL
 6104 FORMAT (20A4)
      READ(INPUT,6002)ICONV,ZMAXIT
      IF(ICONV .EQ.0)ICONV =10
      IF(ZMAXIT .EQ.0)ZMAXIT =30
      READ (INPUT,6052)ZOPT,PRTS
      ENDIF
      IF (ZOPT.EQ.'    ') ZOPT='NORM'
      NIT=0
      DELZ=2.0D+00
      DELZ2=2.0D+00
      ZCONV=10.D0 ** (-ICONV)
      WRITE(JOUT,6029)ZLABEL,ZOPT,ICONV,ZMAXIT
 6029 FORMAT(//,2X,'**** ZCC PARAMETERS *****',
     .       //,2X,'ZLABEL = ',20A4,
     .        /,2X,'ZOPT   = ',A4,
     .        /,2X,'ICONV  = ',I4,
     .        /,2X,'ZMAXIT = ',I4)
C
C     CALL FROZEN ....
      CALL NCOUNT(IC(ORBSYM),IC(FLOV),NIRRED,NO,NV,NBF,
     .            IC(FZO),IC(FZV),NT1,NT2,
     .            NSGOO,NSGVV,NSGOV,NSHOV,NSLOV,NSLVO,
     .            IC(NT3),NTAU,OPTION,DIMAR)
      LENA=NTRO*(NTRO+1)/2
      LENB=NTRV*(NTRV+1)/2
      LENC=NTRO*NTRV
      LEND=NO*NV*(NO*NV+1)/2
      LENE=NTRO*NO*NV
      LENF=NTRV*NO*NV
      NINT=LENA+LENB+LENC+LEND+LENE+LENF
      NSINT=NSGOO+NSGVV+NSGOV+NSHOV+NSLOV+NSLVO
C
C ~~~~~~~~~~~~  ALLOCATE CC MEMORY  ~~~~~~~~~~~~~~~~
C
C   NOTE: TOFF AND TADD ARE THE "UOFF AND VADD" POINTERS OF BCCSD.
C   ZLX IS ALSO CALCULATED IN SUBROUTINE OFFSET AND NO LONGER IN SYMARR.
C   THE BCCSD ITR(NOV) AND ITV(NV) ARE INO AND INV CALCULATED IN OFFSET.
C   OJO NO2, NONO, NV2 AND NVNV!
C
      IOFF=ITEMP
      INO=IOFF+NTR
      INV=INO+NOV
      INTRO=INV+NOV
      INTRV=INTRO+N2OV
      ZLX=INTRV+NO*NV
      UOFF=ZLX+NV2
      ZLXO=UOFF+2*NO2
      TOFF=ZLXO+NO2
      TADD=TOFF+NO*NO*2
      AOFF= TADD+NV*NV
      AADD=AOFF+NO*NO
      BOFF=AADD+NO*NO
      BADD=BOFF+NV*NV
      COFF=BADD+NV*NV
      CADD=COFF+NV*NV
      DOFF=CADD+NO*NO
      DADD=DOFF+NM
      EOFF=DADD+NM
      EADD=EOFF+NM
      EMOFF=EADD+NO*NO
      EMADD=EMOFF+NM
      FOFF=EMADD+NO*NO
      FADD=FOFF+NV*NV
      UOFFV=FADD+NM
      T1=IADTWP(UOFFV+2*NV2)
      TOP=T1+NO*NV
C
      IF(OPTION.EQ.'SDT1')THEN
         TAU=TOP
         T3OFF=WPADTI(TAU+NTAU)
         WRITE(6,*)'NTAU',NTAU
         T3ADD=T3OFF+NO*NO*NIRRED*2
         TOP=IADTWP(T3ADD+NV*NV*NIRRED)
      ELSE
         TAU=1
         T3OFF=1
         T3ADD=1
      ENDIF
C
      CALL OFFSET(IC(INO),IC(INV),IC(INTRO),IC(INTRV),
     .            IC(ZLX),IC(UOFF),NBF,NO,NV,NOV,NTRO,NTRV,N2OV,
     .            JOUT,IC(ZLXO),IC(UOFFV),IC(IOFF),NTR)
      CALL SYMARR(IC(ORBSYM),IC(FLOV),NIRRED,NO,NV,NBF,NOV,NM,
     .            IC(FZO),IC(FZV),IC(NFZO),IC(NFZV),
     .            IC(TOFF),IC(TADD),IC(INO),IC(INV),
     .            NO*NO,NV*NV,
     .            IC(AOFF),IC(AADD),IC(BOFF),IC(BADD),
     .            IC(COFF),IC(CADD),IC(DOFF),IC(DADD),
     .            IC(EOFF),IC(EADD),IC(FOFF),IC(FADD),
     .            IC(T3OFF),IC(T3ADD),OPTION,
     .            IC(EMOFF),IC(EMADD),LEMAT)
C
      AMAT=TOP
      GOMAT=AMAT+NO*NO
      GVMAT=GOMAT+NO2
      I1MAT=GVMAT+NV2
      TZV=I1MAT+NV*NO
      TZO=TZV+NV2
      EMAT=TZO+NO2
      CCC=EMAT+LEMAT
      BB=CCC+MAXDIM
      BB2=BB+(MAXDIM+1)*(MAXDIM+2)
      LAST=BB2+(MAXDIM+1)*(MAXDIM+2)-1
      AR1=LAST
      AR3=AR1
      AR5=AR1
      AR2=AR1+DIMAR
      AR4=AR2
      AR6=AR2
      AUX1=AR2+DIMAR
      AUX2=AUX1+MAX0(NV*NV,NO*NO)
      AUX3=AUX2+MAX0(NV*NV,NO*NO)
      SFV=AUX3+NV*NV
      ABIN=SFV+NV*NV
      XMAT=ABIN+MAX0(NV*NV,NO*NO)
      LXMAT=MAX0(NO*NV,NV*NV)
      BMAT=XMAT
      FMAT=XMAT
      HMAT=XMAT
      JMAT=XMAT
      RMAT=XMAT
      QMAT=XMAT+LXMAT
      OMG1=QMAT+NO*NV
      OMG2=OMG1+NO*NOV
      OMG3=OMG2+NO*NV
      TOP=OMG3+NV2
      IF (TOP.GT.MAXCOR) THEN
         WRITE(*,*)'TOP',TOP
         WRITE (JOUT,*) ' BEFORE READ OF INTS : NOT ENOUGH CC'
         STOP
      ENDIF
C
      WRITE(*,*)
      WRITE(*,*)'LENGTH OF INTEGRALS ARRAYS AND T AMPLITUDES'
      WRITE(*,*)
      WRITE(*,*)'NGOO =',LENA,'NSGOO =',NSGOO
      WRITE(*,*)'NGVV =',LENB,'NSGVV =',NSGVV
      WRITE(*,*)'NGOV =',LENC,'NSGOV =',NSGOV
      WRITE(*,*)'NHOV =',LEND,'NSHOV =',NSHOV
      WRITE(*,*)'NLOV =',LENE,'NSLOV =',NSLOV
      WRITE(*,*)'NLVO =',LENF,'NSLVO =',NSLVO
      WRITE(*,*)'NINT =',NINT,'NSINT =',NSINT
      WRITE(*,*)'NT1  =',NT1 ,'NT2   =',NT2
      WRITE(*,*)'EMAT =',LEMAT
      WRITE(6,*)
C
      MAXINT=NSGOO
C     IF(NSGVV.GT.MAXINT)MAXINT=NSGVV
      IF(NSGOV.GT.MAXINT)MAXINT=NSGOV
      IF(NSHOV.GT.MAXINT)MAXINT=NSHOV
      IF(NSLOV.GT.MAXINT)MAXINT=NSLOV
      IF(NSLVO.GT.MAXINT)MAXINT=NSLVO
      WRITE(6,*)' '
      WRITE(6,*)' INTEGRAL ARRAY IS ',MAXINT
      WRITE(6,*)' '
C
C
C   ALLOCATE CORE FOR INTERMEDIATE PART
C
      DINTS=TOP
      MOINTS=TOP
      BUF=MOINTS+MAXINT
      IBUF=WPADTI(BUF)
      T2=BUF+LENBUF
      TOPINT=T2+NT2
C
C   ALLOCATE CORE FOR ITERATIVE PART
C
      Z2O=DINTS+NSHOV
      Z2=Z2O+NT2
      Z1O=Z2+NT2
      Z1=Z1O+NO*NV
      TOPITR=Z1+NO*NV
C
      IF(OPTION.EQ.'SDT1')THEN
         DINTS=TOPINT
         Z2O=DINTS+NSHOV
         Z2=Z2O+NT2
         Z1O=Z2+NT2
         Z1=Z1O+NO*NV
         TOPITR=Z1+NO*NV
      ENDIF
C
      ICRINT = TOPINT  *8/1024
      ICRITR = TOPITR  *8/1024
      IMCOR  = MAXCOR  *8/1024
      WRITE(JOUT,6001)IMCOR,MAXCOR,ICRINT,TOPINT,ICRITR,TOPITR
 6001 FORMAT(//,' MAXIMUM  CORE  = ',I7,2X,'K BYTES  OR  ',I9 ,' REAL',
     .         ' WORDS',/,
     .          ' REQUIRED CORE1 = ',I7,2X,'K BYTES  OR  ',I9 ,' REAL',
     .         ' WORDS',/,
     .          ' REQUIRED CORE2 = ',I7,2X,'K BYTES  OR  ',I9 ,' REAL',
     .         ' WORDS',//)
C
      TOP=MAX0(TOPINT,TOPITR)
      IF (TOP.GT.MAXCOR) THEN
         WRITE(6,*)'   '
         WRITE(6,*)' NOT ENOUGH CORE. PROGRAM QUITS ...'
         STOP
      ENDIF
C
C   READ TAPE69
C
      CALL SREAD(ITAP69,NDIMT1,1)
      CALL SREAD(ITAP69,NDIMT2,1)
      IF(NDIMT2.NE.NT2)THEN
         WRITE(6,*)' PROBLEMS ... NT2.NE.NDIMT2'
      ENDIF
      CALL READ69(CC(T1),CC(T2),NO,NV,NDIMT2,ITAP69,FILE7,JOUT,
     .            IT269,IZ169)
C
C   FORM INTEGRAL DRIVEN INTERMEDIATES AND STORE THEM IN FILES 90'S
C
C     A INTS
C
      CALL RDINTS(ITAP60,CC(MOINTS),NSGOO,
     .            JOUT,CC(BUF),IC(IBUF),LENBUF,IC(IOFF),NBF,NTR,
     .            NO,NV,NOV,NTRO,NTRV,NO2,NV2,IC(INO),IC(INTRO),
     .            IC(INTRV),IC(INV),N2OV,
     .            IC(INO),NOV,IC(INO),NOV,
     .            IC(AOFF),NO*NO,IC(AADD),NO*NO)
      CALL AINTS(CC(AMAT),CC(MOINTS),NTRO,NO2,NSGOO,NO,NTR,
     .           IC(IOFF),JOUT,IC(INO),NOV,
     .           IC(AOFF),NO*NO,IC(AADD),NO*NO,
     .           IC(FLOV),NIRRED,IC(ORBSYM))
C
C     B INTS
C
      CALL BINTS (CC(BMAT),NV,NO,IC(FLOV),IC(ORBSYM),NIRRED)
C
C     C INTS
C
      CALL RDINTS(ITAP62,CC(MOINTS),NSGOV,
     .            JOUT,CC(BUF),IC(IBUF),LENBUF,IC(IOFF),NBF,NTR,
     .            NO,NV,NOV,NTRO,NTRV,NO2,NV2,IC(INO),IC(INTRO),
     .            IC(INTRV),IC(INV),N2OV,
     .            IC(INV),NOV,IC(INO),NOV,
     .            IC(COFF),NV*NV,IC(CADD),NO*NO)
      CALL CINTS(CC(EMAT),CC(FMAT),CC(MOINTS),NO,NV,
     .           CC(T1),NSGOV,NTRO,NTR,IC(IOFF),JOUT,IC(INO),
     .           IC(INTRO),IC(INTRV),IC(INV),NOV,N2OV,
     .           IC(FLOV),IC(ORBSYM),NIRRED,
     .           IC(COFF),NV*NV,IC(CADD),NO*NO,
     .           IC(EMOFF),IC(EMADD),LEMAT)
      CALL RCINTS(CC(RMAT),CC(MOINTS),NO,NV,
     .            NSGOV,NTRO,NTR,IC(IOFF),JOUT,IC(INO),
     .            IC(INTRO),IC(INTRV),IC(INV),NOV,N2OV,
     .            IC(FLOV),IC(ORBSYM),NIRRED,
     .            IC(COFF),NV*NV,IC(CADD),NO*NO)
C
C     E INTS
C
      CALL RDINTS(ITAP64,CC(MOINTS),NSLOV,
     .            JOUT,CC(BUF),IC(IBUF),LENBUF,IC(IOFF),NBF,NTR,
     .            NO,NV,NOV,NTRO,NTRV,NO2,NV2,IC(INO),IC(INTRO),
     .            IC(INTRV),IC(INV),N2OV,
     .            IC(INO),NOV,IC(INO),NOV,
     .            IC(EOFF),NM   ,IC(EADD),NO*NO)
      CALL EINTS(CC(JMAT),CC(GOMAT),CC(EMAT),
     .           CC(FMAT),CC(AMAT),CC(MOINTS),NO,NV,
     .           CC(T1),CC(T2),NSLOV,NO2,NV2,NTRO,NTRV,NTR,
     .           IC(IOFF),JOUT,CC(EIGVAL),IC(INO),IC(INTRO),
     .           IC(INTRV),NOV,IC(INV),N2OV,IC(ZLX),
     .           IC(UOFF),IC(FLOV),IC(ORBSYM),NIRRED,
     .           IC(EOFF),NM   ,IC(EADD),NO*NO,
     .           IC(TOFF),IC(TADD),NDIMT2,
     .           IC(EMOFF),IC(EMADD),LEMAT)
      CALL RQEINT(CC(RMAT),CC(QMAT),CC(MOINTS),CC(T1),
     .            NSLOV,NO,NV,NO2,NV2,NTRO,NTRV,NTR,
     .            IC(IOFF),JOUT,IC(INO),IC(INTRO),
     .            IC(INTRV),NOV,IC(INV),N2OV,IC(FLOV),
     .            IC(ORBSYM),NIRRED,
     .            IC(EOFF),NM,IC(EADD),NO*NO)
C
C     F INTS
C
      CALL RDINTS(ITAP65,CC(MOINTS),NSLVO,
     .            JOUT,CC(BUF),IC(IBUF),LENBUF,IC(IOFF),NBF,NTR,
     .            NO,NV,NOV,NTRO,NTRV,NO2,NV2,IC(INO),IC(INTRO),
     .            IC(INTRV),IC(INV),N2OV,
     .            IC(INV),NOV,IC(INO),NOV,
     .            IC(FOFF),NV*NV,IC(FADD),NM)
      CALL FINTS(CC(GVMAT),CC(EMAT),
     .           CC(BMAT),CC(MOINTS),NO,NV,
     .           CC(T1),CC(T2),NSLVO,NO2,NV2,NTRO,NTRV,NTR,
     .           IC(IOFF),JOUT,CC(FOCK),IC(INO),IC(INTRO),
     .           IC(INTRV),NOV,IC(INV),N2OV,IC(ZLX),
     .           IC(UOFF),IC(FLOV),IC(ORBSYM),NIRRED,
     .           IC(FOFF),NV*NV,IC(FADD),NM,
     .           IC(TOFF),IC(TADD),NDIMT2,
     .           CC(AR3),CC(AR4),CC(AUX1),CC(AUX2),
     .           CC(AUX3),CC(SFV),CC(OMG1),
     .           IC(EMOFF),IC(EMADD),LEMAT)
C     CALL FFINTS(CC(FMAT),CC(MOINTS),CC(T1),CC(T2),NO2,NV2,
C    .            NTRO,NTRV,NO,NV,NSLVO,NTR,IC(IOFF),JOUT,IC(INO),
C    .            IC(INTRO),IC(INTRV),NOV,IC(INV),N2OV,
C    .            IC(ZLX),IC(UOFF),IC(FLOV),IC(ORBSYM),
C    .            NIRRED,
C    .            IC(FOFF),NV*NV,IC(FADD),NM,
C    .            IC(TOFF),IC(TADD),NDIMT2)
C
C  NFINTS REQUIRES BOTH MOINTS AND DINTS. THIS IS THE ONLY PLACE.
C
      CALL NFINTS(CC(FMAT),CC(MOINTS),CC(T1),CC(T2),NO2,NV2,
     .            NTRO,NTRV,NO,NV,NSLVO,NTR,IC(IOFF),JOUT,IC(INO),
     .            IC(INTRO),IC(INTRV),NOV,IC(INV),N2OV,
     .            IC(ZLX),IC(UOFF),IC(FLOV),IC(ORBSYM),
     .            NIRRED,
     .            IC(FOFF),NV*NV,IC(FADD),NM,
     .            IC(TOFF),IC(TADD),NDIMT2,
     .            CC(DINTS),IC(DOFF),IC(DADD),
     .            CC(AR1),CC(AR2),CC(OMG1),CC(OMG2),
     .            CC(AUX1),CC(AUX2),CC(AUX1),
     .            CC(BUF),IC(IBUF),LENBUF,NSHOV,NSLVO)
      CALL HFINTS(CC(HMAT),CC(MOINTS),NO2,NV2,
     .            NTRO,NTRV,NO,NV,NSLVO,NTR,IC(IOFF),JOUT,IC(INO),
     .            IC(INTRO),IC(INTRV),NOV,IC(INV),N2OV,
     .            IC(FLOV),IC(ORBSYM),NIRRED,
     .            IC(FOFF),NV*NV,IC(FADD),NM)
      CALL RQFINT(CC(QMAT),CC(RMAT),CC(MOINTS),CC(T1),
     .            NSLVO,NO,NV,NO2,NV2,
     .            NTRO,NTRV,NTR,IC(IOFF),JOUT,IC(INO),
     .            IC(INTRO),IC(INTRV),NOV,IC(INV),N2OV,
     .            IC(FLOV),IC(ORBSYM),NIRRED,
     .            IC(FOFF),NV*NV,IC(FADD),NM)
C
C     D INTS
C
      CALL RDINTS(ITAP63,CC( DINTS),NSHOV,
     .            JOUT,CC(BUF),IC(IBUF),LENBUF,IC(IOFF),NBF,NTR,
     .            NO,NV,NOV,NTRO,NTRV,NO2,NV2,IC(INO),IC(INTRO),
     .            IC(INTRV),IC(INV),N2OV,
     .            IC(INO),NOV,IC(INO),NOV,
     .            IC(DOFF),NM,IC(DADD),NM)
      CALL DINTSS(CC(I1MAT),CC(GVMAT),CC(GOMAT),
     .            CC(JMAT),CC(AMAT),CC(OMG3),
     .            CC(FMAT),CC(EMAT),CC(T1),CC(T2),CC(OMG1),
     .            CC(OMG2),CC( DINTS),NSHOV,NO,NV,NTRO,NTRV,NO2,
     .            NV2,NTR,IC(IOFF),JOUT,IC(INO),IC(INTRO),
     .            IC(INTRV),NOV,IC(INV),N2OV,IC(ZLX),
     .            IC(UOFF),IC(FLOV),IC(ORBSYM),NIRRED,
     .            IC(DOFF),NM,IC(DADD),NM,
     .            IC(TOFF),IC(TADD),NDIMT2,
     .            CC(AR3),CC(AR4),CC(AUX1),
     .            CC(AUX2),CC(SFV),CC(AUX3),
     .            IC(EMOFF),IC(EMADD),LEMAT)
      CALL HDINTS(CC(HMAT),CC( DINTS),NO2,NV2,CC(T1),
     .            NTRO,NTRV,NO,NV,NSHOV,NTR,IC(IOFF),JOUT,IC(INO),
     .            IC(INTRO),IC(INTRV),NOV,IC(INV),N2OV,
     .            IC(FLOV),IC(ORBSYM),NIRRED,
     .            IC(DOFF),NM   ,IC(DADD),NM   )
      CALL BDINTS(CC(BMAT),CC( DINTS),NO2,NV2,CC(T1),CC(T2),
     .            NTRO,NTRV,NO,NV,NSHOV,NTR,IC(IOFF),JOUT,
     .            IC(INO),IC(INTRO),IC(INTRV),NOV,IC(INV),
     .            N2OV,IC(FLOV),IC(ORBSYM),NIRRED,IC(ZLX),
     .            IC(UOFF),
     .            IC(DOFF),NM   ,IC(DADD),NM,
     .            IC(TOFF),IC(TADD),NDIMT2,
     .            CC(AR5),CC(AR6),CC(AUX1),CC(AUX2),
     .            CC(AUX3),CC(SFV),CC(OMG3))
      CALL RQDINT(CC(QMAT),CC(RMAT),CC( DINTS),
     .            NO2,NV2,CC(T1),CC(T2),
     .            NTRO,NTRV,NO,NV,NSHOV,NTR,IC(IOFF),JOUT,
     .            IC(INO),IC(INTRO),IC(INTRV),NOV,IC(INV),
     .            N2OV,IC(ZLX),IC(UOFF),IC(FLOV),IC(
     .            ORBSYM),NIRRED,
     .            IC(DOFF),NM   ,IC(DADD),NM,
     .            IC(TOFF),IC(TADD),NDIMT2,
     .            CC(AR1),CC(AR2),CC(AUX1),CC(AUX2),
     .            CC(OMG1),CC(OMG2))
C
      CALL ECORR(CC(T2),CC(T1),CC( DINTS),NSHOV,NO,NV,NO2,NV2,
     .           NTRO,NTRV,IC(IOFF),NTR,JOUT,IC(INO),IC(INTRO),
     .           IC(INTRV),NOV,IC(INV),N2OV,IC(ZLX),
     .           IC(UOFF),IC(FLOV),IC(ORBSYM),NIRRED,
     .           IC(DOFF),NM   ,IC(DADD),NM,
     .           IC(TOFF),IC(TADD),NDIMT2)
C
      CALL ADDE(CC(EMAT),CC(I1MAT),CC(JMAT),CC(T1),
     .          CC(T2),IC(IOFF),NO,NV,NTRO,NTRV,NO2,NV2,NTR,JOUT,
     .          IC(INO),IC(INTRO),IC(INTRV),NOV,IC(INV),
     .          N2OV,IC(ZLX),IC(ZLXO),IC(UOFF),IC(FLOV),
     .          IC(ORBSYM),NIRRED,
     .          IC(TOFF),IC(TADD),NDIMT2,
     .          IC(EMOFF),IC(EMADD),LEMAT)
C
      WRITE(6,*)
      WRITE(6,*)'ALL INTERMEDIATES HAVE BEEN FORMED'
      CALL TIMIT(4,JOUT)
C
      IF (ZOPT.EQ.'RSTR') THEN
         CALL RSETSA(ITAP69,IZ169)
         CALL SREAD(ITAP69,CC(Z1O),INTOWP(NO*NV))
         CALL SREAD(ITAP69,CC(Z2O),INTOWP(NDIMT2))
      ELSE
         IFLG=0
         CALL INITZ(CC(Z1O),CC(Z2O),CC(I1MAT),CC( DINTS),NSHOV,
     .              CC(EIGVAL),IC(IOFF),NO,NV,NTRO,NTRV,
     .              NO2,NV2,NTR,NBF,JOUT,IFLG,IC(INO),IC(INTRO),
     .              IC(INTRV),NOV,IC(INV),N2OV,IC(FLOV),IC(
     .              ORBSYM),NIRRED,
     .              IC(DOFF),NM,IC(DADD),NM,
     .              IC(ZLX),IC(TOFF),IC(TADD),NDIMT2)
      ENDIF
      IFLG=1
C
 1001 CONTINUE
      IF (NIT.LE.ZMAXIT.AND.DELZ2.GT.ZCONV) THEN
C
C      START ITERATIVE PROCEDURE
C
C THIS IS THE ONLY PLACE IN THE ITERATIVE PART WHERE T2 IS NEEDED.
C IT IS READ INTO Z2 AND PASS TO T2Z2.
C
      CALL RSETSA(ITAP69,IT269)
      CALL SREAD(ITAP69,CC(Z2),INTOWP(NDIMT2))
      CALL T2Z2(CC(TZV),CC(TZO),CC(Z2O),CC(Z2),NO,NV,NO2,NV2,
     .          NTRO,NTRV,NTR,IC(IOFF),JOUT,IC(INO),
     .          IC(INTRO),IC(INTRV),NOV,IC(INV),N2OV,IC(ZLX),
     .          IC(UOFF),IC(FLOV),IC(ORBSYM),NIRRED,
     .          IC(TOFF),IC(TADD),NDIMT2)
 
      CALL INITZ(CC(Z1),CC(Z2),CC(I1MAT),CC( DINTS),NSHOV,
     .           CC(EIGVAL),IC(IOFF),NO,NV,NTRO,NTRV,
     .           NO2,NV2,NTR,NBF,JOUT,IFLG,IC(INO),IC(INTRO),
     .           IC(INTRV),NOV,IC(INV),N2OV,IC(FLOV),
     .           IC(ORBSYM),NIRRED,
     .           IC(DOFF),NM   ,IC(DADD),NM,
     .           IC(ZLX),IC(TOFF),IC(TADD),NDIMT2)
      CALL RQTERM(CC(Z1),CC(Z2),CC(Z1O),CC(Z2O),
     .            CC(RMAT),CC(QMAT),
     .            IC(IOFF),NO,NV,NO2,NV2,NTRO,NTRV,NTR,JOUT,
     .            IC(INO),IC(INTRO),IC(INTRV),NOV,IC(INV),
     .            N2OV,IC(ZLX),IC(UOFF),
     .            IC(FLOV),IC(ORBSYM),NIRRED,
     .            CC(AUX1),CC(AUX2),CC(AR1),CC(AR2),
     .            IC(TOFF),IC(TADD),NDIMT2)
      CALL HJTERM(CC(Z1),CC(Z2),CC(Z1O),CC(TZO),CC(TZV),
     .            CC(HMAT),CC(JMAT),NO,NV,NO2,NV2,NTRO,NTRV,NTR,
     .            IC(IOFF),JOUT,CC(FOCK),IC(INO),
     .            IC(INTRO),IC(INTRV),NOV,IC(INV),N2OV,
     .            IC(FLOV),IC(ORBSYM),NIRRED,
     .            IC(ZLX),IC(TOFF),IC(TADD),NDIMT2)
      CALL ABTERM(CC(Z2),CC(Z2O),CC(AMAT),CC(BMAT),NO,NV,NO2,
     .            NV2,NTRO,NTRV,NTR,IC(IOFF),JOUT,IC(INO),
     .            IC(INTRO),IC(INTRV),NOV,IC(INV),N2OV,
     .            IC(ZLX),IC(UOFF),IC(ZLXO),IC(UOFFV),
     .            IC(FLOV),IC(ORBSYM),NIRRED,
     .            CC(Z1),CC(T1),CC(AR3),CC(AR4),
     .            CC(AR5),CC(AR6),CC(ABIN),CC(SFV),
     .            CC(AUX1),CC(AUX2),CC(AUX3),
     .            IC(TOFF),IC(TADD),NDIMT2)
      CALL ETERM(CC(Z1),CC(Z2O),CC(EMAT),NO,NV,NO2,NV2,NTRO,
     .           NTRV,NTR,IC(IOFF),JOUT,IC(INO),IC(INTRO),
     .           IC(INTRV),NOV,IC(INV),N2OV,IC(ZLX),
     .           IC(UOFF),IC(FLOV),IC(ORBSYM),NIRRED,
     .           IC(TOFF),IC(TADD),NDIMT2,
     .           IC(EMOFF),IC(EMADD),LEMAT)
      CALL FTERM(CC(Z1),CC(Z2O),CC(FMAT),NO,NV,NO2,NV2,NTRO,
     .           NTRV,NTR,IC(IOFF),JOUT,IC(INO),IC(INTRO),
     .           IC(INTRV),NOV,IC(INV),N2OV,IC(ZLX),
     .           IC(UOFF),IC(FLOV),IC(ORBSYM),NIRRED,
     .           IC(TOFF),IC(TADD),NDIMT2)
      CALL MTERM(CC(Z2),CC(TZO),CC(TZV),NO,NV,NO2,NV2,NTRO,
     .           NTRV,NTR,IC(IOFF),CC( DINTS),NSHOV,JOUT,
     .           IC(INO),IC(INTRO),IC(INTRV),NOV,
     .           IC(INV),N2OV,
     .           IC(FLOV),IC(ORBSYM),NIRRED,
     .           IC(DOFF),NM,IC(DADD),NM,
     .           IC(TOFF),IC(TADD),NDIMT2)
      CALL GTERM(CC(Z2),CC(Z1),CC(Z1O),CC(Z2O),CC(GOMAT),
     .           CC(GVMAT),NO,NV,NO2,NV2,NTRO,NTRV,NTR,IC(IOFF),
     .           JOUT,CC(FOCK),CC(T1),IC(INO),IC(INTRO),
     .           IC(INTRV),NOV,IC(INV),N2OV,IC(ZLX),
     .           IC(UOFF),IC(FLOV),IC(ORBSYM),NIRRED,
     .           IC(TOFF),IC(TADD),NDIMT2)
      CALL ITERM(CC(Z2),CC(Z1O),CC(I1MAT),NO,NV,NO2,NV2,NTRO,
     .           NTRV,NTR,IC(IOFF),JOUT,IC(INO),IC(INTRO),
     .           IC(INTRV),NOV,IC(INV),N2OV,
     .           IC(ZLX),IC(FLOV),IC(ORBSYM),NIRRED,
     .           IC(TOFF),IC(TADD),NDIMT2)
C
C      R3 MATRIX FOR CCSDT
C
C  T2 IS NEEDED IN Y3 ONLY IF SORT='YES '. SORT IS FORCED TO 'NO' ABOVE
C
      IF(OPTION.EQ.'SDT1')THEN
         CALL Y3(CC(MOINTS),NSHOV,NSLVO,NSLOV,MAXINT,NO,NV,
     .           CC(BUF),IC(IBUF),LENBUF,
     .           IC(DOFF),NM   ,IC(DADD),NM,
     .           IC(EOFF),NM,IC(EADD),NO*NO,
     .           IC(FOFF),NV*NV,IC(FADD),NM,
     .           IC(FLOV),IC(ORBSYM),IC(ZLX),NIRRED,
     .           CC(TAU),IC(TOFF),IC(TADD),NDIMT2,NTAU,
     .           IC(INO),NOV,IC(INV),NV,
     .           CC(Z1O),CC(Z2O),CC(Z1),CC(Z2),NO2,NTRV,ITAP97,
     .           IC(T3OFF),IC(T3ADD),IC(NT3),
     .           IC(IOFF),NTR,IC(UOFF),CC(FOCK),
     .           ITAP82,ITAP83,CC(T2),NNT2,SORT,NIT)
      ENDIF
C
      CALL NORMZ(CC(Z2),CC(Z1),CC(EIGVAL),NO,NV,NBF,NTR,
     .           NO2,NTRV,IC(IOFF),JOUT,IC(INO),IC(INTRO),
     .           IC(INTRV),NOV,IC(INV),N2OV,
     .           IC(ZLX),IC(FLOV),IC(ORBSYM),NIRRED,
     .           IC(TOFF),IC(TADD),NDIMT2)
      CALL ZDIFF(CC(Z2),CC(Z1),CC(Z2O),CC(Z1O),DELZ,NO,NV,
     .           NTR,NO2,NTRV,IC(IOFF),JOUT,IC(INO),
     .           IC(INTRO),IC(INTRV),NOV,IC(INV),N2OV,DELZ2,
     .           IC(ZLX),IC(FLOV),IC(ORBSYM),NIRRED,
     .           IC(TOFF),IC(TADD),NDIMT2)
C     CALL DIISC(CC(Z1O),CC(Z1),CC(Z2O),CC(Z2),NO,NV,
C    .           NO2*NTRV,NIT,IT,IECORR,EPSI,NGO,NDIIS,MINDIM,MAXDIM,
C    .           CC(CCC),CC(BB),CC(TT1),CC(DT1),CC(TT2),
C    .           CC(DT2))
      CALL DIISD(CC(Z1O),CC(Z1),CC(Z2O),CC(Z2),NO,NV,
     .           NDIMT2  ,NIT,IT,IECORR,EPSI,NGO,NDIIS,MINDIM,MAXDIM,
     .           CC(CCC),CC(BB),ITAP98,ITAP99,ITC,CC(BB2))
      CALL NEWZ(CC(Z2),CC(Z1),CC(Z2O),CC(Z1O),NO,NV,
     .          NTR,NO2,NTRV,IC(IOFF),JOUT,IC(INO),IC(INTRO),
     .          IC(INTRV),NOV,IC(INV),N2OV,
     .          IC(ORBSYM),IC(FLOV),NIRRED,
     .          IC(ZLX),IC(TOFF),IC(TADD),NDIMT2)
C
      NIT=NIT+1
      WRITE (JOUT,6057) NIT,DELZ,DELZ2
      WRITE (4   ,6057) NIT,DELZ,DELZ2
 6057 FORMAT (/,2X,'NIT =',I3,' DELTA Z =',F20.12,10X,F20.12)
C
         IF(NIT.LE.5)CALL TIMIT(4,JOUT)
         CALL RSETSA(ITAP69,IZ169)
         CALL SWRIT(ITAP69,CC(Z1),INTOWP(NO*NV))
         CALL SWRIT(ITAP69,CC(Z2),INTOWP(NDIMT2))
         CALL ZERO(CC(Z2),NDIMT2)
         GOTO 1001
      ENDIF
C
      CALL RSETSA(ITAP69,IZ169)
      CALL SWRIT(ITAP69,CC(Z1),INTOWP(NO*NV))
      CALL SWRIT(ITAP69,CC(Z2O),INTOWP(NDIMT2))
C
      CALL RCLOSE(ITAP30,3)
      CALL RCLOSE(ITAP60,3)
      CALL RCLOSE(ITAP61,3)
      CALL RCLOSE(ITAP62,3)
      CALL RCLOSE(ITAP63,3)
      CALL RCLOSE(ITAP64,3)
      CALL RCLOSE(ITAP65,3)
      CALL RCLOSE(ITAP66,3)
      CALL RCLOSE(ITAP69,3)
      CALL RCLOSE(ITAP82,3)
      CALL RCLOSE(ITAP83,3)
      IF(OPTION.EQ.'SDT1')THEN
      CALL RCLOSE(ITAP97,3)
      ENDIF
      CALL RFILE (TPAMAT)
      CALL RFILE (TPBMAT)
      CALL RFILE (TPFMAT)
      CALL RFILE (TPHMAT)
      CALL RFILE (TPRMAT)
      CALL RFILE (TPQMAT)
      CALL RFILE (TPJMAT)
      CALL RCLOSE(TPAMAT,4)
      CALL RCLOSE(TPBMAT,4)
      CALL RCLOSE(TPFMAT,4)
      CALL RCLOSE(TPHMAT,4)
      CALL RCLOSE(TPRMAT,4)
      CALL RCLOSE(TPQMAT,4)
      CALL RCLOSE(TPJMAT,4)
      CALL RCLOSE(ITAP98,4)
      CALL RCLOSE(ITAP99,4)
      CALL TSTOP(6)
      STOP
      END
C                         ********************
C-------------------------******   Y3   ******-------------------------
C                         ********************
C
      SUBROUTINE Y3(II,NHOV,NLVO,NLOV,NTIN,NO,NV,
     .              BUF,IBUF,INTBUF,DOFF,DUM1,DADD,DUM2,
     .              EOFF,NM,EADD,NONO,FOFF,NVNV,FADD,DUM3,
     .              FLOV,ORBSYM,ZLX,NIRRED,TAU,UOFF,VADD,NDIMT2,NTAU,
     .              ITR,NOV,ITV,DUM4,Z1O,Z2O,Z1,Z2,NO2,NTRV,ITAP97,
     .              TOFF,TADD,NT3,IOFF,NTR,ZOFF,FOCK,
     .              ITAP82,ITAP83,T2,NNT2,SORT,NIT)
      IMPLICIT INTEGER(A-Z)
      CHARACTER*4 SORT
      REAL*8 II(NTIN), TAU(NTAU),Z1(NO,NV),Z2(NDIMT2),T2(NNT2),
     .       Z1O(NO,NV),Z2O(NDIMT2),FOCK(NTR),BUF(INTBUF),VAL
      DIMENSION EOFF(NM),EADD(NONO),FOFF(NVNV),FADD(NM),
     .          FLOV(NIRRED,4),ORBSYM(NO+NV),ZLX(NV,NV),
     .          UOFF(NO,NO,2),VADD(NV,NV),ITR(NOV),ITV(NV),
     .          TOFF(NO,NO,2,NIRRED),TADD(NV,NV,NIRRED),NT3(NIRRED),
     .          DOFF(NM),DADD(NM),IOFF(NTR),ZOFF(NO,NO,2),IBUF(2*INTBUF)
C
C     T2 IS NEEDED ONLY IF SORT='YES '.
C
         IF(NIT.EQ.0)THEN
         WRITE(6,*)'ENTERING Y3 SUBROUTINE'
         CALL TIMIT(4,6)
         ENDIF
C
C
C     FORM Y MATRIX.
C
C     ADD D INTS TO Y MATRIX
C
      CALL RDINTS(63,II,NHOV,6,BUF,IBUF,INTBUF,
     .            IOFF,NO+NV,NTR,NO,NV,NOV,NTRO,NTRV,NO2,NV2,ITR,INTRO,
     .            INTRV,ITV,N2OV,
     .            ITR,NOV,ITR,NOV,DOFF,NM,DADD,NM)
C
      I82=1
      DO 3190 A=1,NV
      ASYM=ORBSYM(A+NO)
      DO 3185 I=1,NO
      ISYM=ORBSYM(I)
      IASYM=IEOR(ISYM,ASYM)+1
      DIM=NT3(IASYM)
      CALL ZERO(TAU,DIM)
      IA=ITR(A)+I
C
      DO 3180 J=1,NO
      JSYM=ORBSYM(J)
      JA=ITR(A)+J
      BSYM=IEOR(IASYM-1,JSYM)+1
      FB=FLOV(BSYM,3)-NO
      LB=FLOV(BSYM,4)-NO
      DO 3175 B=FB,LB
      IB=ITR(B)+I
      JB=ITR(B)+J
      IAJB=DOFF(MAX0(IA,JB))+DADD(MIN0(IA,JB))
      IBJA=DOFF(MAX0(IB,JA))+DADD(MIN0(IB,JA))
      DO 3170 K=1,NO
      KSYM=ORBSYM(K)
      FC=FLOV(KSYM+1,3)-NO
      LC=FLOV(KSYM+1,4)-NO
      LC2=LC
      IF(LC2.GT.B)LC2=B
      DO 3165 C=FC,LC2
      JKBC=TOFF(J,K,1,IASYM)+TADD(B,C,IASYM)
      TAU(JKBC)=TAU(JKBC)-(II(IAJB)+II(IAJB)-II(IBJA))*Z1O(K,C)
 3165 CONTINUE
      FC2=FC
      IF(FC2.LT.B)FC2=B
      DO 3166 C=FC2,LC
      KJCB=TOFF(K,J,1,IASYM)+TADD(C,B,IASYM)
      TAU(KJCB)=TAU(KJCB)-(II(IAJB)+II(IAJB)-II(IBJA))*Z1O(K,C)
 3166 CONTINUE
 3170 CONTINUE
 3175 CONTINUE
C
      CSYM=IEOR(IASYM-1,JSYM)+1
      FC=FLOV(CSYM,3)-NO
      LC=FLOV(CSYM,4)-NO
      DO 3775 C=FC,LC
      IC=ITR(C)+I
      JC=ITR(C)+J
      IAJC=DOFF(MAX0(IA,JC))+DADD(MIN0(IA,JC))
      ICJA=DOFF(MAX0(IC,JA))+DADD(MIN0(IC,JA))
      DO 3770 K=1,NO
      KSYM=ORBSYM(K)
      FB=FLOV(KSYM+1,3)-NO
      LB=FLOV(KSYM+1,4)-NO
      FB2=FB
      IF(FB.LT.C)FB2=C
      DO 3765 B=FB2,LB
      JKBC=TOFF(J,K,1,IASYM)+TADD(B,C,IASYM)
      TAU(JKBC)=TAU(JKBC)+(II(IAJC)+II(IAJC)-II(ICJA))*Z1O(K,B)
 3765 CONTINUE
      LB2=LB
      IF(LB.GT.C)LB2=C
      DO 3767 B=FB,LB2
      KJCB=TOFF(K,J,1,IASYM)+TADD(C,B,IASYM)
      TAU(KJCB)=TAU(KJCB)+(II(IAJC)+II(IAJC)-II(ICJA))*Z1O(K,B)
 3767 CONTINUE
 3770 CONTINUE
 3775 CONTINUE
 3180 CONTINUE
C
CS    IF(SORT.NE.'YES ')THEN
      DO 3380 J=1,NO
      JSYM=ORBSYM(J)
      JA=ITR(A)+J
      DO 3375 B=1,NV
      BSYM=ORBSYM(B+NO)
      IBSYM=IEOR(ISYM,BSYM)
      JBSYM=IEOR(JSYM,BSYM)
      IB=ITR(B)+I
      JB=ITR(B)+J
      IAJBS=IEOR(IASYM-1,JBSYM)
      DO 3370 K=1,NO
      KSYM=ORBSYM(K)
      KASYM=IEOR(KSYM,ASYM)
      KA=ITR(A)+K
      KB=ITR(B)+K
      CSYM=IEOR(IAJBS,KSYM)
      KCSYM=IEOR(KSYM,CSYM)
      FC=FLOV(CSYM+1,3)-NO
      LC=FLOV(CSYM+1,4)-NO
      LC2=LC
      IF(LC.GT.B)LC2=B
      DO 3365 C=FC,LC2
      IC=ITR(C)+I
      JC=ITR(C)+J
      KC=ITR(C)+K
      VAL=0.0D0
      JBKAS=IEOR(JBSYM,KASYM)
      IF(JBKAS.EQ.0)THEN
      JBKA=DOFF(MAX0(JB,KA))+DADD(MIN0(JB,KA))
      JAKB=DOFF(MAX0(JA,KB))+DADD(MIN0(JA,KB))
      VAL=VAL+(II(JBKA)+II(JBKA)-II(JAKB))*Z1O(I,C)
      ENDIF
      JBKCS=IEOR(JBSYM,KCSYM)
      IF(JBKCS.EQ.0)THEN
      JBKC=DOFF(MAX0(JB,KC))+DADD(MIN0(JB,KC))
      JCKB=DOFF(MAX0(JC,KB))+DADD(MIN0(JC,KB))
      VAL=VAL-(II(JBKC)+II(JBKC)-II(JCKB))*Z1O(I,A)
      ENDIF
      KCIBS=IEOR(KCSYM,IBSYM)
      IF(KCIBS.EQ.0)THEN
      KCIB=DOFF(MAX0(KC,IB))+DADD(MIN0(KC,IB))
      KBIC=DOFF(MAX0(KB,IC))+DADD(MIN0(KB,IC))
      VAL=VAL+(II(KCIB)+II(KCIB)-II(KBIC))*Z1O(J,A)
      ENDIF
      KCIAS=IEOR(KCSYM,IASYM-1)
      IF(KCIAS.EQ.0)THEN
      KCIA=DOFF(MAX0(KC,IA))+DADD(MIN0(KC,IA))
      KAIC=DOFF(MAX0(KA,IC))+DADD(MIN0(KA,IC))
      VAL=VAL-(II(KCIA)+II(KCIA)-II(KAIC))*Z1O(J,B)
      ENDIF
      JKBC=TOFF(J,K,1,IASYM)+TADD(B,C,IASYM)
      TAU(JKBC)=TAU(JKBC)+VAL
 3365 CONTINUE
      FC2=FC
      IF(FC.LT.B)FC2=B
      DO 3366 C=FC2,LC
      IC=ITR(C)+I
      JC=ITR(C)+J
      KC=ITR(C)+K
      VAL=0.0D0
      JBKAS=IEOR(JBSYM,KASYM)
      IF(JBKAS.EQ.0)THEN
      JBKA=DOFF(MAX0(JB,KA))+DADD(MIN0(JB,KA))
      JAKB=DOFF(MAX0(JA,KB))+DADD(MIN0(JA,KB))
      VAL=VAL+(II(JBKA)+II(JBKA)-II(JAKB))*Z1O(I,C)
      ENDIF
      JBKCS=IEOR(JBSYM,KCSYM)
      IF(JBKCS.EQ.0)THEN
      JBKC=DOFF(MAX0(JB,KC))+DADD(MIN0(JB,KC))
      JCKB=DOFF(MAX0(JC,KB))+DADD(MIN0(JC,KB))
      VAL=VAL-(II(JBKC)+II(JBKC)-II(JCKB))*Z1O(I,A)
      ENDIF
      KCIBS=IEOR(KCSYM,IBSYM)
      IF(KCIBS.EQ.0)THEN
      KCIB=DOFF(MAX0(KC,IB))+DADD(MIN0(KC,IB))
      KBIC=DOFF(MAX0(KB,IC))+DADD(MIN0(KB,IC))
      VAL=VAL+(II(KCIB)+II(KCIB)-II(KBIC))*Z1O(J,A)
      ENDIF
      KCIAS=IEOR(KCSYM,IASYM-1)
      IF(KCIAS.EQ.0)THEN
      KCIA=DOFF(MAX0(KC,IA))+DADD(MIN0(KC,IA))
      KAIC=DOFF(MAX0(KA,IC))+DADD(MIN0(KA,IC))
      VAL=VAL-(II(KCIA)+II(KCIA)-II(KAIC))*Z1O(J,B)
      ENDIF
      KJCB=TOFF(K,J,1,IASYM)+TADD(C,B,IASYM)
      TAU(KJCB)=TAU(KJCB)+VAL
 3366 CONTINUE
 3370 CONTINUE
 3375 CONTINUE
 3380 CONTINUE
CS    ENDIF
C
      CALL WWRITW(ITAP82,TAU,INTOWP(DIM),I82,I82)
 3185 CONTINUE
 3190 CONTINUE
         IF(NIT.EQ.0)THEN
         WRITE(6,*)'END D INTS CONTRIBUTION TO Y3 MATRIX'
         CALL TIMIT(4,6)
         ENDIF
C
C     ADD E INTS TO Y MATRIX.
C
      CALL RDINTS(64,II,NLOV,6,BUF,IBUF,INTBUF,
     .            IOFF,NO+NV,NTR,NO,NV,NOV,NTRO,NTRV,NO2,NV2,ITR,INTRO,
     .            INTRV,ITV,N2OV,
     .            ITR,NOV,ITR,NOV,EOFF,NM,EADD,NONO)
      I82=1
      DO 2991 A=1,NV
      ASYM=ORBSYM(A+NO)
      DO 2981 I=1,NO
      ISYM=ORBSYM(I)
      IASYM=IEOR(ISYM,ASYM)+1
      IA=ITR(A)+I
      DIM=NT3(IASYM)
      CALL WREADW(ITAP82,TAU,INTOWP(DIM),I82,JUNK)
      DO 2971 J=1,NO
      JA=ITR(A)+J
      JSYM=ORBSYM(J)
      IJSYM=IEOR(ISYM,JSYM)
      JASYM=IEOR(JSYM,ASYM)
      DO 2961 B=1,NV
      JB=ITR(B)+J
      BSYM=ORBSYM(B+NO)
      ABSYM=IEOR(ASYM,BSYM)
      JBSYM=IEOR(JSYM,BSYM)
      ZLAB=ZLX(A,B)
      AB=IOFF(MAX0(A,B))+MIN0(A,B)
      BA=AB
C
      DO 2951 C=1,B
      CSYM=ORBSYM(C+NO)
      BCSYM=IEOR(BSYM,CSYM)
      ABCSYM=IEOR(ABSYM,CSYM)
      KSYM=IEOR(ABCSYM,IJSYM)
      KCSYM=IEOR(KSYM,CSYM)
      ICSYM=IEOR(ISYM,CSYM)
      KBSYM=IEOR(KSYM,BSYM)
      FK=FLOV(KSYM+1,1)
      LK=FLOV(KSYM+1,2)
      ZLAC=ZLX(A,C)
      ZLBC=ZLX(B,C)
      AC=IOFF(MAX0(A,C))+MIN0(A,C)
      CA=AC
      BC=IOFF(MAX0(B,C))+MIN0(B,C)
      CB=BC
      IC=ITR(C)+I
      JC=ITR(C)+J
      DO 2941 K=FK,LK
      KC=ITR(C)+K
      KA=ITR(A)+K
      KB=ITR(B)+K
      JKBC=TOFF(J,K,1,IASYM)+TADD(B,C,IASYM)
C
      LSYM=IEOR(KCSYM,ISYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3042 L=FL,LL
      LJAB=UOFF(L,J,ZLAB)+VADD(A,B)
      IL=ITR(MAX0(I,L))+MIN0(I,L)
      KL=ITR(MAX0(K,L))+MIN0(K,L)
      ILKC=EOFF(KC)+EADD(IL)
      ICKL=EOFF(IC)+EADD(KL)
      TAU(JKBC)=TAU(JKBC)+(II(ILKC)+II(ILKC)-II(ICKL))*Z2O(LJAB)
 3042 CONTINUE
C
      LSYM=IEOR(KBSYM,ISYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3043 L=FL,LL
      LJAC=UOFF(L,J,ZLAC)+VADD(A,C)
      IL=ITR(MAX0(I,L))+MIN0(I,L)
      ILKB=EOFF(KB)+EADD(IL)
      TAU(JKBC)=TAU(JKBC)-II(ILKB)*Z2O(LJAC)
 3043 CONTINUE
C
CS    IF(SORT.NE.'YES ')THEN
      LSYM=IEOR(IASYM-1,JSYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3142 L=FL,LL
      LKBC=UOFF(L,K,ZLBC)+VADD(B,C)
      IL=ITR(MAX0(I,L))+MIN0(I,L)
      JL=ITR(MAX0(J,L))+MIN0(J,L)
      JLIA=EOFF(IA)+EADD(JL)
      JAIL=EOFF(JA)+EADD(IL)
      TAU(JKBC)=TAU(JKBC)+(II(JLIA)+II(JLIA)-II(JAIL))*Z2O(LKBC)
 3142 CONTINUE
C
      LSYM=IEOR(ICSYM,JSYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3143 L=FL,LL
      LKBA=UOFF(K,L,ZLAB)+VADD(A,B)
      JL=ITR(MAX0(J,L))+MIN0(J,L)
      JLIC=EOFF(IC)+EADD(JL)
      TAU(JKBC)=TAU(JKBC)-II(JLIC)*Z2O(LKBA)
 3143 CONTINUE
C
      LSYM=IEOR(JBSYM,KSYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3242 L=FL,LL
      LICA=UOFF(I,L,ZLAC)+VADD(A,C)
      JL=ITR(MAX0(J,L))+MIN0(J,L)
      KL=ITR(MAX0(K,L))+MIN0(K,L)
      KLJB=EOFF(JB)+EADD(KL)
      KBJL=EOFF(KB)+EADD(JL)
      TAU(JKBC)=TAU(JKBC)+(II(KLJB)+II(KLJB)-II(KBJL))*Z2O(LICA)
 3242 CONTINUE
C
      LSYM=IEOR(JASYM,KSYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3243 L=FL,LL
      LICB=UOFF(I,L,ZLBC)+VADD(B,C)
      KL=ITR(MAX0(K,L))+MIN0(K,L)
      KLJA=EOFF(JA)+EADD(KL)
      TAU(JKBC)=TAU(JKBC)-II(KLJA)*Z2O(LICB)
 3243 CONTINUE
CS    ENDIF
C
 2941 CONTINUE
 2951 CONTINUE
C
      DO 2952 C=B,NV
      CSYM=ORBSYM(C+NO)
      BCSYM=IEOR(BSYM,CSYM)
      ABCSYM=IEOR(ABSYM,CSYM)
      KSYM=IEOR(ABCSYM,IJSYM)
      KCSYM=IEOR(KSYM,CSYM)
      ICSYM=IEOR(ISYM,CSYM)
      KBSYM=IEOR(KSYM,BSYM)
      FK=FLOV(KSYM+1,1)
      LK=FLOV(KSYM+1,2)
      ZLAC=ZLX(A,C)
      ZLBC=ZLX(B,C)
      AC=IOFF(MAX0(A,C))+MIN0(A,C)
      CA=AC
      BC=IOFF(MAX0(B,C))+MIN0(B,C)
      CB=BC
      IC=ITR(C)+I
      JC=ITR(C)+J
      DO 2942 K=FK,LK
      KC=ITR(C)+K
      KA=ITR(A)+K
      KB=ITR(B)+K
      KJCB=TOFF(K,J,1,IASYM)+TADD(C,B,IASYM)
C
      LSYM=IEOR(KCSYM,ISYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3044 L=FL,LL
      LJAB=UOFF(L,J,ZLAB)+VADD(A,B)
      IL=ITR(MAX0(I,L))+MIN0(I,L)
      KL=ITR(MAX0(K,L))+MIN0(K,L)
      ILKC=EOFF(KC)+EADD(IL)
      ICKL=EOFF(IC)+EADD(KL)
      TAU(KJCB)=TAU(KJCB)+(II(ILKC)+II(ILKC)-II(ICKL))*Z2O(LJAB)
 3044 CONTINUE
C
      LSYM=IEOR(KBSYM,ISYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3045 L=FL,LL
      LJAC=UOFF(L,J,ZLAC)+VADD(A,C)
      IL=ITR(MAX0(I,L))+MIN0(I,L)
      ILKB=EOFF(KB)+EADD(IL)
      TAU(KJCB)=TAU(KJCB)-II(ILKB)*Z2O(LJAC)
 3045 CONTINUE
C
CS    IF(SORT.NE.'YES ')THEN
      LSYM=IEOR(IASYM-1,JSYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3144 L=FL,LL
      LKBC=UOFF(L,K,ZLBC)+VADD(B,C)
      IL=ITR(MAX0(I,L))+MIN0(I,L)
      JL=ITR(MAX0(J,L))+MIN0(J,L)
      JLIA=EOFF(IA)+EADD(JL)
      JAIL=EOFF(JA)+EADD(IL)
      TAU(KJCB)=TAU(KJCB)+(II(JLIA)+II(JLIA)-II(JAIL))*Z2O(LKBC)
 3144 CONTINUE
C
      LSYM=IEOR(ICSYM,JSYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3145 L=FL,LL
      LKBA=UOFF(K,L,ZLAB)+VADD(A,B)
      JL=ITR(MAX0(J,L))+MIN0(J,L)
      JLIC=EOFF(IC)+EADD(JL)
      TAU(KJCB)=TAU(KJCB)-II(JLIC)*Z2O(LKBA)
 3145 CONTINUE
C
      LSYM=IEOR(JBSYM,KSYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3244 L=FL,LL
      LICA=UOFF(I,L,ZLAC)+VADD(A,C)
      JL=ITR(MAX0(J,L))+MIN0(J,L)
      KL=ITR(MAX0(K,L))+MIN0(K,L)
      KLJB=EOFF(JB)+EADD(KL)
      KBJL=EOFF(KB)+EADD(JL)
      TAU(KJCB)=TAU(KJCB)+(II(KLJB)+II(KLJB)-II(KBJL))*Z2O(LICA)
 3244 CONTINUE
C
      LSYM=IEOR(JASYM,KSYM)+1
      FL=FLOV(LSYM,1)
      LL=FLOV(LSYM,2)
      DO 3245 L=FL,LL
      LICB=UOFF(I,L,ZLBC)+VADD(B,C)
      KL=ITR(MAX0(K,L))+MIN0(K,L)
      KLJA=EOFF(JA)+EADD(KL)
      TAU(KJCB)=TAU(KJCB)-II(KLJA)*Z2O(LICB)
 3245 CONTINUE
CS    ENDIF
C
 2942 CONTINUE
 2952 CONTINUE
C
 2961 CONTINUE
 2971 CONTINUE
      CALL WWRITW(ITAP82,TAU,INTOWP(DIM),I82,I82)
 2981 CONTINUE
 2991 CONTINUE
         IF(NIT.EQ.0)THEN
         WRITE(6,*)'END E INTS CONTRIBUTION TO Y3 MATRIX'
         CALL TIMIT(4,6)
         ENDIF
C
C     ADD F INTS TO Y MATRIX.
C
      CALL RDINTS(65,II,NLVO,
     .            6,BUF,IBUF,INTBUF,IOFF,NO+NV,NTR,
     .            NO,NV,NOV,NTRO,NTRV,NO2,NV2,ITR,INTRO,
     .            INTRV,ITV,N2OV,
     .            ITV,NOV ,ITR,NOV,
     .            FOFF,NV*NV,FADD,NO*NV)
      I82=1
      DO 2990 A=1,NV
      ASYM=ORBSYM(A+NO)
      DO 2980 I=1,NO
      ISYM=ORBSYM(I)
      IASYM=IEOR(ISYM,ASYM)+1
      IA=ITR(A)+I
      DIM=NT3(IASYM)
      CALL WREADW(ITAP82,TAU,INTOWP(DIM),I82,JUNK)
      DO 2970 J=1,NO
      JA=ITR(A)+J
      JSYM=ORBSYM(J)
      IJSYM=IEOR(ISYM,JSYM)
      JASYM=IEOR(JSYM,ASYM)
      DO 2960 B=1,NV
      IB=ITR(B)+I
      JB=ITR(B)+J
      BSYM=ORBSYM(B+NO)
      JBSYM=IEOR(JSYM,BSYM)
      ABSYM=IEOR(ASYM,BSYM)
C
      DO 2955 C=1,B
      JC=ITR(C)+J
      IC=ITR(C)+I
      CSYM=ORBSYM(C+NO)
      ABCSYM=IEOR(ABSYM,CSYM)
      KSYM=IEOR(ABCSYM,IJSYM)
      KCSYM=IEOR(KSYM,CSYM)
      ICSYM=IEOR(ISYM,CSYM)
      KBSYM=IEOR(KSYM,BSYM)
      FK=FLOV(KSYM+1,1)
      LK=FLOV(KSYM+1,2)
      DO 2945 K=FK,LK
      KC=ITR(C)+K
      KA=ITR(A)+K
      KB=ITR(B)+K
      JKBC=TOFF(J,K,1,IASYM)+TADD(B,C,IASYM)
C
      DSYM=IEOR(KCSYM,ASYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3032 D=FD,LD
      DB=IOFF(MAX0(D,B))+MIN0(D,B)
      ZLDB=ZLX(D,B)
      IJDB=UOFF(I,J,ZLDB)+VADD(D,B)
      DA=ITV(MAX0(D,A))+MIN0(D,A)
      DC=ITV(MAX0(D,C))+MIN0(D,C)
      DAKC=FOFF(DA)+FADD(KC)
      DCKA=FOFF(DC)+FADD(KA)
      TAU(JKBC)=TAU(JKBC)-(II(DAKC)+II(DAKC)-II(DCKA))*Z2O(IJDB)
 3032 CONTINUE
C
      DSYM=IEOR(KBSYM,ASYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3033 D=FD,LD
      DC=IOFF(MAX0(D,C))+MIN0(D,C)
      ZLDC=ZLX(D,C)
      IJDC=UOFF(I,J,ZLDC)+VADD(D,C)
      AD=ITV(MAX0(D,A))+MIN0(D,A)
      ADKB=FOFF(AD)+FADD(KB)
      TAU(JKBC)=TAU(JKBC)+II(ADKB)*Z2O(IJDC)
 3033 CONTINUE
C
CS    IF(SORT.NE.'YES ')THEN
      DSYM=IEOR(IASYM-1,BSYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3132 D=FD,LD
      DC=IOFF(MAX0(D,C))+MIN0(D,C)
      ZLDC=ZLX(D,C)
      JKDC=UOFF(J,K,ZLDC)+VADD(D,C)
      DA=ITV(MAX0(D,A))+MIN0(D,A)
      DB=ITV(MAX0(D,B))+MIN0(D,B)
      DBIA=FOFF(DB)+FADD(IA)
      DAIB=FOFF(DA)+FADD(IB)
      TAU(JKBC)=TAU(JKBC)-(II(DBIA)+II(DBIA)-II(DAIB))*Z2O(JKDC)
 3132 CONTINUE
C
      DSYM=IEOR(ICSYM,BSYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3133 D=FD,LD
      DA=IOFF(MAX0(D,A))+MIN0(D,A)
      ZLDA=ZLX(D,A)
      JKDA=UOFF(J,K,ZLDA)+VADD(D,A)
      BD=ITV(MAX0(D,B))+MIN0(D,B)
      BDIC=FOFF(BD)+FADD(IC)
      TAU(JKBC)=TAU(JKBC)+II(BDIC)*Z2O(JKDA)
 3133 CONTINUE
C
      DSYM=IEOR(JBSYM,CSYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3232 D=FD,LD
      DA=IOFF(MAX0(D,A))+MIN0(D,A)
      ZLDA=ZLX(D,A)
      KIDA=UOFF(K,I,ZLDA)+VADD(D,A)
      DB=ITV(MAX0(D,B))+MIN0(D,B)
      DC=ITV(MAX0(D,C))+MIN0(D,C)
      DCJB=FOFF(DC)+FADD(JB)
      DBJC=FOFF(DB)+FADD(JC)
      TAU(JKBC)=TAU(JKBC)-(II(DCJB)+II(DCJB)-II(DBJC))*Z2O(KIDA)
 3232 CONTINUE
C
      DSYM=IEOR(JASYM,CSYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3233 D=FD,LD
      DB=IOFF(MAX0(D,B))+MIN0(D,B)
      ZLDB=ZLX(D,B)
      KIDB=UOFF(K,I,ZLDB)+VADD(D,B)
      CD=ITV(MAX0(D,C))+MIN0(D,C)
      JACD=FOFF(CD)+FADD(JA)
      TAU(JKBC)=TAU(JKBC)+II(JACD)*Z2O(KIDB)
 3233 CONTINUE
CS    ENDIF
 2945 CONTINUE
 2955 CONTINUE
C
      DO 2956 C=B,NV
      JC=ITR(C)+J
      IC=ITR(C)+I
      CSYM=ORBSYM(C+NO)
      ABCSYM=IEOR(ABSYM,CSYM)
      KSYM=IEOR(ABCSYM,IJSYM)
      KCSYM=IEOR(KSYM,CSYM)
      ICSYM=IEOR(ISYM,CSYM)
      KBSYM=IEOR(KSYM,BSYM)
      FK=FLOV(KSYM+1,1)
      LK=FLOV(KSYM+1,2)
      DO 2946 K=FK,LK
      KC=ITR(C)+K
      KA=ITR(A)+K
      KB=ITR(B)+K
      KJCB=TOFF(K,J,1,IASYM)+TADD(C,B,IASYM)
C
      DSYM=IEOR(KCSYM,ASYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3034 D=FD,LD
      DB=IOFF(MAX0(D,B))+MIN0(D,B)
      ZLDB=ZLX(D,B)
      IJDB=UOFF(I,J,ZLDB)+VADD(D,B)
      DA=ITV(MAX0(D,A))+MIN0(D,A)
      DC=ITV(MAX0(D,C))+MIN0(D,C)
      DAKC=FOFF(DA)+FADD(KC)
      DCKA=FOFF(DC)+FADD(KA)
      TAU(KJCB)=TAU(KJCB)-(II(DAKC)+II(DAKC)-II(DCKA))*Z2O(IJDB)
 3034 CONTINUE
C
      DSYM=IEOR(KBSYM,ASYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3035 D=FD,LD
      DC=IOFF(MAX0(D,C))+MIN0(D,C)
      ZLDC=ZLX(D,C)
      IJDC=UOFF(I,J,ZLDC)+VADD(D,C)
      AD=ITV(MAX0(D,A))+MIN0(D,A)
      ADKB=FOFF(AD)+FADD(KB)
      TAU(KJCB)=TAU(KJCB)+II(ADKB)*Z2O(IJDC)
 3035 CONTINUE
C
CS    IF(SORT.NE.'YES ')THEN
      DSYM=IEOR(IASYM-1,BSYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3134 D=FD,LD
      DC=IOFF(MAX0(D,C))+MIN0(D,C)
      ZLDC=ZLX(D,C)
      JKDC=UOFF(J,K,ZLDC)+VADD(D,C)
      DA=ITV(MAX0(D,A))+MIN0(D,A)
      DB=ITV(MAX0(D,B))+MIN0(D,B)
      DBIA=FOFF(DB)+FADD(IA)
      DAIB=FOFF(DA)+FADD(IB)
      TAU(KJCB)=TAU(KJCB)-(II(DBIA)+II(DBIA)-II(DAIB))*Z2O(JKDC)
 3134 CONTINUE
C
      DSYM=IEOR(ICSYM,BSYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3135 D=FD,LD
      DA=IOFF(MAX0(D,A))+MIN0(D,A)
      ZLDA=ZLX(D,A)
      JKDA=UOFF(J,K,ZLDA)+VADD(D,A)
      BD=ITV(MAX0(D,B))+MIN0(D,B)
      BDIC=FOFF(BD)+FADD(IC)
      TAU(KJCB)=TAU(KJCB)+II(BDIC)*Z2O(JKDA)
 3135 CONTINUE
C
      DSYM=IEOR(JBSYM,CSYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3234 D=FD,LD
      DA=IOFF(MAX0(D,A))+MIN0(D,A)
      ZLDA=ZLX(D,A)
      KIDA=UOFF(K,I,ZLDA)+VADD(D,A)
      DB=ITV(MAX0(D,B))+MIN0(D,B)
      DC=ITV(MAX0(D,C))+MIN0(D,C)
      DCJB=FOFF(DC)+FADD(JB)
      DBJC=FOFF(DB)+FADD(JC)
      TAU(KJCB)=TAU(KJCB)-(II(DCJB)+II(DCJB)-II(DBJC))*Z2O(KIDA)
 3234 CONTINUE
C
      DSYM=IEOR(JASYM,CSYM)+1
      FD=FLOV(DSYM,3)-NO
      LD=FLOV(DSYM,4)-NO
      DO 3235 D=FD,LD
      DB=IOFF(MAX0(D,B))+MIN0(D,B)
      ZLDB=ZLX(D,B)
      KIDB=UOFF(K,I,ZLDB)+VADD(D,B)
      CD=ITV(MAX0(D,C))+MIN0(D,C)
      JACD=FOFF(CD)+FADD(JA)
      TAU(KJCB)=TAU(KJCB)+II(JACD)*Z2O(KIDB)
 3235 CONTINUE
CS    ENDIF
 2946 CONTINUE
 2956 CONTINUE
C
 2960 CONTINUE
 2970 CONTINUE
      CALL WWRITW(ITAP82,TAU,INTOWP(DIM),I82,I82)
 2980 CONTINUE
 2990 CONTINUE
         IF(NIT.EQ.0)THEN
         WRITE(6,*)'END F INTS CONTRIBUTION TO Y3 MATRIX'
         CALL TIMIT(4,6)
         ENDIF
C
C     DIVIDE BY MO ENERGIES
C
      I82=1
      DO 4490 A=1,NV
      ASYM=ORBSYM(A+NO)
      DO 4485 I=1,NO
      ISYM=ORBSYM(I)
      III=IOFF(I)+I
      IASYM=IEOR(ISYM,ASYM)+1
      DIM=NT3(IASYM)
      CALL WREADW(ITAP82,TAU,INTOWP(DIM),I82,JUNK)
      AA=IOFF(A+NO)+A+NO
      DO 4480 J=1,NO
      JJ=IOFF(J)+J
      JSYM=ORBSYM(J)
      IAJSYM=IEOR(IASYM-1,JSYM)
      DO 4475 B=1,NV
      BSYM=ORBSYM(B+NO)
      BB=IOFF(B+NO)+B+NO
      DO 4470 K=1,NO
      KK=IOFF(K)+K
      KSYM=ORBSYM(K)
      KBSYM=IEOR(KSYM,BSYM)
      CSYM=IEOR(IAJSYM,KBSYM)+1
      FC=FLOV(CSYM,3)-NO
      LC=FLOV(CSYM,4)-NO
      LC2=LC
      IF(LC.GT.B)LC2=B
      DO 4465 C=FC,LC2
      CC=IOFF(C+NO)+C+NO
      VAL=FOCK(III)+FOCK(JJ)+FOCK(KK)-FOCK(AA)-FOCK(BB)-FOCK(CC)
      JKBC=TOFF(J,K,1,IASYM)+TADD(B,C,IASYM)
      TAU(JKBC)=TAU(JKBC)/VAL
 4465 CONTINUE
 4470 CONTINUE
 4475 CONTINUE
 4480 CONTINUE
      CALL WWRITW(ITAP82,TAU,INTOWP(DIM),I82,I82)
 4485 CONTINUE
 4490 CONTINUE
         IF(NIT.EQ.0)THEN
         WRITE(6,*)'ENDING MO ENERGY DIVISION'
         CALL TIMIT(4,6)
         ENDIF
C
C     FORM Y TILDE
C
      IF(SORT.EQ.'YES ')
     .CALL SORTT(TAU,T2,NTAU,ORBSYM,NO,NV,FLOV,NIRRED,NT3,TOFF,TADD,
     .           ITAP82,ITAP97,ZLX)
C
C
C     ADD CCSDT TERMS TO Z2 EQUATION. F INTS.
C
      CALL RDINTS(65,II,NLVO,
     .            6,BUF,IBUF,INTBUF,IOFF,NO+NV,NTR,
     .            NO,NV,NOV,NTRO,NTRV,NO2,NV2,ITR,INTRO,
     .            INTRV,ITV,N2OV,
     .            ITV,NOV ,ITR,NOV,
     .            FOFF,NV*NV,FADD,NO*NV)
      I82=1
      DO 6290 A=1,NV
      ASYM=ORBSYM(A+NO)
      DO 6285 I=1,NO
      ISYM=ORBSYM(I)
      IASYM=IEOR(ISYM,ASYM)+1
      DIM=NT3(IASYM)
      CALL WREADW (ITAP82,TAU,INTOWP(DIM),I82,I82)
      DO 6280 B=1,NV
      BSYM=ORBSYM(B+NO)
      BESYM=IEOR(IASYM-1,BSYM)
      FBE=FLOV(BESYM+1,3)-NO
      LBE=FLOV(BESYM+1,4)-NO
      DO 6275 BE=FBE,LBE
      IA=ITR(A)+I
      BEB=ITV(MAX0(BE,B))+MIN0(BE,B)
      IABEB=FOFF(BEB)+FADD(IA)
      DO 6270 U=1,NO
      USYM=ORBSYM(U)
      DO 6265 V=1,NO
      VSYM=ORBSYM(V)
      UVSYM=IEOR(USYM,VSYM)
      GASYM=IEOR(UVSYM,BESYM)+1
      FGA=FLOV(GASYM,3)-NO
      LGA=FLOV(GASYM,4)-NO
C
      LGA2=LGA
      IF(LGA.GT.BE)LGA2=BE
      DO 6230 GA=FGA,LGA2
C     BEGA=IOFF(BE)+GA
C     UV    =ITR(U)+V
      UVBEGA=UOFF(U,V,1)+VADD(BE,GA)
      ZLBGA=ZLX(B,GA)
      UVBGA=TOFF(U,V,ZLBGA,IASYM)+TADD(B,GA,IASYM)
      Z2(UVBEGA)=Z2(UVBEGA)+TAU(UVBGA) *II(IABEB)
C     Z2(UV,BEGA)=Z2(UV,BEGA)+Y(I,U,V,A,B,GA) *II(IABEB)
 6230 CONTINUE
C
      FGA2=FGA
      IF(FGA.LT.BE)FGA2=BE
      DO 6231 GA=FGA2,LGA
C     GABE=IOFF(GA)+BE
      VUGABE=UOFF(V,U,1)+VADD(GA,BE)
      ZLBGA=ZLX(B,GA)
      UVBGA=TOFF(U,V,ZLBGA,IASYM)+TADD(B,GA,IASYM)
      Z2(VUGABE)=Z2(VUGABE)+TAU(UVBGA)*II(IABEB)
C     Z2(VU,GABE)=Z2(VU,GABE)+Y(I,U,V,A,B,GA) *II(IABEB)
 6231 CONTINUE
C
 6265 CONTINUE
 6270 CONTINUE
 6275 CONTINUE
 6280 CONTINUE
 6285 CONTINUE
 6290 CONTINUE
         IF(NIT.EQ.0)THEN
         WRITE(6,*)'END F INTS CONTRIBUTION TO Z2'
         CALL TIMIT(4,6)
         ENDIF
C
C
C     ADD CCSDT TERMS TO Z2 EQUATION. E INTS.
C
      CALL RDINTS(64,II,NLOV,6,BUF,IBUF,INTBUF,
     .            IOFF,NO+NV,NTR,NO,NV,NOV,NTRO,NTRV,NO2,NV2,ITR,INTRO,
     .            INTRV,ITV,N2OV,
     .            ITR,NOV,ITR,NOV,EOFF,NM,EADD,NONO)
      I82=1
      DO 3290 A=1,NV
      ASYM=ORBSYM(A+NO)
      DO 3285 I=1,NO
      ISYM=ORBSYM(I)
      IASYM=IEOR(ISYM,ASYM)+1
      DIM=NT3(IASYM)
      CALL WREADW (ITAP82,TAU,INTOWP(DIM),I82,I82)
      DO 3280 V=1,NO
      VSYM=ORBSYM(V)
      JSYM=IEOR(IASYM-1,VSYM)+1
      FJ=FLOV(JSYM,1)
      LJ=FLOV(JSYM,2)
      DO 3275 J=FJ,LJ
      VJ=ITR(MAX0(V,J))+MIN0(V,J)
      IA=ITR(A)+I
      IAVJ=EOFF(IA)+EADD(VJ)
      DO 3270 U=1,NO
      USYM=ORBSYM(U)
      UVSYM=IEOR(USYM,VSYM)
      DO 3265 BE=1,NV
      BESYM=ORBSYM(BE+NO)
      GASYM=IEOR(UVSYM,BESYM)+1
      FGA=FLOV(GASYM,3)-NO
      LGA=FLOV(GASYM,4)-NO
C
      LGA2=LGA
      IF(LGA.GT.BE)LGA2=BE
      DO 3260 GA=FGA,LGA2
C     UV    =ITR(U)+V
C     BEGA=IOFF(BE)+GA
      UVBEGA=UOFF(U,V,1)+VADD(BE,GA)
      JUGABE=TOFF(J,U,2,IASYM)+TADD(GA,BE,IASYM)
      Z2(UVBEGA)=Z2(UVBEGA)-TAU(JUGABE)*II(IAVJ)
C     Z2(UV,BEGA)=Z2(UV,BEGA)-Y(I,J,U,A,GA,BE) * II(IAVJ)
 3260 CONTINUE
C
      FGA2=FGA
      IF(FGA.LT.BE)FGA2=BE
      DO 3261 GA=FGA2,LGA
C     VU    =ITR(V)+U
C     GABE=IOFF(GA)+BE
      VUGABE=UOFF(V,U,1)+VADD(GA,BE)
      JUGABE=TOFF(J,U,1,IASYM)+TADD(GA,BE,IASYM)
      Z2(VUGABE)=Z2(VUGABE)-TAU(JUGABE)*II(IAVJ)
C     Z2(VU,GABE)=Z2(VU,GABE)-Y(I,J,U,A,GA,BE) * II(IAVJ)
 3261 CONTINUE
C
 3265 CONTINUE
 3270 CONTINUE
 3275 CONTINUE
 3280 CONTINUE
 3285 CONTINUE
 3290 CONTINUE
         IF(NIT.EQ.0)THEN
         WRITE(6,*)'END E INTS CONTRIBUTION TO Z2'
         CALL TIMIT(4,6)
         ENDIF
C
C
      RETURN
      END
C
      SUBROUTINE SORTT(TAU,T2,NTAU,ORBSYM,NO,NV,FLOV,NIRRED,NT3,TOFF,
     .           TADD,ITAP81,ITAP97,ZLX)
      IMPLICIT INTEGER (A-Z)
      REAL * 8 TAU(NTAU),T2(NTAU)
      DIMENSION ORBSYM(NO+NV),FLOV(NIRRED,4),NT3(NIRRED),
     .          TOFF(NO,NO,2,NIRRED),TADD(NV,NV,NIRRED),ZLX(NV,NV)
C
C     COPY TAPE81 ONTO FILE97
C
      I97=1
      I81=1
      DO  90 A=1,NV
      ASYM=ORBSYM(A+NO)
      DO  80 I=1,NO
      ISYM=ORBSYM(I)
      IASYM=IEOR(ASYM,ISYM)+1
      DIM=NT3(IASYM)
      CALL WREADW(ITAP81,TAU,INTOWP(DIM),I81,I81)
      CALL WWRITW(ITAP97,TAU,INTOWP(DIM),I97,I97)
   80 CONTINUE
   90 CONTINUE
C
C     SORT IJKABC TO IJKABC+JKIBCA+KIJCAB
C
      I81=1
      DO 290 A=1,NV
      ASYM=ORBSYM(A+NO)
      DO 280 I=1,NO
      ISYM=ORBSYM(I)
      IASYM=IEOR(ASYM,ISYM)+1
      DIM=NT3(IASYM)
      CALL WREADW(ITAP81,TAU,INTOWP(DIM),I81,I81)
      I97=1
      DO 170 B=1,NV
      BSYM=ORBSYM(B+NO)
      DO 160 J=1,NO
      JSYM=ORBSYM(J)
      JBSYM=IEOR(BSYM,JSYM)+1
      DAM=NT3(JBSYM)
      CALL WREADW(ITAP97,T2 ,INTOWP(DAM),I97,JUNK)
      IAJBS=IEOR(IASYM-1,JBSYM-1)
C
      DO 150 C=1,A
      CSYM=ORBSYM(C+NO)
      ZLCB=ZLX(C,B)
      KSYM=IEOR(IAJBS,CSYM)
      FK=FLOV(KSYM+1,1)
      LK=FLOV(KSYM+1,2)
      DO 140 K=FK,LK
      IKAC=TOFF(I,K,1   ,JBSYM)+TADD(A,C,JBSYM)
      KJCB=TOFF(K,J,ZLCB,IASYM)+TADD(C,B,IASYM)
      T2(IKAC)=T2(IKAC)+TAU(KJCB)
  140 CONTINUE
  150 CONTINUE
C
      DO 151 C=A,NV
      CSYM=ORBSYM(C+NO)
      ZLBC=ZLX(B,C)
      KSYM=IEOR(IAJBS,CSYM)
      FK=FLOV(KSYM+1,1)
      LK=FLOV(KSYM+1,2)
      DO 141 K=FK,LK
      KICA=TOFF(K,I,1   ,JBSYM)+TADD(C,A,JBSYM)
      JKBC=TOFF(J,K,ZLBC,IASYM)+TADD(B,C,IASYM)
      T2(KICA)=T2(KICA)+TAU(JKBC)
  141 CONTINUE
  151 CONTINUE
C
      CALL WWRITW(ITAP97,T2,INTOWP(DAM),I97,I97)
  160 CONTINUE
  170 CONTINUE
C
  280 CONTINUE
  290 CONTINUE
C
C     COPY TAPE97 ONTO FILE81
C
      I97=1
      I81=1
      DO 390 A=1,NV
      ASYM=ORBSYM(A+NO)
      DO 380 I=1,NO
      ISYM=ORBSYM(I)
      IASYM=IEOR(ASYM,ISYM)+1
      DIM=NT3(IASYM)
      CALL WREADW(ITAP97,TAU,INTOWP(DIM),I97,I97)
      CALL WWRITW(ITAP81,TAU,INTOWP(DIM),I81,I81)
  380 CONTINUE
  390 CONTINUE
C
      RETURN
      END
C
      SUBROUTINE OFFSET(INO,INV,INTRO,INTRV,ZLX,UOFF,NBF,NO,NV,NOV,
     .                  NTRO,NTRV,N2OV,JOUT,ZLXO,UOFFV,IOFF,NTR)
      IMPLICIT INTEGER(A-Z)
      DIMENSION INO(NOV),INV(NOV),INTRO(N2OV),INTRV(NO*NV),ZLX(NV,NV),
     .          UOFF(NO,NO,2),ZLXO(NO,NO),UOFFV(NV,NV,2),IOFF(NTR)
C
      IOFF(1)=0
      DO 5 I=1,NTR-1
        IOFF(I+1)=IOFF(I)+I
    5 CONTINUE
      DO 10 I=1,NOV
         INO(I)=(I-1)*NO
   10 CONTINUE
      DO 11 I=1,NOV
         INV(I)=(I-1)*NV
   11 CONTINUE
      DO 20 I=1,N2OV
         INTRO(I)=(I-1)*NTRO
   20 CONTINUE
      DO 30 I=1,NO*NV
         INTRV(I)=(I-1)*NTRV
   30 CONTINUE
      DO 40 A=1,NV
         DO 50 B=1,A
            ZLX(A,B)=1
   50    CONTINUE
         DO 60 B=A+1,NV
            ZLX(A,B)=2
   60    CONTINUE
   40 CONTINUE
      DO 70 I=1,NO
         DO 80 J=1,NO
            UOFF(I,J,1)=(I-1)*NO+J
            UOFF(I,J,2)=(J-1)*NO+I
   80    CONTINUE
   70 CONTINUE
      DO 41 I=1,NO
         DO 51 J=1,I
            ZLXO(I,J)=1
   51    CONTINUE
         DO 61 J=I+1,NO
            ZLXO(I,J)=2
   61    CONTINUE
   41 CONTINUE
      DO 71 A=1,NV
         DO 81 B=1,NV
            UOFFV(A,B,1)=(A-1)*NV+B
            UOFFV(A,B,2)=(B-1)*NV+A
   81    CONTINUE
   71 CONTINUE
C
      RETURN
      END
C
C                         ********************
C-------------------------****** RDINTS ******-------------------------
C                         ********************
C
      SUBROUTINE RDINTS(IDISK,MOINTS,LENINT,JOUT,BUF,IBUF,LENBUF,IOFF,
     .                  NBF,NTR,NO,NV,NOV,NTRO,NTRV,NO2,NV2,INO,INTRO,
     .                  INTRV,INV,N2OV,
     .                  IPP,NPP,IQQ,NQQ,QOFF,NOFF,QADD,NADD)
      IMPLICIT REAL*8 (A-H,O-Z)
      REAL*8 MOINTS(LENINT),BUF(LENBUF)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER IPP(NPP),IQQ(NQQ),QOFF(NOFF),QADD(NADD)
      DIMENSION IBUF(2*LENBUF)
      DIMENSION IOFF(NTR)
C
      CALL SREW(IDISK)
      CALL ZERO(MOINTS,LENINT)
      CALL ZERO(BUF,LENBUF)
C
   29 FORMAT (4I3,F20.12)
C
      ITEMP=255
C
      INTLEN=(INTOWP(LENBUF)-2)/INTOWP(1)
      MAXVAL=INTOWP(INTLEN)/(1+INTOWP(1))
      IBOFF=(MAXVAL+3)/INTOWP(1)
C
C***  A INTS  **** (OO|OO) *****
      IF (IDISK.NE.60) GOTO 110
  111 CALL SREAD(IDISK,BUF,INTOWP(LENBUF))
      CALL SETMBF(IFLG,IBUF(1))
      CALL SETMBF(MBUF,IBUF(2))
      DO 12 II=1,MBUF
         CALL SETMBF(IJKL,IBUF(II+2))
         I=ISHFT(IJKL,-24)
         J=IAND(ITEMP,ISHFT(IJKL,-16))
         IJ=IPP(I)+J
         K=IAND(ITEMP,ISHFT(IJKL,-8))
         L=IAND(ITEMP,IJKL)
         KL=IPP(K)+L
         IJKL=QOFF(IJ)+QADD(KL)
         MOINTS(IJKL)=BUF(II+IBOFF)
C     WRITE(*,*)I,J,K,L,IJKL,MOINTS(IJKL)
   12 CONTINUE
      IF (IFLG.EQ.0) GOTO 111
  110 CONTINUE
C
C***  B INTS  **** (VV|VV) *****
      IF (IDISK.NE.61) GOTO 120
  112 CALL SREAD(IDISK,BUF,INTOWP(LENBUF))
      CALL SETMBF(IFLG,IBUF(1))
      CALL SETMBF(MBUF,IBUF(2))
      DO 22 II=1,MBUF
         CALL SETMBF(IJKL,IBUF(II+2))
         I=ISHFT(IJKL,-24)-NO
         J=IAND(ITEMP,ISHFT(IJKL,-16))-NO
         IJ=IPP(I)+J
         K=IAND(ITEMP,ISHFT(IJKL,-8))-NO
         L=IAND(ITEMP,IJKL)-NO
         KL=IQQ(K)+L
         IJKL=QOFF(IJ)+QADD(KL)
         MOINTS(IJKL)=BUF(II+IBOFF)
C     WRITE(*,*)I,J,K,L,IJ,KL,IJKL,MOINTS(IJKL)
   22 CONTINUE
      IF (IFLG.EQ.0) GOTO 112
C
  120 CONTINUE
C***  C INTS  **** (VV|OO) *****
      IF (IDISK.NE.62) GOTO 130
  113 CALL SREAD(IDISK,BUF,INTOWP(LENBUF))
      CALL SETMBF(IFLG,IBUF(1))
      CALL SETMBF(MBUF,IBUF(2))
      DO 32 II=1,MBUF
         CALL SETMBF(IJKL,IBUF(II+2))
         I=ISHFT(IJKL,-24)-NO
         J=IAND(ITEMP,ISHFT(IJKL,-16))-NO
         IJ=IPP(I)+J
         K=IAND(ITEMP,ISHFT(IJKL,-8))
         L=IAND(ITEMP,IJKL)
         KL=IQQ(K)+L
         IJKL=QOFF(IJ)+QADD(KL)
         MOINTS(IJKL)=BUF(II+IBOFF)
C     WRITE(*,*)I,J,K,L,IJKL,MOINTS(IJKL)
   32 CONTINUE
      IF (IFLG.EQ.0) GOTO 113
  130 CONTINUE
C
C***  D INTS  **** (VO|VO) *****
      IF (IDISK.NE.63) GOTO 140
  114 CALL SREAD(IDISK,BUF,INTOWP(LENBUF))
      CALL SETMBF(IFLG,IBUF(1))
      CALL SETMBF(MBUF,IBUF(2))
      DO 42 II=1,MBUF
         CALL SETMBF(IJKL,IBUF(II+2))
         I=ISHFT(IJKL,-24)-NO
         J=IAND(ITEMP,ISHFT(IJKL,-16))
         IJ=IPP(I)+J
C        IJ=INO(I)+J
         K=IAND(ITEMP,ISHFT(IJKL,-8))-NO
         L=IAND(ITEMP,IJKL)
         KL=IQQ(K)+L
C        KL=INO(K)+L
         IJKL=QOFF(IJ)+QADD(KL)
C        IJKL=IOFF(IJ)+KL
         MOINTS(IJKL)=BUF(II+IBOFF)
C     WRITE(*,*)I,J,K,L,IJKL,MOINTS(IJKL)
   42 CONTINUE
      IF (IFLG.EQ.0) GOTO 114
  140 CONTINUE
C
C***  E INTS  **** (VO|OO) *****
      IF (IDISK.NE.64) GOTO 150
  115 CALL SREAD(IDISK,BUF,INTOWP(LENBUF))
      CALL SETMBF(IFLG,IBUF(1))
      CALL SETMBF(MBUF,IBUF(2))
      DO 52 II=1,MBUF
         CALL SETMBF(IJKL,IBUF(II+2))
         I=ISHFT(IJKL,-24)-NO
         J=IAND(ITEMP,ISHFT(IJKL,-16))
         IJ=IPP(I)+J
         K=IAND(ITEMP,ISHFT(IJKL,-8))
         L=IAND(ITEMP,IJKL)
         KL=IQQ(K)+L
         IJKL=QOFF(IJ)+QADD(KL)
         MOINTS(IJKL)=BUF(II+IBOFF)
C     WRITE(*,*)I,J,K,L,IJKL,MOINTS(IJKL)
   52 CONTINUE
      IF (IFLG.EQ.0) GOTO 115
  150 CONTINUE
C
      IF (IDISK.NE.65) GOTO 160
      CALL SREW(IDISK+1)
C***  F INTS  **** (VV|VO) *****
  116 CALL SREAD(IDISK,BUF,INTOWP(LENBUF))
      CALL SETMBF(IFLG,IBUF(1))
      CALL SETMBF(MBUF,IBUF(2))
      DO 62 II=1,MBUF
         CALL SETMBF(IJKL,IBUF(II+2))
         I=ISHFT(IJKL,-24)-NO
         J=IAND(ITEMP,ISHFT(IJKL,-16))-NO
         IJ=IPP(I)+J
         K=IAND(ITEMP,ISHFT(IJKL,-8))-NO
         L=IAND(ITEMP,IJKL)
         KL=IQQ(K)+L
         IJKL=QADD(KL)+QOFF(IJ)
         MOINTS(IJKL)=BUF(II+IBOFF)
C     WRITE(*,*)I,J,K,L,IJKL,MOINTS(IJKL)
   62 CONTINUE
      IF (IFLG.EQ.0) GOTO 116
C***  F INTS  **** (VO|VV) *****
  117 CALL SREAD(IDISK+1,BUF,INTOWP(LENBUF))
      CALL SETMBF(IFLG,IBUF(1))
      CALL SETMBF(MBUF,IBUF(2))
      DO 72 II=1,MBUF
         CALL SETMBF(IJKL,IBUF(II+2))
         I=ISHFT(IJKL,-24)-NO
         J=IAND(ITEMP,ISHFT(IJKL,-16))
         IJ=IQQ(I)+J
         K=IAND(ITEMP,ISHFT(IJKL,-8))-NO
         L=IAND(ITEMP,IJKL)-NO
         KL=IPP(K)+L
         IJKL=QADD(IJ)+QOFF(KL)
         MOINTS(IJKL)=BUF(II+IBOFF)
C     WRITE(*,*)I,J,K,L,IJKL,MOINTS(IJKL)
   72 CONTINUE
      IF (IFLG.EQ.0) GOTO 117
  160 CONTINUE
C     CALL MATOUT(MOINTS,IDIM,IDIM,IDIM,IDIM,JOUT)
      RETURN
      END
C
C                         ********************
C-------------------------****** SETMBF ******-------------------------
C                         ********************
C
      SUBROUTINE SETMBF(MBUF,IBUF)
      IMPLICIT REAL*8 (A-H,O-Z)
      MBUF=IBUF
      RETURN
      END
C
C                         ********************
C-------------------------****** READ30 ******-------------------------
C                         ********************
C
C
C
      SUBROUTINE READ30(ITAP30,MPOINT,MCONST,MCALCS,NCALCS,NT,
     .                  NSYMHF,MXCOEF,EIGVAL,NLAMDA,ITEMP,JOUT,NC,NO,
     .                  WTEMP,PTOCC,ITYP,ORBSYM,FLOV,NIRRED,ITEP,
     .                  ENUC,ESCF,CHAR,NORD)
      IMPLICIT REAL*8 (A-H,O-Z)
      CHARACTER*4 ITYP(NSYMHF),ICSYM,ITEP(NIRRED)
      CHARACTER*4 CHAR
      INTEGER NORD
      REAL*8 EIGVAL(NT),WTEMP(NT)
      INTEGER NLAMDA(NSYMHF),ITEMP(MCALCS),NC(NSYMHF),PTOCC(NT),
     .        ORBSYM(NT),FLOV(NIRRED,4),SYMORB
      JPOINT = 101 + MCONST + MPOINT
      CALL WREADW (ITAP30,ITEMP,MCALCS,JPOINT,JPOINT)
      LOCCAL = ITEMP(NCALCS)
      JPOINT = LOCCAL + 60
      CALL WREADW (ITAP30,LOCVEC,1,JPOINT,JPOINT)
      LOCVEC=LOCVEC+INTOWP(MXCOEF)
      CALL WREADW (ITAP30,EIGVAL,INTOWP(NT),LOCVEC,LOCVEC)
      CALL WREADW (ITAP30,ITYP,NSYMHF,LOCVEC,LOCVEC)
C     LOCVEC = LOCVEC + NSYMHF
C     WRITE(*,*) ' LOCVEC,MXCOEF = ',LOCVEC,MXCOEF
      CALL WREADW (ITAP30,NLAMDA,NSYMHF,LOCVEC,LOCVEC)
      CALL WREADW (ITAP30,NC,NSYMHF,LOCVEC,LOCVEC)
      NO=0
      DO 555 I=1,NSYMHF
         NO=NO+NC(I)
COUT     WRITE (6,*) ' I,NC=',I,NC(I)
  555 CONTINUE
      ICNT=0
      IOF = 0
      DO 558 I=1,NSYMHF
      IF(I.NE.1) IOF = IOF + NLAMDA(I-1)
      NOI=NC(I)
      DO 557 J=1,NOI
      ICNT=ICNT+1
      IPT=IOF+J
C     WRITE(6,*)'IPT=',IPT,ICNT
  557 PTOCC(IPT)=ICNT
  558 CONTINUE
C     WRITE(*,*) '  VIRTUALS'
      IOF = 0
      DO 658 I=1,NSYMHF
      IF(I.NE.1) IOF = IOF + NLAMDA(I-1)
      NVI=NLAMDA(I)-NC(I)
      DO 657 J=1,NVI
      ICNT=ICNT+1
      IPT=IOF+NC(I) + J
C     WRITE(6,*) IOF,NC(I),J
C     WRITE(6,*)'IPT=',IPT,ICNT
  657 PTOCC(IPT)=ICNT
  658 CONTINUE
      DO 559 I=1,NT
      IPT=PTOCC(I)
  559 WTEMP(IPT)=EIGVAL(I)
      DO 569 I=1,NT
      EIGVAL(I)=WTEMP(I)
C     WRITE(6,*)'I=',I,'E(I)=',EIGVAL(I)
  569 CONTINUE
C
      DO 805 ISYM = 1,NIRRED
      FLOV(ISYM,1) = 0
      FLOV(ISYM,2) = -1
      FLOV(ISYM,3) = 0
      FLOV(ISYM,4) = -1
  805 CONTINUE
C
C     GET SYMMETRY LABEL FROM INPUT
C
      CALL LOCATE (5,'# INPUT ###',IERR)
      IF(IERR.NE.0) THEN
      WRITE (6,*)'NO INPUT WAS FOUND!'
      STOP
      ELSE
      READ(5,6004)LABEL
      READ(5,6004)LABEL
 6004 FORMAT(20A4)
 6005 FORMAT(A4,5X,I1)
      READ(5,6005)CHAR,NORD
C     WRITE(6,6024)CHAR,NORD
C6024 FORMAT(//,'SYMMETRY LABEL FROM INPUT',/,A4,5X,I1)
      ENDIF
C
      ICNT=0
      DO 705 ISYM=1,NSYMHF
      ICSYM=ITYP(ISYM)
      ICNTH=ICNT+1
      NOI=NC(ISYM)
      DO 700 I=1,NOI
      ICNT=ICNT+1
      IF(ICSYM.EQ.'A1  ')ORBSYM(ICNT)=0
      IF(ICSYM.EQ.'A2  ')ORBSYM(ICNT)=1
      IF(ICSYM.EQ.'B1  ')ORBSYM(ICNT)=2
      IF(ICSYM.EQ.'B2  ')ORBSYM(ICNT)=3
      IF(ICSYM.EQ.'A   ')ORBSYM(ICNT)=0
      IF(ICSYM.EQ.'B   ')ORBSYM(ICNT)=1
      IF(ICSYM.EQ.'A''  ')ORBSYM(ICNT)=0
      IF(ICSYM.EQ.'A"  ')ORBSYM(ICNT)=1
      IF(ICSYM.EQ.'AG  ')ORBSYM(ICNT)=0
      IF(ICSYM.EQ.'B1G ')ORBSYM(ICNT)=1
      IF(ICSYM.EQ.'B2G ')ORBSYM(ICNT)=2
      IF(ICSYM.EQ.'B3G ')ORBSYM(ICNT)=3
      IF(ICSYM.EQ.'AU  ')ORBSYM(ICNT)=4
      IF(ICSYM.EQ.'B1U ')ORBSYM(ICNT)=5
      IF(ICSYM.EQ.'B2U ')ORBSYM(ICNT)=6
      IF(ICSYM.EQ.'B3U ')ORBSYM(ICNT)=7
      IF(NIRRED.GT.4)GO TO 690
      IF(ICSYM.EQ.'AG  ')ORBSYM(ICNT)=0
      IF(ICSYM.EQ.'BG  ')ORBSYM(ICNT)=1
      IF(ICSYM.EQ.'AU  ')ORBSYM(ICNT)=2
      IF(ICSYM.EQ.'BU  ')ORBSYM(ICNT)=3
  690 CONTINUE
      IF(CHAR.EQ.'DN  '.AND.NORD.EQ.2)THEN
      IF(ICSYM.EQ.'A1  ')ORBSYM(ICNT)=0
      IF(ICSYM.EQ.'B1  ')ORBSYM(ICNT)=1
      IF(ICSYM.EQ.'B2  ')ORBSYM(ICNT)=2
      IF(ICSYM.EQ.'B3  ')ORBSYM(ICNT)=3
      ENDIF
  700 CONTINUE
      IF(ICNTH-1.NE.ICNT) THEN
      SYMORB = ORBSYM(ICNT) + 1
      FLOV(SYMORB,1)=ICNTH
      FLOV(SYMORB,2)=ICNT
      ENDIF
C     WRITE(*,*)'ISYM',ISYM,'F1',FLOV(ISYM,1)
C     WRITE(*,*)'ISYM',ISYM,'F2',FLOV(ISYM,2)
  705 CONTINUE
      DO 715 ISYM=1,NSYMHF
      ICSYM=ITYP(ISYM)
      ICNTH=ICNT+1
      NVI=NLAMDA(ISYM)-NC(ISYM)
      DO 710 I=1,NVI
      ICNT=ICNT+1
      IF(ICSYM.EQ.'A1  ')ORBSYM(ICNT)=0
      IF(ICSYM.EQ.'A2  ')ORBSYM(ICNT)=1
      IF(ICSYM.EQ.'B1  ')ORBSYM(ICNT)=2
      IF(ICSYM.EQ.'B2  ')ORBSYM(ICNT)=3
      IF(ICSYM.EQ.'A   ')ORBSYM(ICNT)=0
      IF(ICSYM.EQ.'B   ')ORBSYM(ICNT)=1
      IF(ICSYM.EQ.'A''  ')ORBSYM(ICNT)=0
      IF(ICSYM.EQ.'A"  ')ORBSYM(ICNT)=1
      IF(ICSYM.EQ.'AG  ')ORBSYM(ICNT)=0
      IF(ICSYM.EQ.'B1G ')ORBSYM(ICNT)=1
      IF(ICSYM.EQ.'B2G ')ORBSYM(ICNT)=2
      IF(ICSYM.EQ.'B3G ')ORBSYM(ICNT)=3
      IF(ICSYM.EQ.'AU  ')ORBSYM(ICNT)=4
      IF(ICSYM.EQ.'B1U ')ORBSYM(ICNT)=5
      IF(ICSYM.EQ.'B2U ')ORBSYM(ICNT)=6
      IF(ICSYM.EQ.'B3U ')ORBSYM(ICNT)=7
      IF(NIRRED.GT.4)GO TO 691
      IF(ICSYM.EQ.'AG  ')ORBSYM(ICNT)=0
      IF(ICSYM.EQ.'BG  ')ORBSYM(ICNT)=1
      IF(ICSYM.EQ.'AU  ')ORBSYM(ICNT)=2
      IF(ICSYM.EQ.'BU  ')ORBSYM(ICNT)=3
  691 CONTINUE
      IF(CHAR.EQ.'DN  '.AND.NORD.EQ.2)THEN
      IF(ICSYM.EQ.'A1  ')ORBSYM(ICNT)=0
      IF(ICSYM.EQ.'B1  ')ORBSYM(ICNT)=1
      IF(ICSYM.EQ.'B2  ')ORBSYM(ICNT)=2
      IF(ICSYM.EQ.'B3  ')ORBSYM(ICNT)=3
      ENDIF
  710 CONTINUE
      IF(ICNTH-1.NE.ICNT) THEN
      SYMORB = ORBSYM(ICNT) + 1
      FLOV(SYMORB,3)=ICNTH
      FLOV(SYMORB,4)=ICNT
      ENDIF
C     WRITE(*,*)'ISYM',ISYM,'F3',FLOV(ISYM,3)
C     WRITE(*,*)'ISYM',ISYM,'F4',FLOV(ISYM,4)
  715 CONTINUE
C     WRITE(*,*)'ORBSYM',ORBSYM
      DO 800 ISYM=1,NSYMHF
      ICSYM=ITYP(ISYM)
      IF(ICSYM.EQ.'A1  ')ITEP(1)=ICSYM
      IF(ICSYM.EQ.'A2  ')ITEP(2)=ICSYM
      IF(ICSYM.EQ.'B1  ')ITEP(3)=ICSYM
      IF(ICSYM.EQ.'B2  ')ITEP(4)=ICSYM
      IF(ICSYM.EQ.'A   ')ITEP(1)=ICSYM
      IF(ICSYM.EQ.'B   ')ITEP(2)=ICSYM
      IF(ICSYM.EQ.'A''  ')ITEP(1)=ICSYM
      IF(ICSYM.EQ.'A"  ')ITEP(2)=ICSYM
      IF(ICSYM.EQ.'AG  ')ITEP(1)=ICSYM
      IF(ICSYM.EQ.'B1G ')ITEP(2)=ICSYM
      IF(ICSYM.EQ.'B2G ')ITEP(3)=ICSYM
      IF(ICSYM.EQ.'B3G ')ITEP(4)=ICSYM
      IF(ICSYM.EQ.'AU  ')ITEP(5)=ICSYM
      IF(ICSYM.EQ.'B1U ')ITEP(6)=ICSYM
      IF(ICSYM.EQ.'B2U ')ITEP(7)=ICSYM
      IF(ICSYM.EQ.'B3U ')ITEP(8)=ICSYM
      IF(NIRRED.GT.4)GO TO 692
      IF(ICSYM.EQ.'AG  ')ITEP(1)=ICSYM
      IF(ICSYM.EQ.'BG  ')ITEP(2)=ICSYM
      IF(ICSYM.EQ.'AU  ')ITEP(3)=ICSYM
      IF(ICSYM.EQ.'BU  ')ITEP(4)=ICSYM
  692 CONTINUE
      IF(CHAR.EQ.'DN  '.AND.NORD.EQ.2)THEN
      IF(ICSYM.EQ.'A1  ')ITEP(1)=ICSYM
      IF(ICSYM.EQ.'B1  ')ITEP(2)=ICSYM
      IF(ICSYM.EQ.'B2  ')ITEP(3)=ICSYM
      IF(ICSYM.EQ.'B3  ')ITEP(4)=ICSYM
      ENDIF
  800 CONTINUE
C     CALL PRN11(ENUC,ESCF)
C
      DO 787 I=1,NT
         WRITE (8,797) I,EIGVAL(I)
  787 CONTINUE
  797 FORMAT(I5,F20.12)
C
      END
C
C                         ********************
C-------------------------****** AINTS ******-------------------------
C                         ********************
C
      SUBROUTINE AINTS(AMAT,MOINTS,NTRO,NO2,LENINT,NO,NTR,IOFF,JOUT,
     .                 INO,NOV,AOFF,NOFF,AADD,NADD,
     .                 FLOV,NIRRED,ORBSYM)
      IMPLICIT INTEGER(A-Z)
      REAL*8 AMAT(NO2),MOINTS(LENINT),VAL
      INTEGER IOFF(NTR),FLOV(NIRRED,4),ORBSYM(NO)
      INTEGER AOFF(NOFF),AADD(NADD),INO(NOV)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
      COMMON/NEWPAR/NAB(8),NAI(8),NIJ(8),MAXOO,MAXVV,MAXOV
    1 FORMAT (' IMAT(=',I2,',',I2,',',I2,',',I2,')=',F20.12)
C
      CALL RFILE(TPAMAT)
      PON=1
      DO 100 TSYM=1,NIRRED
      LIJ=0
C
      DO 90 I=1,NO
C     IF(FZO(I).EQ.1) GO TO 90
      ISYM=ORBSYM(I)
      JSYM=IEOR(ISYM,TSYM-1)+1
      FJ=FLOV(JSYM,1)
      LJ=FLOV(JSYM,2)
      DO 89 J=FJ,LJ
      LIJ=LIJ+1
   89 CONTINUE
   90 CONTINUE
      NIJ(TSYM)=LIJ
C     WRITE(*,*)'TSYM=',TSYM,' NIJ FOR AMAT',LIJ
C
      DO 10 U=1,NO
C        IF(FZO(U).EQ.1)GO TO 10
         USYM=ORBSYM(U)
         DO 11 V=1,U
C           IF(FZO(V).EQ.1)GO TO 11
            VSYM=ORBSYM(V)
            UVSYM=IEOR(USYM,VSYM)
            IF(UVSYM.NE.TSYM-1)GO TO 11
          ICNT=0
            DO 12 I=1,NO
C              IF(FZO(I).EQ.1)GO TO 12
               ISYM=ORBSYM(I)
               JSYM=IEOR(ISYM,UVSYM)+1
               FJ=FLOV(JSYM,1)
               LJ=FLOV(JSYM,2)
               UI=INO(MAX0(U,I))+MIN0(U,I)
               DO 13 J=FJ,LJ
                  VJ=INO(MAX0(V,J))+MIN0(V,J)
                  UIVJ=AOFF(MAX0(UI,VJ))+AADD(MIN0(UI,VJ))
                  VAL=MOINTS(UIVJ)
              ICNT=ICNT+1
C                 AMAT(UV,IJ)=AMAT(UV,IJ)-VAL
                  AMAT(ICNT)=-VAL
   13          CONTINUE
   12       CONTINUE
         CALL WWRITW(TPAMAT,AMAT,INTOWP(LIJ),PON,PON)
   11    CONTINUE
   10 CONTINUE
  100 CONTINUE
      CALL RCLOSE(TPAMAT,3)
      RETURN
      END
C
C                         ********************
C-------------------------****** BINTS ******-------------------------
C                         ********************
C
      SUBROUTINE BINTS(BMAT,NV,NO,FLOV,ORBSYM,NIRRED)
      IMPLICIT INTEGER(A-Z)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
      COMMON/NEWPAR/NAB(8),NAI(8),NIJ(8),MAXOO,MAXVV,MAXOV
      REAL*8 BMAT(NV*NV)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
C
      CALL RFILE(TPBMAT)
      CALL RFILE(ITAP71)
      ADR71=1
      POINTB=1
      WRITE(6,*)
      DO 100 TSYM=1,NIRRED
C
      LAB=0
      DO 90 A=1,NV
C     IF(FZV(A).EQ.1)GO TO 90
      ASYM=ORBSYM(A+NO)
      BSYM=IEOR(ASYM,TSYM-1)+1
      FB=FLOV(BSYM,3)-NO
      LB=FLOV(BSYM,4)-NO
      DO 88 B=FB,LB
      LAB=LAB+1
   88 CONTINUE
   90 CONTINUE
      NAB(TSYM)=LAB
C     WRITE(6,*)'TSYM=',TSYM,' NAB FOR BMAT',LAB
C
      DO 10 BE=1,NV
      BESYM=ORBSYM(BE+NO)
         DO 11 GA=1,BE
         GASYM=ORBSYM(GA+NO)
         BEGAS=IEOR(BESYM,GASYM)
         IF(BEGAS.NE.TSYM-1)GO TO 11
         CALL WREADW(ITAP71,BMAT,INTOWP(LAB),ADR71,ADR71)
         DO 99 K=1,LAB
         BMAT(K)=-BMAT(K)
   99    CONTINUE
         CALL WWRITW(TPBMAT,BMAT,INTOWP(LAB),POINTB,POINTB)
   11    CONTINUE
   10 CONTINUE
  100 CONTINUE
      WRITE(6,*)
      CALL RCLOSE(TPBMAT,3)
      CALL RCLOSE(ITAP71,3)
      RETURN
      END
C
C
C                         ********************
C-------------------------****** CINTS *******-------------------------
C                         ********************
C
      SUBROUTINE CINTS(EMAT,FMAT,MOINTS,NO,NV,T1,LENINT,NTRO,
     .                 NTR,IOFF,JOUT,INO,INTRO,INTRV,INV,NOV,N2OV,FLOV,
     .                 ORBSYM,NIRRED,COFF,NOFF,CADD,NADD,
     .                 EMOFF,EMADD,LEMAT)
      IMPLICIT INTEGER(A-Z)
      REAL*8 MOINTS(LENINT),VAL,EMAT(LEMAT),FMAT(NV*NV),T1(NO,NV)
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER COFF(NOFF),CADD(NADD),EMOFF(NO*NV),EMADD(NO*NO)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
C
      CALL ZERO(EMAT,LEMAT)
C
      DO 10 A=1,NV
         ASYM=ORBSYM(A+NO)
         DO 11 I=1,NO
            ISYM=ORBSYM(I)
            AISYM=IEOR(ASYM,ISYM)
            DO 14 J=1,NO
               JSYM=ORBSYM(J)
               IJ=INO (MAX0(I,J))+MIN0(I,J)
               IJX=INO(I)+J
               KSYM=IEOR(AISYM,JSYM)+1
               FK=FLOV(KSYM,1)
               LK=FLOV(KSYM,2)
               FB=FLOV(KSYM,3)-NO
               LB=FLOV(KSYM,4)-NO
               DO 15 K=FK,LK
                  KAX=INO(A)+K
                  IJKA=EMOFF(KAX)+EMADD(IJX)
         IF(IJKA.GT.LEMAT) WRITE(6,*)'ERROR IN IJKA'
                  DO 16 B=FB,LB
                     AB=INV (MAX0(A,B))+MIN0(A,B)
                     ABIJ=COFF(AB)+CADD(IJ)
                     VAL=MOINTS(ABIJ)
                     EMAT(IJKA)=EMAT(IJKA)+VAL*T1(K,B)
   16             CONTINUE
   15          CONTINUE
   14       CONTINUE
   11    CONTINUE
   10 CONTINUE
C
      CALL RFILE(TPFMAT)
      POINT=1
      DO 23 TSYM=1,NIRRED
      DO 20 A=1,NV
      ASYM=ORBSYM(A+NO)
         DO 21 B=1,NV
         BSYM=ORBSYM(B+NO)
         ABSYM=IEOR(ASYM,BSYM)
         IF(ABSYM.NE.TSYM-1)GO TO 21
         AB=INV (MAX0(A,B))+MIN0(A,B)
C     CALL WREADW(TPFMAT,IDIM,1,POINT,POINT)
C     CALL WREADW(TPFMAT,FMAT,INTOWP(IDIM),POINT,IDUM)
      ICNT=0
            DO 17 C=1,NV
            CSYM=ORBSYM(C+NO)
            ISYM=IEOR(ABSYM,CSYM)+1
            FJ=FLOV(CSYM+1,1)
            LJ=FLOV(CSYM+1,2)
            FI=FLOV(ISYM,1)
            LI=FLOV(ISYM,2)
               DO 18 I=FI,LI
               ICNT=ICNT+1
               VAL=0.0D0
                  DO 19 J=FJ,LJ
                     IJ=INO (MAX0(I,J))+MIN0(I,J)
                     ABIJ=COFF(AB)+CADD(IJ)
                     VAL=VAL+MOINTS(ABIJ)*T1(J,C)
   19             CONTINUE
CF                   FMAT(A,B,C,I)=FMAT(A,B,C,I)+VAL
C                    FMAT(ICNT)=FMAT(ICNT)+VAL
                     FMAT(ICNT)=+VAL
   18          CONTINUE
   17       CONTINUE
      CALL WWRITW(TPFMAT,ICNT,1,POINT,POINT)
      CALL WWRITW(TPFMAT,FMAT,INTOWP(ICNT),POINT,POINT)
   21    CONTINUE
   20 CONTINUE
   23 CONTINUE
      CALL RCLOSE(TPFMAT,3)
      RETURN
      END
C
C                         *********************
C-------------------------****** RCINTS *******-------------------------
C                         *********************
C
      SUBROUTINE RCINTS(RMAT,MOINTS,NO,NV,LENINT,NTRO,
     .                 NTR,IOFF,JOUT,INO,INTRO,INTRV,INV,NOV,N2OV,FLOV,
     .                 ORBSYM,NIRRED,COFF,NOFF,CADD,NADD)
      IMPLICIT INTEGER(A-Z)
      REAL*8 MOINTS(LENINT),VAL,RMAT(NV*NO)
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER COFF(NOFF),CADD(NADD)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
C
      CALL RFILE(TPRMAT)
      POINT=1
      DO 50 TSYM=1,NIRRED
      DO 10 BE=1,NV
         BESYM=ORBSYM(BE+NO)
         DO 20 U=1,NO
            USYM=ORBSYM(U)
            BEUSYM=IEOR(BESYM,USYM)
            IF(BEUSYM.NE.TSYM-1)GO TO 20
      ICNT=0
            DO 30 A=1,NV
               ASYM=ORBSYM(A+NO)
               BEA=INV (MAX0(BE,A))+MIN0(BE,A)
               ISYM=IEOR(BEUSYM,ASYM)+1
               FI=FLOV(ISYM,1)
               LI=FLOV(ISYM,2)
               DO 40 I=FI,LI
      ICNT=ICNT+1
                  IU=INO (MAX0(I,U))+MIN0(I,U)
                  BEAIU=COFF(BEA)+CADD(IU)
CR                RMAT(BE,U,A,I)=RMAT(BE,U,A,I)+MOINTS(BEAIU)
                  RMAT(ICNT    )=MOINTS(BEAIU)
   40          CONTINUE
   30       CONTINUE
C        CALL WWRITW(TPRMAT,ICNT,1,POINT,POINT)
         CALL WWRITW(TPRMAT,RMAT,INTOWP(ICNT),POINT,POINT)
   20    CONTINUE
   10 CONTINUE
   50 CONTINUE
      CALL RCLOSE(TPRMAT,3)
      RETURN
      END
C
C                         ********************
C-------------------------******  EINTS ******-------------------------
C                         ********************
C
      SUBROUTINE EINTS(JMAT,GOMAT,EMAT,FMAT,AMAT,MOINTS,NO,NV,
     .             T1,T2,LENINT,NO2,NV2,NTRO,NTRV,NTR,IOFF,JOUT,FOCK,
     .             INO,INTRO,INTRV,NOV,INV,N2OV,ZLX,UOFF,FLOV,ORBSYM,
     .             NIRRED,EOFF,NOFF,EADD,NADD,
     .             TOFF,TADD,NDIMT2,EMOFF,EMADD,LEMAT)
      IMPLICIT INTEGER(A-Z)
      REAL*8 T2(NDIMT2),T1(NO,NV),JMAT(NV*NO),GOMAT(NO,NO),VAL,
     .       EMAT(LEMAT),VAL1,FMAT(NV*NV),AMAT(NO*NO),
     .       MOINTS(LENINT),VAL2,VAL3,VAL4
      REAL * 8 FOCK(NTR)
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER EOFF(NOFF),EADD(NADD),EMOFF(NO*NV),EMADD(NO*NO)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV)
      INTEGER ZLX(NV,NV),UOFF(NO,NO,2)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
      COMMON/NEWPAR/NAB(8),NAI(8),NIJ(8),MAXOO,MAXVV,MAXOV
C
      DO 9 IRA=1,NIRRED
      ASYM=IRA-1
      FA=FLOV(IRA,3)-NO
      LA=FLOV(IRA,4)-NO
      DO 10 A=FA,LA
         DO 11 J=1,NO
            JSYM=ORBSYM(J)
            AJSYM=IEOR(ASYM,JSYM)
            DO 12 I=1,NO
               ISYM=ORBSYM(I)
               AI=INO(A)+I
               KSYM=IEOR(AJSYM,ISYM)+1
               FK=FLOV(KSYM,1)
               LK=FLOV(KSYM,2)
               DO 13 K=FK,LK
                  JK=INO (MAX0(J,K))+MIN0(J,K)
                  JKX=INO(J)+K
                  AIJK=EOFF(AI)+EADD(JK)
                  JKIA=EMOFF(AI)+EMADD(JKX)
         IF(JKIA.GT.LEMAT) WRITE(6,*)'ERROR IN JKIA'
                  VAL=MOINTS(AIJK)
                  GOMAT(J,K)=GOMAT(J,K)+VAL*(T1(I,A)+T1(I,A))
                  GOMAT(I,K)=GOMAT(I,K)-VAL*T1(J,A)
                  EMAT(JKIA)=EMAT(JKIA)+VAL
   13          CONTINUE
   12       CONTINUE
            DO 14 I=1,NO
               ISYM=ORBSYM(I)
               AI=INO(A)+I
               JI=INO (MAX0(J,I))+MIN0(J,I)
               JIX=INO(J)+I
               LSYM=IEOR(AJSYM,ISYM)+1
               ALSYM=IEOR(ASYM,LSYM-1)
               FL=FLOV(LSYM,1)
               LL=FLOV(LSYM,2)
               DO 15 L=FL,LL
                  JL=INO (MAX0(J,L))+MIN0(J,L)
                  AL=INO(A)+L
                  AIJL=EOFF (AI)+EADD(JL)
                  ALJI=EOFF (AL)+EADD(JI)
                  VAL3=MOINTS(AIJL)
                  VAL4=MOINTS(ALJI)
                  DO 16 B=1,NV
                     BSYM=ORBSYM(B+NO)
                     ZL=ZLX(A,B)
                     JBX=INO(B)+J
                     KSYM=IEOR(ALSYM,BSYM)+1
                     FK=FLOV(KSYM,1)
                     LK=FLOV(KSYM,2)
                     DO 17 K=FK,LK
                        KLAB=TOFF(K,L,ZL)+TADD(A,B)
                        KBX=INO(B)+K
                        IKX=INO(I)+K
                        IKJB=EMOFF(JBX)+EMADD(IKX)
                        JIKB=EMOFF(KBX)+EMADD(JIX)
       IF(IKJB.GT.LEMAT.OR.JIKB.GT.LEMAT) WRITE(6,*)'ERROR IKJB-JIKB'
                        EMAT(IKJB)=EMAT(IKJB)-VAL3*T2(KLAB)
                        EMAT(JIKB)=EMAT(JIKB)-VAL4*T2(KLAB)
   17                CONTINUE
   16             CONTINUE
   15          CONTINUE
   14       CONTINUE
   11    CONTINUE
   10 CONTINUE
    9 CONTINUE
C
      CALL RFILE(TPJMAT)
      POINT=1
      DO 44 J=1,NO
      JSYM=ORBSYM(J)
         DO 43 K=1,NO
      ICNT=0
            KSYM=ORBSYM(K)
            JKSYM=IEOR(KSYM,JSYM)
            JK=INO (MAX0(J,K))+MIN0(J,K)
            DO 42 I=1,NO
               ISYM=ORBSYM(I)
               IK=INO (MAX0(I,K))+MIN0(I,K)
               ASYM=IEOR(JKSYM,ISYM)+1
               FA=FLOV(ASYM,3)-NO
               LA=FLOV(ASYM,4)-NO
               DO 41 A=FA,LA
      ICNT=ICNT+1
               AJ=INO(A)+J
               AI=INO(A)+I
               AIJK=EOFF(AI)+EADD(JK)
               AJIK=EOFF(AJ)+EADD(IK)
               VAL=MOINTS(AIJK)
               VAL1=MOINTS(AJIK)
CJ             JMAT(A,I,J,K)=JMAT(A,I,J,K)+VAL+VAL-VAL1
               JMAT(ICNT)=VAL+VAL-VAL1
   41          CONTINUE
   42       CONTINUE
         CALL WWRITW(TPJMAT,ICNT,1,POINT,POINT)
         CALL WWRITW(TPJMAT,JMAT,INTOWP(ICNT),POINT,POINT)
   43       CONTINUE
   44       CONTINUE
      CALL RCLOSE(TPJMAT,3)
C
      CALL RFILE(TPFMAT)
      POINT=1
      DO 267 TSYM=1,NIRRED
      DO 26 A=1,NV
         ASYM=ORBSYM(A+NO)
         DO 25 C=1,NV
            CSYM=ORBSYM(C+NO)
            ACSYM=IEOR(ASYM,CSYM)
            IF(ACSYM.NE.TSYM-1)GO TO 25
      CALL WREADW(TPFMAT,IDIM,1,POINT,POINT)
      CALL WREADW(TPFMAT,FMAT,INTOWP(IDIM),POINT,IDUM)
      ICNT=0
            DO 21 B=1,NV
               BSYM=ORBSYM(B+NO)
C              BC=IOFF(MAX0(B,C))+MIN0(B,C)
               BCSYM=IEOR(BSYM,CSYM)
               ZL=ZLX(B,C)
               JSYM=IEOR(ACSYM,BSYM)+1
               FJ=FLOV(JSYM,1)
               LJ=FLOV(JSYM,2)
               DO 22 J=FJ,LJ
                  VAL=0.0D+00
                  ICNT=ICNT+1
                  DO 823 IRI=1,NIRRED
                  ISYM=IRI-1
                  FI=FLOV(IRI,1)
                  LI=FLOV(IRI,2)
                  DO 23 I=FI,LI
                     AI=INO(A)+I
                     KSYM=IEOR(ISYM,BCSYM)+1
                     FK=FLOV(KSYM,1)
                     LK=FLOV(KSYM,2)
                     DO 24 K=FK,LK
                        KIBC=TOFF(K,I,ZL)+TADD(B,C)
C                       KIRC=UOFF(K,I,ZL)
                        JK=INO (MAX0(J,K))+MIN0(J,K)
                        AIJK=EOFF (AI)+EADD(JK)
                        VAL=VAL-MOINTS(AIJK)*T2(KIBC)
C                       VAL=VAL-MOINTS(AIJK)*T2(KIRC,BC)
   24                CONTINUE
   23             CONTINUE
  823             CONTINUE
CF                FMAT(A,C,B,J)=FMAT(A,C,B,J)+VAL
                  FMAT(ICNT)=FMAT(ICNT)+VAL
                  FK=FLOV(BSYM+1,1)
                  LK=FLOV(BSYM+1,2)
                  FI=FLOV(CSYM+1,1)
                  LI=FLOV(CSYM+1,2)
                  VAL=0.0D+00
                  DO 723 I=FI,LI
                     AI=INO(A)+I
                     DO 724 K=FK,LK
                        KIRC=UOFF(K,I,ZL)
                        JK=INO (MAX0(J,K))+MIN0(J,K)
                        AIJK=EOFF (AI)+EADD(JK)
                        VAL=VAL-MOINTS(AIJK)*T1(K,B)*T1(I,C)
  724                CONTINUE
  723             CONTINUE
CF                FMAT(A,C,B,J)=FMAT(A,C,B,J)+VAL
                  FMAT(ICNT)=FMAT(ICNT)+VAL
   22          CONTINUE
   21       CONTINUE
      CALL WWRITW(TPFMAT,FMAT,INTOWP(IDIM),POINT,POINT)
   25    CONTINUE
   26 CONTINUE
  267 CONTINUE
      CALL RCLOSE(TPFMAT,3)
C
      DO 98 I=1,NO
      DO 95 J=1,NO
      IJ=IOFF(MAX0(I,J))+MIN0(I,J)
      IF(I.EQ.J)GO TO 93
      GOMAT(I,J)=GOMAT(I,J)+FOCK(IJ)
   93 CONTINUE
      VAL=0.0D0
      DO 94 A=1,NV
      IA=IOFF(A+NO)+I
      VAL=VAL+FOCK(IA)*T1(J,A)
   94 CONTINUE
      GOMAT(I,J)=GOMAT(I,J)+VAL
   95 CONTINUE
   98 CONTINUE
C
 
      CALL RFILE(TPAMAT)
      PON=1
      DO 200 TSYM=1,NIRRED
      LIJ=NIJ(TSYM)
      DO 28 U=1,NO
         USYM=ORBSYM(U)
         DO 29 V=1,U
            VSYM=ORBSYM(V)
            UVSYM=IEOR(USYM,VSYM)
            IF(UVSYM.NE.TSYM-1)GO TO 29
            CALL WREADW(TPAMAT,AMAT,INTOWP(LIJ),PON,IDUM)
            ICNT=0
             DO 30 I=1,NO
                ISYM=ORBSYM(I)
                UI=INO (MAX0(U,I))+MIN0(U,I)
                JSYM=IEOR(UVSYM,ISYM)+1
                FJ=FLOV(JSYM,1)
                LJ=FLOV(JSYM,2)
                DO 31 J=FJ,LJ
                   VJ=INO (MAX0(V,J))+MIN0(V,J)
                   FA=FLOV(ISYM+1,3)-NO
                   LA=FLOV(ISYM+1,4)-NO
                   ICNT=ICNT+1
                   DO 32 A=FA,LA
                      AU=INO(A)+U
                      AUVJ=EOFF (AU)+EADD(VJ)
C                     AMAT(UV,IJ)=AMAT(UV,IJ)-MOINTS(AUVJ)*T1(I,A)
                      AMAT(ICNT )=AMAT(ICNT )-MOINTS(AUVJ)*T1(I,A)
   32              CONTINUE
                   FA=FLOV(JSYM,3)-NO
                   LA=FLOV(JSYM,4)-NO
                   DO 33 A=FA,LA
                      AV=INO(A)+V
                      AVUI=EOFF (AV)+EADD(UI)
C                     AMAT(UV,IJ)=AMAT(UV,IJ)-MOINTS(AVUI)*T1(J,A)
                      AMAT(ICNT )=AMAT(ICNT )-MOINTS(AVUI)*T1(J,A)
   33              CONTINUE
   31           CONTINUE
   30        CONTINUE
          CALL WWRITW(TPAMAT,AMAT,INTOWP(LIJ),PON,PON)
   29     CONTINUE
   28  CONTINUE
  200  CONTINUE
      CALL RCLOSE(TPAMAT,3)
      RETURN
      END
C
C                         ********************
C-------------------------****** RQEINT ******-------------------------
C                         ********************
C
      SUBROUTINE RQEINT(RMAT,QMAT,MOINTS,T1,
     .                  LENINT,NO,NV,NO2,NV2,NTRO,NTRV,
     .                  NTR,IOFF,JOUT,INO,INTRO,INTRV,NOV,INV,N2OV,FLOV,
     .                  ORBSYM,NIRRED,EOFF,NOFF,EADD,NADD)
      IMPLICIT INTEGER(A-Z)
      REAL*8 T1(NO,NV),RMAT(NV*NO),QMAT(NV*NO),MOINTS(LENINT),VALR,VALQ
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER EOFF(NOFF),EADD(NADD)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
      COMMON/NEWPAR/NAB(8),NAI(8),NIJ(8),MAXOO,MAXVV,MAXOV
C
      CALL RFILE(TPRMAT)
      CALL RFILE(TPQMAT)
      POINTR=1
      POINTQ=1
      DO 100 TSYM=1,NIRRED
      IDIM=NAI(TSYM)
      DO 10 BE=1,NV
         BESYM=ORBSYM(BE+NO)
         DO 20 U=1,NO
            USYM=ORBSYM(U)
            BEUSYM=IEOR(BESYM,USYM)
            IF(BEUSYM.NE.TSYM-1)GO TO 20
C     CALL WREADW(TPRMAT,IDIM,1,POINTR,POINTR)
      CALL WREADW(TPRMAT,RMAT,INTOWP(IDIM),POINTR,IDUM )
      ICNT=0
            BEU=INO(BE)+U
            DO 30 A=1,NV
               ASYM=ORBSYM(A+NO)
               ISYM=IEOR(BEUSYM,ASYM)+1
               FI=FLOV(ISYM,1)
               LI=FLOV(ISYM,2)
               DO 40 I=FI,LI
      ICNT=ICNT+1
                  IU=INO (MAX0(I,U))+MIN0(I,U)
                  VALR=0.0D+00
                  VALQ=0.0D+00
                  FJ=FLOV(ASYM+1,1)
                  LJ=FLOV(ASYM+1,2)
                  DO 50 J=FJ,LJ
                     BEJ=INO(BE)+J
                     BEJIU=EOFF (BEJ)+EADD(IU)
                     VALR=VALR+MOINTS(BEJIU)*T1(J,A)
                     IJ=INO (MAX0(I,J))+MIN0(I,J)
                     BEUIJ=EOFF (BEU)+EADD(IJ)
                     VALQ=VALQ+MOINTS(BEUIJ)*T1(J,A)
   50             CONTINUE
C                 QMAT(ICNT)=-VALQ
                  QMAT(ICNT)=-VALQ-VALQ -RMAT(ICNT)+VALR
                  RMAT(ICNT)=RMAT(ICNT)-VALR
   40          CONTINUE
   30       CONTINUE
         CALL WWRITW(TPRMAT,RMAT,INTOWP(IDIM),POINTR,POINTR)
C        CALL WWRITW(TPQMAT,ICNT,1,POINTQ,POINTQ)
         CALL WWRITW(TPQMAT,QMAT,INTOWP(ICNT),POINTQ,POINTQ)
   20    CONTINUE
   10 CONTINUE
  100 CONTINUE
      CALL RCLOSE(TPRMAT,3)
      CALL RCLOSE(TPQMAT,3)
      RETURN
      END
C
C                         ********************
C-------------------------******  FINTS ******-------------------------
C                         ********************
C
      SUBROUTINE FINTS(GVMAT,EMAT,BMAT,MOINTS,NO,NV,
     .           T1,T2,LENINT,NO2,NV2,NTRO,NTRV,NTR,IOFF,JOUT,FOCK,INO,
     .           INTRO,INTRV,NOV,INV,N2OV,ZLX,UOFF,FLOV,ORBSYM,NIRRED,
     .                 FOFF,NVNV,FADD,NM,
     .                 TOFF,TADD,NDIMT2,
     .                 AR3,AR4,SUX1,SUX2,SUX3,SFV,OMG1,
     .                 EMOFF,EMADD,LEMAT)
      IMPLICIT INTEGER(A-Z)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
      COMMON/NEWPAR/NAB(8),NAI(8),NIJ(8),MAXOO,MAXVV,MAXOV
      REAL*8 T2(NDIMT2),T1(NO,NV),GVMAT(NV,NV),VAL,
     .       EMAT(LEMAT),VAL1,
     .       BMAT(NV2),MOINTS(LENINT),VAL2,VAL3,VAL4,TMP,TMV
      REAL*8 FOCK(NTR)
      REAL*8 AR3(MAXVV,MAXOO),AR4(MAXVV,MAXOO),
     .       SUX1(NO*NO),SUX2(NO*NO),SUX3(NV*NV),SFV(NV*NV),OMG1(NO,NO)
      INTEGER IOFF(NTR)
      INTEGER FOFF(NVNV),FADD(NM),EMOFF(NM),EMADD(NO*NO)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER ZLX(NV,NV),UOFF(NO,NO,2)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
C
      DO 9 IRI=1,NIRRED
      ISYM=IRI-1
      FI=FLOV(IRI,1)
      LI=FLOV(IRI,2)
      DO 10 I=FI,LI
         FA=FLOV(ISYM+1,3)-NO
         LA=FLOV(ISYM+1,4)-NO
         DO 11 B=1,NV
            BSYM=ORBSYM(B+NO)
            FC=FLOV(BSYM+1,3)-NO
            LC=FLOV(BSYM+1,4)-NO
C  READ (AI|BC) ALL A,C
            DO 12 A=FA,LA
               AI=INO(A)+I
               DO 13 C=FC,LC
                  BC=INV(MAX0(B,C))+MIN0(B,C)
                  AIBC=FADD(AI)+FOFF(BC)
                  VAL=MOINTS(AIBC)
                  GVMAT(C,B)=GVMAT(C,B)-VAL*(T1(I,A)+T1(I,A))
   13          CONTINUE
   12       CONTINUE
   11    CONTINUE
   10 CONTINUE
      DO 80 I=FI,LI
         FB=FLOV(ISYM+1,3)-NO
         LB=FLOV(ISYM+1,4)-NO
         DO 81 B=FB,LB
            DO 82 A=1,NV
               ASYM=ORBSYM(A+NO)
               FC=FLOV(ASYM+1,3)-NO
               LC=FLOV(ASYM+1,4)-NO
               AI=INO(A)+I
               DO 83 C=FC,LC
                  BC=INV(MAX0(B,C))+MIN0(B,C)
                  AIBC=FADD(AI)+FOFF(BC)
                  VAL=MOINTS(AIBC)
                  GVMAT(C,A)=GVMAT(C,A)+VAL*T1(I,B)
   83          CONTINUE
   82       CONTINUE
   81    CONTINUE
   80 CONTINUE
    9 CONTINUE
C
C     EMAT CONTRIBUTION
C
C     DO 110 I=1,NO
C        ISYM=ORBSYM(I)
C        DO 111 B=1,NV
C           BSYM=ORBSYM(B+NO)
C           IBSYM=IEOR(ISYM,BSYM)
C           DO 21 J=1,NO
C              JSYM=ORBSYM(J)
C              KSYM=IEOR(IBSYM,JSYM)+1
C              FK=FLOV(KSYM,1)
C              LK=FLOV(KSYM,2)
C              DO 22 K=FK,LK
C                 VAL=0.0D+00
C                 DO 823 IRA=1,NIRRED
C                 ASYM=IRA-1
C                 FA=FLOV(IRA,3)-NO
C                 LA=FLOV(IRA,4)-NO
C                 DO 23 A=FA,LA
C                    CSYM=IEOR(IBSYM,ASYM)+1
C                    FC=FLOV(CSYM,3)-NO
C                    LC=FLOV(CSYM,4)-NO
C                    AI=INO(A)+I
C                    DO 24 C=FC,LC
C                       BC=INV(MAX0(B,C))+MIN0(B,C)
C                       ZL=ZLX(A,C)
C                       JKAC=TOFF(J,K,ZL)+TADD(A,C)
C                       AIBC=FADD(AI)+FOFF(BC)
C                       VAL=VAL+MOINTS(AIBC)*(T2(JKAC)+T1(J,A)*T1(K,C))
C  24                CONTINUE
C  23             CONTINUE
C 823             CONTINUE
C                 EMAT(I,J,K,B)=EMAT(I,J,K,B)+VAL
C  22          CONTINUE
C  21       CONTINUE
C 111    CONTINUE
C 110 CONTINUE
      DO 14092 TSYM=1,NIRRED
      XAB=0
      DO 19490 A=1,NV
C     IF(FZV(A).EQ.1)GO TO 19490
      ASYM=ORBSYM(A+NO)
      DO 19480 B=1,A
C     IF(FZV(B).EQ.1)GO TO 19480
      BSYM=ORBSYM(B+NO)
      BASYM=IEOR(BSYM,ASYM)
      IF(BASYM.NE.TSYM-1)GO TO 19480
      XAB=XAB+1
      XIJ=0
      DO 19470 I=1,NO
C     IF(FZO(I).EQ.1)GO TO 19470
      ISYM=ORBSYM(I)
      JSYM=IEOR(ISYM,BASYM)+1
      FJ=FLOV(JSYM,1)
      LJ=FLOV(JSYM,2)
      IF(LJ.GT.I)LJ=I
      DO 19460 J=FJ,LJ
      XIJ=XIJ+1
      IJAB=TOFF(I,J,1)+TADD(A,B)
      JIAB=TOFF(J,I,1)+TADD(A,B)
      VAL1=T2(IJAB)+T1(I,A)*T1(J,B)
      VAL2=T2(JIAB)+T1(J,A)*T1(I,B)
      AR3(XAB,XIJ)=VAL1+VAL2
      AR4(XAB,XIJ)=VAL1-VAL2
19460 CONTINUE
19470 CONTINUE
19480 CONTINUE
19490 CONTINUE
      LIMO=XIJ
      LIMV=XAB
C
      DO 14091 U=1,NO
C     IF(FZO(U).EQ.1)GO TO 14091
      USYM=ORBSYM(U)
      DO 14081 D=1,NV
C     IF(FZV(D).EQ.1)GO TO 14081
      DSYM=ORBSYM(D+NO)
      UDSYM=IEOR(USYM,DSYM)
      IF(UDSYM.NE.TSYM-1)GO TO 14081
          XBA=0
          DO 14025 A=1,NV
C         IF(FZV(A).EQ.1)GO TO 14025
             AD=INV(MAX0(A,D))+MIN0(A,D)
             AU=INO(A)+U
          ASYM=ORBSYM(A+NO)
          BSYM=IEOR(ASYM,UDSYM)
          FB=FLOV(BSYM+1,3)-NO
          LB=FLOV(BSYM+1,4)-NO
          IF(LB.GT. A)LB = A
             DO 14020 B=FB,LB
             BD=INV(MAX0(B,D))+MIN0(B,D)
             BU=INO(B)+U
             AUBD=FOFF(BD)+FADD(AU)
             BUAD=FOFF(AD)+FADD(BU)
             XBA=XBA+1
             TMP=MOINTS(AUBD)+MOINTS(BUAD)
             TMV=MOINTS(AUBD)-MOINTS(BUAD)
             SFV(XBA)= TMP*0.5D0
            SUX3(XBA)= TMV*0.5D0
14020        CONTINUE
             IF(ASYM.EQ.BSYM)SFV(XBA)=SFV(XBA)*0.5D0
14025 CONTINUE
      DO 14077 IJ=1,LIMO
      TMP = 0.0D0
      TMV = 0.0D0
      DO 14029 AB=1,LIMV
      TMP=TMP+ SFV(AB)* AR3(AB,IJ)
      TMV=TMV+SUX3(AB)* AR4(AB,IJ)
14029 CONTINUE
      SUX1(IJ)=TMP
      SUX2(IJ)=TMV
14077 CONTINUE
C
      IJ=0
      DO 14068 I=1,NO
C     IF(FZO(I).EQ.1)GO TO 14068
      ISYM=ORBSYM(I)
      JSYM=IEOR(ISYM,UDSYM)+1
      FJ=FLOV(JSYM,1)
      LJ=FLOV(JSYM,2)
      IF(LJ.GT.I )LJ=I
      DO 14063 J=FJ,LJ
      IJ=IJ+1
      OMG1(I,J)=SUX1(IJ)+SUX2(IJ)
      OMG1(J,I)=SUX1(IJ)-SUX2(IJ)
14063 CONTINUE
14068 CONTINUE
C
      DO 14768 I=1,NO
C     IF(FZO(I).EQ.1)GO TO 14768
      ISYM=ORBSYM(I)
      JSYM=IEOR(ISYM,UDSYM)+1
      FJ=FLOV(JSYM,1)
      LJ=FLOV(JSYM,2)
      UIX=INO(U)+I
      DO 14763 J=FJ,LJ
      JDX=INO(D)+J
      UIJD=EMOFF(JDX)+EMADD(UIX)
       IF(UIJD.GT.LEMAT)WRITE(6,*)'ERROR UIJD'
      EMAT(UIJD)=EMAT(UIJD)+OMG1(I,J)
14763 CONTINUE
14768 CONTINUE
C
14081 CONTINUE
14091 CONTINUE
14092 CONTINUE
C
      DO 98 I=1,NV
      DO 95 J=1,NV
      IJ=IOFF(MAX0(I,J)+NO)+MIN0(I,J)+NO
      IF(I.EQ.J)GO TO 93
      GVMAT(I,J)=GVMAT(I,J)-FOCK(IJ)
   93 CONTINUE
      VAL=0.0D0
      DO 94 A=1,NO
      AJ=IOFF(J+NO)+A
      VAL=VAL+FOCK(AJ)*T1(A,I)
   94 CONTINUE
      GVMAT(I,J)=GVMAT(I,J)+VAL
   95 CONTINUE
   98 CONTINUE
C
      CALL RFILE(TPBMAT)
      POINT=1
      DO 200 TSYM=1,NIRRED
      LAB=NAB(TSYM)
      DO 28 BE=1,NV
      BESYM=ORBSYM(BE+NO)
         DO 29 GA=1,BE
         GASYM=ORBSYM(GA+NO)
         BEGAS=IEOR(BESYM,GASYM)
         IF(BEGAS.NE.TSYM-1)GO TO 29
         BEGA=IOFF(BE)+GA
C     CALL WREADW(TPBMAT,IDIM,1,POINT,POINT)
C     CALL WREADW(TPBMAT,BMAT,INTOWP(IDIM),POINT,IDUM )
      CALL WREADW(TPBMAT,BMAT,INTOWP(LAB),POINT,IDUM )
      ICNT=0
            DO 30 A=1,NV
            ASYM=ORBSYM(A+NO)
            BEA=INV (MAX0(BE,A))+MIN0(BE,A)
            BSYM=IEOR(BEGAS,ASYM)+1
            FB=FLOV(BSYM,3)-NO
            LB=FLOV(BSYM,4)-NO
               DO 31 B=FB,LB
               GAB=INV (MAX0(GA,B))+MIN0(GA,B)
               AB=INV(A)+B
               ICNT=ICNT+1
C              BMAT(ICNT)=0.0D0
                  FI=FLOV(ASYM+1,1)
                  LI=FLOV(ASYM+1,2)
                  DO 32 I=FI,LI
                     BEI=INO(BE)+I
                     BEIGAB=FADD(BEI)+FOFF(GAB)
CB                   BMAT(AB,BEGA)=BMAT(AB,BEGA)+MOINTS(BEIGAB)*T1(I,A)
                     BMAT(ICNT)=BMAT(ICNT)+MOINTS(BEIGAB)*T1(I,A)
   32             CONTINUE
                  FI=FLOV(BSYM,1)
                  LI=FLOV(BSYM,2)
                  DO 332 I=FI,LI
                     GAI=INO(GA)+I
                     GAIBEA=FADD (GAI)+FOFF(BEA)
CB                   BMAT(AB,BEGA)=BMAT(AB,BEGA)+MOINTS(GAIBEA)*T1(I,B)
                     BMAT(ICNT)=BMAT(ICNT)+MOINTS(GAIBEA)*T1(I,B)
  332             CONTINUE
   31          CONTINUE
   30       CONTINUE
C     CALL WWRITW(TPBMAT,ICNT,1,POINT,POINT)
C     CALL WWRITW(TPBMAT,BMAT,INTOWP(ICNT),POINT,POINT)
      CALL WWRITW(TPBMAT,BMAT,INTOWP(LAB),POINT,POINT)
   29    CONTINUE
   28 CONTINUE
  200 CONTINUE
      CALL RCLOSE(TPBMAT,3)
      RETURN
      END
C
C                         ********************
C-------------------------****** FFINTS ******-------------------------
C                         ********************
C
      SUBROUTINE FFINTS(FMAT,MOINTS,T1,T2,NO2,NV2,NTRO,NTRV,NO,NV,
     .           LENINT,NTR,IOFF,JOUT,INO,INTRO,INTRV,NOV,INV,N2OV,ZLX,
     .           UOFF,FLOV,ORBSYM,NIRRED,
     .           FOFF,NVNV,FADD,NM,
     .           TOFF,TADD,NDIMT2)
      IMPLICIT INTEGER(A-Z)
      REAL*8 T2(NDIMT2),T1(NO,NV),VAL,VAL1,VAL2,VAL3,MOINTS(LENINT),
     .       VAL4,FMAT(NV*NV)
      INTEGER IOFF(NTR)
      INTEGER FOFF(NVNV),FADD(NM)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER ZLX(NV,NV),UOFF(NO,NO,2)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
C
C     WRITE (JOUT,*) ' IN FFINTS'
      CALL RFILE(TPFMAT)
      POINT=1
      DO 9 TSYM=1,NIRRED
      DO 10 BE=1,NV
         BESYM=ORBSYM(BE+NO)
         DO 820 IRA=1,NIRRED
         ASYM=IRA-1
         FA=FLOV(IRA,3)-NO
         LA=FLOV(IRA,4)-NO
         DO 20 A=FA,LA
            BEASYM=IEOR(BESYM,ASYM)
            IF(BEASYM.NE.TSYM-1)GO TO 20
            BEA=INV (MAX0(BE,A))+MIN0(BE,A)
      CALL WREADW(TPFMAT,IDIM,1,POINT,POINT)
      CALL WREADW(TPFMAT,FMAT,INTOWP(IDIM),POINT,IDUM )
      ICNT=0
            DO 30 B=1,NV
               BSYM=ORBSYM(B+NO)
               ISYM=IEOR(BEASYM,BSYM)+1
               FI=FLOV(ISYM,1)
               LI=FLOV(ISYM,2)
               DO 40 I=FI,LI
                  BI=INO(B)+I
                  BIBEA=FADD (BI)+FOFF(BEA)
                  VAL1=0.0D+00
                  VAL2=0.0D+00
                  VAL3=0.0D+00
      ICNT=ICNT+1
CF                FMAT(BE,A,B,I)=FMAT(BE,A,B,I)-MOINTS(BIBEA)
CFNEW             FMAT(ICNT)=FMAT(ICNT)-MOINTS(BIBEA)
                  DO 850 IRJ=1,NIRRED
                  JSYM=IRJ-1
                  FJ=FLOV(IRJ,1)
                  LJ=FLOV(IRJ,2)
                  DO 50 J=FJ,LJ
                     JSYM=ORBSYM(J)
                     CSYM=IEOR(BEASYM,JSYM)+1
                     FC=FLOV(CSYM,3)-NO
                     LC=FLOV(CSYM,4)-NO
                     DO 60 C=FC,LC
                        CJ=INO(C)+J
C                       BC=IOFF(MAX0(B,C))+MIN0(B,C)
                        ZL=ZLX(B,C)
                        IJBC=TOFF(I,J,ZL)+TADD(B,C)
                        JIBC=TOFF(J,I,ZL)+TADD(B,C)
C                       IJ=UOFF(I,J,ZL)
C                       JI=UOFF(J,I,ZL)
                        CJBEA=FADD (CJ)+FOFF(BEA)
                        VAL1=VAL1+MOINTS(CJBEA)*T2(JIBC)
                        VAL2=VAL2+MOINTS(CJBEA)*T2(IJBC)
C                       VAL1=VAL1+MOINTS(CJBEA)*T2(JI,BC)
C                       VAL2=VAL2+MOINTS(CJBEA)*T2(IJ,BC)
   60                CONTINUE
   50             CONTINUE
  850             CONTINUE
CF                FMAT(BE,A,B,I)=FMAT(BE,A,B,I)+VAL1-VAL2-VAL2
CFNEW             FMAT(ICNT)=FMAT(ICNT)+VAL1-VAL2-VAL2
CF CHANGE#1       VAL3=0.0D+00
C                 FJ=FLOV(BSYM+1,1)
C                 LJ=FLOV(BSYM+1,2)
C                 DO 51 J=FJ,LJ
C                    FC=FLOV(ISYM,3)-NO
C                    LC=FLOV(ISYM,4)-NO
C                    DO 61 C=FC,LC
C                       CJ=INO(C)+J
C                       CJBEA=FADD (CJ)+FOFF(BEA)
C                       VAL3=VAL3+MOINTS(CJBEA)*T1(J,B)*T1(I,C)
C  61                CONTINUE
C  51             CONTINUE
CF                FMAT(BE,A,B,I)=FMAT(BE,A,B,I)+VAL3
CF                FMAT(ICNT)=FMAT(ICNT)+VAL3
   40          CONTINUE
   30       CONTINUE
      CALL WWRITW(TPFMAT,FMAT,INTOWP(IDIM),POINT,POINT)
   20    CONTINUE
  820    CONTINUE
   10 CONTINUE
    9 CONTINUE
      CALL RCLOSE(TPFMAT,3)
C
      CALL RFILE(TPFMAT)
      POINT=1
      DO 978 TSYM=1,NIRRED
      DO 980 C=1,NV
      CSYM=ORBSYM(C+NO)
         DO 1000 B=1,NV
         BSYM=ORBSYM(B+NO)
         BCSYM=IEOR(BSYM,CSYM)
         IF(BCSYM.NE.TSYM-1)GO TO 1000
      CALL WREADW(TPFMAT,IDIM,1,POINT,POINT)
      CALL WREADW(TPFMAT,FMAT,INTOWP(IDIM),POINT,IDUM )
      ICNT=0
            DO 910 BE=1,NV
            BESYM=ORBSYM(BE+NO)
            ISYM=IEOR(BCSYM,BESYM)+1
            FI=FLOV(ISYM,1)
            LI=FLOV(ISYM,2)
               DO 1100 I=FI,LI
      ICNT=ICNT+1
                  DO 920 A=1,NV
                  ASYM=ORBSYM(A+NO)
C                 AB=IOFF(MAX0(A,B))+MIN0(A,B)
                  ZL=ZLX(A,B)
                  BEASYM=IEOR(BESYM,ASYM)
                  BEA=INV (MAX0(BE,A))+MIN0(BE,A)
                  JSYM=IEOR(BEASYM,CSYM)+1
                  FJ=FLOV(JSYM,1)
                  LJ=FLOV(JSYM,2)
                     DO 990 J=FJ,LJ
                     CJ=INO(C)+J
                     CJBEA=FADD (CJ)+FOFF(BEA)
                     IJAB=TOFF(I,J,ZL)+TADD(A,B)
C                    IJ=UOFF(I,J,ZL)
CF CHANGE#2
C
C      VAL=MOINTS(CJBEA)*(T2(IJAB)+T1(I,A)*T1(J,B))
       VAL=MOINTS(CJBEA)* T2(IJAB)
CF     FMAT(C,B,BE,I)=FMAT(C,B,BE,I)+VAL
       FMAT(ICNT)=FMAT(ICNT)+VAL
  990    CONTINUE
  920    CONTINUE
C
               DO 1920 A=1,NV
               ASYM=ORBSYM(A+NO)
               BASYM=IEOR(BSYM,ASYM)
               BA=INV (MAX0(B,A))+MIN0(B,A)
               JSYM=IEOR(BASYM,CSYM)+1
               FJ=FLOV(JSYM,1)
               LJ=FLOV(JSYM,2)
               DO 1990 J=FJ,LJ
                  CJ=INO(C)+J
                  CJBA=FADD (CJ)+FOFF(BA)
C                ABE=IOFF(MAX0(A,BE))+MIN0(A,BE)
                  ZL=ZLX(A,BE)
                  JIABE=TOFF(J,I,ZL)+TADD(A,BE)
C                 JI=UOFF(J,I,ZL)
           VAL=MOINTS(CJBA)*T2(JIABE)
C          VAL=MOINTS(CJBA)*T2(JI,ABE)
CF         FMAT(C,B,BE,I)=FMAT(C,B,BE,I)+VAL
CFNEW      FMAT(ICNT)=FMAT(ICNT)+VAL
 1990    CONTINUE
 1920    CONTINUE
C
 1100    CONTINUE
  910    CONTINUE
      CALL WWRITW(TPFMAT,FMAT,INTOWP(IDIM),POINT,POINT)
 1000    CONTINUE
  980    CONTINUE
  978    CONTINUE
      CALL RCLOSE(TPFMAT,3)
      RETURN
      END
C
C
C
      SUBROUTINE NFINTS(FMAT,MOINTS,T1,T2,NO2,NV2,NTRO,NTRV,NO,NV,
     .           LENINT,NTR,IOFF,JOUT,INO,INTRO,INTRV,NOV,INV,N2OV,ZLX,
     .           UOFF,FLOV,ORBSYM,NIRRED,
     .           FOFF,NVNV,FADD,NM,
     .           TOFF,TADD,NDIMT2,DINTS,DOFF,DADD,
     .           AR1,AR2,JAR,KAR,SUX1,SUX2,AUX1,
     .           BUF,IBUF,LENBUF,NSHOV,NSLVO)
      IMPLICIT INTEGER(A-Z)
      REAL*8 T2(NDIMT2),T1(NO,NV),VAL,VAL1,VAL2,VAL3,MOINTS(LENINT),
     .       VAL4,FMAT(NV*NV),VALL,VALJ,VALK,DINTS(LENINT)
      REAL*8 AR1(MAXOV,MAXOV),AR2(MAXOV,MAXOV),
     .       JAR(NO*NV),KAR(NO*NV),
     .       SUX1(NO*NV),SUX2(NO*NV),AUX1(NO,NO),BUF(*)
C     REAL*8 XMAT(9,9,5)
      INTEGER IOFF(NTR),NLIM(8),IBUF(*)
      INTEGER FOFF(NVNV),FADD(NM),DOFF(NM),DADD(NM)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER ZLX(NV,NV),UOFF(NO,NO,2)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
      COMMON/NEWPAR/NAB(8),NAI(8),NIJ(8),MAXOO,MAXVV,MAXOV
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
C
C     NEW F INTERMEDIATE
C
C     MODIFIED NOV 15, 88:
C     MOINTS CONTAINS F INTS. AFTER 1ST TERM IS STORE IN 89, D INTS
C     ARE READ IN MOINTS AND USED. F INTS ARE RESTORED IN MOINTS BEFORE
C     RETURNING TO MAIN.
C
C
      CALL RFILE(TPFMAT)
      CALL RFILE(89)
C
      PON=1
      DO 14695 TSYM=1,NIRRED
      DO 14690 BE=1,NV
C     IF(FZV(BE).EQ.1)GO TO 14690
      BESYM=ORBSYM(BE+NO)
      DO 14680 A=1,NV
C     IF(FZV(A).EQ.1)GO TO 14680
      ASYM=ORBSYM(A+NO)
      BEASYM=IEOR(BESYM,ASYM)
      IF(BEASYM.NE.TSYM-1)GO TO 14680
      BEA=INV(MAX0(BE,A))+MIN0(BE,A)
C
      XCJ=0
      DO 14490 J=1,NO
C     IF(FZO(J).EQ.1)GO TO 14490
      BEJ=INO(BE)+J
      JSYM=ORBSYM(J)
      CSYM=IEOR(JSYM,BEASYM)+1
      FC=FLOV(CSYM,3)-NO
      LC=FLOV(CSYM,4)-NO
      DO 14470 C=FC,LC
      CJ=INO(C)+J
      BEACJ=FOFF(BEA)+FADD(CJ)
      VALJ=MOINTS(BEACJ)
      CA=INV(MAX0(C,A))+MIN0(C,A)
      BEJCA=FOFF(CA)+FADD(BEJ)
      VALK=MOINTS(BEJCA)
C
C     FK=FLOV(ASYM+1,1)
C     LK=FLOV(ASYM+1,2)
C     DO 15450 K=FK,LK
C     BEK=INO(BE)+K
C     BEKCJ=DOFF(MAX0(BEK,CJ))+DADD(MIN0(BEK,CJ))
C     CK=INO(C)+K
C     BEJCK=DOFF(MAX0(BEJ,CK))+DADD(MIN0(BEJ,CK))
C     VALJ=VALJ-DINTS(BEKCJ)*T1(K,A)
C     VALK=VALK-DINTS(BEJCK)*T1(K,A)
14450 CONTINUE
C
      XCJ=XCJ+1
      JAR(XCJ)=VALJ+VALJ-VALK
      KAR(XCJ)=VALK
14470 CONTINUE
14490 CONTINUE
      LIM=XCJ
C
      CALL WWRITW(89,JAR,INTOWP(LIM),PON,PON)
      CALL WWRITW(89,KAR,INTOWP(LIM),PON,PON)
14680 CONTINUE
14690 CONTINUE
      NLIM(TSYM)=LIM
14695 CONTINUE
C
      CALL RDINTS(63,DINTS,NSHOV,
     .            JOUT,BUF,IBUF,LENBUF,IOFF,NBF,NTR,
     .            NO,NV,NOV,NTRO,NTRV,NO2,NV2,INO,INTRO,
     .            INTRV,INV,N2OV,
     .            INO,NOV,INO,NOV,
     .            DOFF,NM,DADD,NM)
C
      PON=1
      DO 15695 TSYM=1,NIRRED
      LIM=NLIM(TSYM)
      DO 15690 BE=1,NV
      BESYM=ORBSYM(BE+NO)
      DO 15680 A=1,NV
      ASYM=ORBSYM(A+NO)
      BEASYM=IEOR(BESYM,ASYM)
      IF(BEASYM.NE.TSYM-1)GO TO 15680
      CALL WREADW(89,JAR,INTOWP(LIM),PON,CON)
      CALL WREADW(89,KAR,INTOWP(LIM),CON,DUM)
C
      XCJ=0
      DO 15490 J=1,NO
      BEJ=INO(BE)+J
      JSYM=ORBSYM(J)
      CSYM=IEOR(JSYM,BEASYM)+1
      FC=FLOV(CSYM,3)-NO
      LC=FLOV(CSYM,4)-NO
      DO 15470 C=FC,LC
      CJ=INO(C)+J
      VALJ=0.0D0
      VALK=0.0D0
C
      FK=FLOV(ASYM+1,1)
      LK=FLOV(ASYM+1,2)
      DO 15450 K=FK,LK
      BEK=INO(BE)+K
      BEKCJ=DOFF(MAX0(BEK,CJ))+DADD(MIN0(BEK,CJ))
      CK=INO(C)+K
      BEJCK=DOFF(MAX0(BEJ,CK))+DADD(MIN0(BEJ,CK))
      VALJ=VALJ-DINTS(BEKCJ)*T1(K,A)
      VALK=VALK-DINTS(BEJCK)*T1(K,A)
15450 CONTINUE
C
      XCJ=XCJ+1
      JAR(XCJ)=JAR(XCJ)+VALJ+VALJ-VALK
      KAR(XCJ)=KAR(XCJ)+VALK
15470 CONTINUE
15490 CONTINUE
C
      CALL WWRITW(89,JAR,INTOWP(LIM),PON,PON)
      CALL WWRITW(89,KAR,INTOWP(LIM),PON,PON)
15680 CONTINUE
15690 CONTINUE
15695 CONTINUE
C
C   GO FOR THE EXCHANGE TERM
C
      POINT=1
      DO 985 TSYM=1,NIRRED
         DO 980 BE=1,NV
            BESYM=ORBSYM(BE+NO)
            DO 940 A=1,NV
               ASYM=ORBSYM(A+NO)
               BEASYM=IEOR(BESYM,ASYM)
               IF(BEASYM.NE.TSYM-1)GO TO 940
               CALL WREADW(TPFMAT,IDIM,1,POINT,POINT)
               CALL WREADW(TPFMAT,FMAT,INTOWP(IDIM),POINT,IDUM )
               ICNT3=0
C              ICNT=0
C              DO 908 B=1,NV
C                 BSYM=ORBSYM(B+NO)
C                 ISYM=IEOR(BEASYM,BSYM)+1
C                 FI=FLOV(ISYM,1)
C                 LI=FLOV(ISYM,2)
C                 DO 906 I=FI,LI
C                    ICNT=ICNT+1
C                    VAL=0.0D0
C                    DO 904 C=1,NV
C                       CSYM=ORBSYM(C+NO)
C                       ZL=ZLX(C,A)
C                       BCSYM=IEOR(BSYM,CSYM)
C                       BC=INV(MAX0(B,C))+MIN0(B,C)
C                       JSYM=IEOR(BESYM,BCSYM)+1
C                       FJ=FLOV(JSYM,1)
C                       LJ=FLOV(JSYM,2)
C                       DO 902 J=FJ,LJ
C                          BEJ=INO(BE)+J
C                          BEJBC=FADD(BEJ)+FOFF(BC)
C                          IJCA=TOFF(I,J,ZL)+TADD(C,A)
C                          VAL=VAL+MOINTS(BEJBC)*T2(IJCA)
C 902                   CONTINUE
C 904                CONTINUE
C                    FMAT(ICNT)=FMAT(ICNT)+VAL
CF                   FMAT(BE,A,B,I)=FMAT(BE,A,B,I)+VAL
C 906             CONTINUE
C 908          CONTINUE
               CALL ZERO(AUX1,NO*NO)
               DO 918 I=1,NO
                  ISYM=ORBSYM(I)
                  JSYM=IEOR(BEASYM,ISYM)+1
                  FJ=FLOV(JSYM,1)
                  LJ=FLOV(JSYM,2)
                  DO 916 J=FJ,LJ
                     DO 914 C=1,NV
                        CJ=INO(C)+J
                        ZLA=ZLX(C,A)
                        CSYM=ORBSYM(C+NO)
                        CASYM=IEOR(CSYM,ASYM)
                        KSYM=IEOR(ISYM,CASYM)+1
                        FK=FLOV(KSYM,1)
                        LK=FLOV(KSYM,2)
                        DO 912 K=FK,LK
                           BEK=INO(BE)+K
                           IKCA=TOFF(I,K,ZLA)+TADD(C,A)
                           IK=UOFF(I,K,ZLA)
                           BEKCJ=DOFF(MAX0(BEK,CJ))+DADD(MIN0(BEK,CJ))
                           AUX1(J,I)=AUX1(J,I)-DINTS(BEKCJ)*T2(IKCA)
  912                   CONTINUE
  914                CONTINUE
  916             CONTINUE
  918          CONTINUE
               DO 926 B=1,NV
                  BSYM=ORBSYM(B+NO)
                  FJ=FLOV(BSYM+1,1)
                  LJ=FLOV(BSYM+1,2)
                  ISYM=IEOR(BEASYM,BSYM)+1
                  FI=FLOV(ISYM,1)
                  LI=FLOV(ISYM,2)
                  DO 924 I=FI,LI
                     ICNT3=ICNT3+1
                     DO 922 J=FJ,LJ
CF                      FMAT(BE,A,B,I)=FMAT(BE,A,B,I)+OMG1(J,I)*T1(J,B)
                        FMAT(ICNT3   )=FMAT(ICNT3   )+AUX1(J,I)*T1(J,B)
  922                CONTINUE
  924             CONTINUE
  926          CONTINUE
               CALL WWRITW(TPFMAT,FMAT,INTOWP(IDIM),POINT,POINT)
  940       CONTINUE
  980    CONTINUE
  985 CONTINUE
C
      CALL RDINTS(65,MOINTS,NSLVO,
     .            JOUT,BUF,IBUF,LENBUF,IOFF,NBF,NTR,
     .            NO,NV,NOV,NTRO,NTRV,NO2,NV2,INO,INTRO,
     .            INTRV,INV,N2OV,
     .            INV,NOV,INO,NOV,
     .            FOFF,NV*NV,FADD,NM)
C
      POINT=1
      DO 885 TSYM=1,NIRRED
         DO 880 BE=1,NV
            BESYM=ORBSYM(BE+NO)
            DO 840 A=1,NV
               ASYM=ORBSYM(A+NO)
               BEASYM=IEOR(BESYM,ASYM)
               IF(BEASYM.NE.TSYM-1)GO TO 840
               CALL WREADW(TPFMAT,IDIM,1,POINT,POINT)
               CALL WREADW(TPFMAT,FMAT,INTOWP(IDIM),POINT,IDUM )
               ICNT=0
               DO 808 B=1,NV
                  BSYM=ORBSYM(B+NO)
                  ISYM=IEOR(BEASYM,BSYM)+1
                  FI=FLOV(ISYM,1)
                  LI=FLOV(ISYM,2)
                  DO 806 I=FI,LI
                     ICNT=ICNT+1
                     VAL=0.0D0
                     DO 804 C=1,NV
                        CSYM=ORBSYM(C+NO)
                        ZL=ZLX(C,A)
                        BCSYM=IEOR(BSYM,CSYM)
                        BC=INV(MAX0(B,C))+MIN0(B,C)
                        JSYM=IEOR(BESYM,BCSYM)+1
                        FJ=FLOV(JSYM,1)
                        LJ=FLOV(JSYM,2)
                        DO 802 J=FJ,LJ
                           BEJ=INO(BE)+J
                           BEJBC=FADD(BEJ)+FOFF(BC)
                           IJCA=TOFF(I,J,ZL)+TADD(C,A)
                           VAL=VAL+MOINTS(BEJBC)*T2(IJCA)
  802                   CONTINUE
  804                CONTINUE
                     FMAT(ICNT)=FMAT(ICNT)+VAL
  806             CONTINUE
  808          CONTINUE
               CALL WWRITW(TPFMAT,FMAT,INTOWP(IDIM),POINT,POINT)
  840       CONTINUE
  880    CONTINUE
  885 CONTINUE
C
C
C
      PON=1
      POINT=1
      DO 16695 TSYM=1,NIRRED
      LIM=NLIM(TSYM)
      XIB=0
      DO 16790 B=1,NV
C     IF(FZV(B).EQ.1)GO TO 16770
      BSYM=ORBSYM(B+NO)
      DO 16770 I=1,NO
C     IF(FZO(I).EQ.1)GO TO 16790
      ISYM=ORBSYM(I)
      IBSYM=IEOR(ISYM,BSYM)
      IF(IBSYM.NE.TSYM-1)GO TO 16770
      XIB=XIB+1
      XCJ=0
      DO 16750 J=1,NO
C     IF(FZO(J).EQ.1)GO TO 16750
      JSYM=ORBSYM(J)
      CSYM=IEOR(JSYM,IBSYM)+1
      FC=FLOV(CSYM,3)-NO
      LC=FLOV(CSYM,4)-NO
      DO 16730 C=FC,LC
      XCJ=XCJ+1
      ZL=ZLX(C,B)
      JICB=TOFF(J,I,ZL)+TADD(C,B)
      IJCB=TOFF(I,J,ZL)+TADD(C,B)
      AR1(XCJ,XIB)=T2(JICB)+T2(JICB)-T2(IJCB)
      AR2(XCJ,XIB)=T2(IJCB)
16730 CONTINUE
16750 CONTINUE
16770 CONTINUE
16790 CONTINUE
C
      DO 16690 BE=1,NV
C     IF(FZV(BE).EQ.1)GO TO 16690
      BESYM=ORBSYM(BE+NO)
      DO 16680 A=1,NV
C     IF(FZV(A).EQ.1)GO TO 16680
      ASYM=ORBSYM(A+NO)
      BEASYM=IEOR(BESYM,ASYM)
      IF(BEASYM.NE.TSYM-1)GO TO 16680
      CALL WREADW(TPFMAT,IDIM,1,POINT,POINT)
      CALL WREADW(TPFMAT,FMAT,INTOWP(IDIM),POINT,DUM)
      ICNT=0
      BEA=INV(MAX0(BE,A))+MIN0(BE,A)
      CALL WREADW(89,JAR,INTOWP(LIM),PON,PON)
      CALL WREADW(89,KAR,INTOWP(LIM),PON,PON)
C
      DO 16661 BI=1,LIM
      VAL1=0.0D0
      VAL2=0.0D0
      DO 16391 CJ=1,LIM
      VAL1=VAL1+JAR(CJ)*AR1(CJ,BI)
      VAL2=VAL2+KAR(CJ)*AR2(CJ,BI)
16391 CONTINUE
      SUX1(BI)=-0.5D0*VAL1
      SUX2(BI)= 0.5D0*VAL2
16661 CONTINUE
C
      XBI=0
      DO 16660 B=1,NV
C     IF(FZV(B).EQ.1)GO TO 16660
      BSYM=ORBSYM(B+NO)
      ISYM=IEOR(BSYM,BEASYM)+1
      FI=FLOV(ISYM,1)
      LI=FLOV(ISYM,2)
      DO 16410  I=FI,LI
      BI=INO(B)+I
      BIBEA=FOFF(BEA)+FADD(BI)
      XBI=XBI+1
      ICNT=ICNT+1
      FMAT(ICNT)=FMAT(ICNT)+SUX1(XBI)+SUX2(XBI)-MOINTS(BIBEA)
16410 CONTINUE
16660 CONTINUE
      CALL WWRITW(TPFMAT,FMAT,INTOWP(IDIM),POINT,POINT)
16680 CONTINUE
16690 CONTINUE
16695 CONTINUE
C
      CALL RCLOSE(89,3)
      CALL RCLOSE(TPFMAT,3)
C
      RETURN
      END
C
C                         ********************
C-------------------------****** HFINTS ******-------------------------
C                         ********************
C
      SUBROUTINE HFINTS(HMAT,MOINTS,NO2,NV2,NTRO,NTRV,NO,NV,
     .           LENINT,NTR,IOFF,JOUT,INO,INTRO,INTRV,NOV,INV,N2OV,FLOV,
     .           ORBSYM,NIRRED,
     .           FOFF,NVNV,FADD,NM)
      IMPLICIT INTEGER(A-Z)
      REAL*8 VAL,VAL1,VAL2,VAL3,MOINTS(LENINT),
     .       VAL4,HMAT(NV*NV)
      INTEGER IOFF(NTR)
      INTEGER FOFF(NVNV),FADD(NM)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
    6 FORMAT (' H(',I2,',',I2,',',I2,',',I2,')=',F20.12)
C
      CALL RFILE(TPHMAT)
      POINT=1
      DO 10 V=1,NO
         VSYM=ORBSYM(V)
         DO 20 GA=1,NV
            GASYM=ORBSYM(GA+NO)
            VGASYM=IEOR(VSYM,GASYM)
            VGA=INO(GA)+V
      ICNT=0
            DO 30 BE=1,NV
               BESYM=ORBSYM(BE+NO)
               ASYM=IEOR(VGASYM,BESYM)+1
            VBE=INO(BE)+V
               FA=FLOV(ASYM,3)-NO
               LA=FLOV(ASYM,4)-NO
               DO 40 A=FA,LA
      ICNT=ICNT+1
                  BEA=INV (MAX0(BE,A))+MIN0(BE,A)
                  GAA=INV (MAX0(GA,A))+MIN0(GA,A)
                  VGABEA=FADD (VGA)+FOFF(BEA)
                  VBEGAA=FADD (VBE)+FOFF(GAA)
CH                HMAT(V,GA,BE,A)=HMAT(V,GA,BE,A)-MOINTS(VGABEA)
CH   .                            -MOINTS(VGABEA)+MOINTS(VBEGAA)
      HMAT(ICNT)=-MOINTS(VGABEA)-MOINTS(VGABEA)+MOINTS(VBEGAA)
CGES              HMAT(V,BE,GA,A)=HMAT(V,BE,GA,A)+MOINTS(VGABEA)
   40          CONTINUE
   30       CONTINUE
         CALL WWRITW(TPHMAT,ICNT,1,POINT,POINT)
         CALL WWRITW(TPHMAT,HMAT,INTOWP(ICNT),POINT,POINT)
   20    CONTINUE
   10 CONTINUE
      CALL RCLOSE(TPHMAT,3)
      RETURN
      END
C
C                         ********************
C-------------------------****** RQFINT ******-------------------------
C                         ********************
C
      SUBROUTINE RQFINT(QMAT,RMAT,MOINTS,T1,
     .                  LENINT,NO,NV,NO2,NV2,NTRO,NTRV,
     .                  NTR,IOFF,JOUT,INO,INTRO,INTRV,NOV,INV,N2OV,FLOV,
     .                  ORBSYM,NIRRED,
     .           FOFF,NVNV,FADD,NM)
      IMPLICIT INTEGER(A-Z)
      REAL*8 T1(NO,NV),QMAT(NV*NO),RMAT(NV*NO),MOINTS(LENINT),VALR,VALQ
      INTEGER IOFF(NTR)
      INTEGER FOFF(NVNV),FADD(NM)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
      COMMON/NEWPAR/NAB(8),NAI(8),NIJ(8),MAXOO,MAXVV,MAXOV
C
      CALL RFILE(TPQMAT)
      CALL RFILE(TPRMAT)
      POINTR=1
      POINTQ=1
      DO 100 TSYM=1,NIRRED
      IDIM=NAI(TSYM)
      DO 10 BE=1,NV
         BESYM=ORBSYM(BE+NO)
         DO 20 U=1,NO
            USYM=ORBSYM(U)
            BEUSYM=IEOR(BESYM,USYM)
            IF(BEUSYM.NE.TSYM-1)GO TO 20
C     CALL WREADW(TPQMAT,IDIM,1,POINTQ,POINTQ)
      CALL WREADW(TPQMAT,QMAT,INTOWP(IDIM),POINTQ,IDUM )
C     CALL WREADW(TPRMAT,IDIM,1,POINTR,POINTR)
      CALL WREADW(TPRMAT,RMAT,INTOWP(IDIM),POINTR,IDUM )
      ICNT=0
            BEU=INO(BE)+U
            DO 30 A=1,NV
               BEA=INV (MAX0(BE,A))+MIN0(BE,A)
               ASYM=ORBSYM(A+NO)
               ISYM=IEOR(BEUSYM,ASYM)+1
               FI=FLOV(ISYM,1)
               LI=FLOV(ISYM,2)
               FB=FLOV(ISYM,3)-NO
               LB=FLOV(ISYM,4)-NO
               DO 40 I=FI,LI
                  VALQ=0.0D+00
                  VALR=0.0D+00
      ICNT=ICNT+1
                  DO 50 B=FB,LB
                     BA=INV (MAX0(B,A))+MIN0(B,A)
                     BEUBA=FADD (BEU)+FOFF(BA)
                     VALQ=VALQ+MOINTS(BEUBA)*T1(I,B)
                     BU=INO(B)+U
                     BUBEA=FADD (BU)+FOFF(BEA)
                     VALR=VALR+MOINTS(BUBEA)*T1(I,B)
   50             CONTINUE
C                 QMAT(ICNT)=QMAT(ICNT)+VALQ
                  QMAT(ICNT)=QMAT(ICNT)+VALQ+VALQ-VALR
                  RMAT(ICNT)=RMAT(ICNT)+VALR
   40          CONTINUE
   30       CONTINUE
      CALL WWRITW(TPQMAT,QMAT,INTOWP(IDIM),POINTQ,POINTQ)
      CALL WWRITW(TPRMAT,RMAT,INTOWP(IDIM),POINTR,POINTR)
   20    CONTINUE
   10 CONTINUE
  100 CONTINUE
      CALL RCLOSE(TPQMAT,3)
      CALL RCLOSE(TPRMAT,3)
      RETURN
      END
C
C                         ********************
C-------------------------******  DINTS ******-------------------------
C                         ********************
C
      SUBROUTINE DINTSS(I1MAT,GVMAT,GOMAT,JMAT,AMAT,OMG3,
     .                 FMAT,EMAT,T1,T2,OMG1,OMG2,MOINTS,LENINT,NO,NV,
     .                 NTRO,NTRV,NO2,NV2,NTR,IOFF,JOUT,INO,INTRO,INTRV,
     .                 NOV,INV,N2OV,ZLX,UOFF,FLOV,ORBSYM,NIRRED,
     .                 DOFF,NOFF,DADD,NADD,
     .                 TOFF,TADD,NDIMT2,AR3,AR4,SUX1,SUX2,SFV,SUX3,
     .                 EMOFF,EMADD,LEMAT)
      IMPLICIT INTEGER(A-Z)
      REAL*8 T2(NDIMT2),T1(NO,NV),GVMAT(NV,NV),VAL,VAL1,VAL2,
     .       EMAT(LEMAT),
     .       FMAT(NV*NV),MOINTS(LENINT),VALK,
     .       I1MAT(NO,NV),GOMAT(NO,NO),JMAT(NV*NO),AMAT(NO*NO),
     .       OMG1(NO,NOV),OMG2(NO,NV),OMG3(NV,NV)
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER DOFF(NOFF),DADD(NADD),EMOFF(NO*NV),EMADD(NO*NO)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV)
      INTEGER ZLX(NV,NV),UOFF(NO,NO,2)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
      REAL*8 AR3(MAXVV,MAXOO),AR4(MAXVV,MAXOO),
     .       SUX1(NO*NO),SUX2(NO*NO),SFV(NV*NV),SUX3(NV*NV),
     .       TMP,TMV
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
      COMMON/NEWPAR/NAB(8),NAI(8),NIJ(8),MAXOO,MAXVV,MAXOV
C
      CALL ZERO(I1MAT,NO*NV)
      DO 710 IRA=1,NIRRED
      ASYM=IRA-1
      FA=FLOV(IRA,3)-NO
      LA=FLOV(IRA,4)-NO
      FE=FLOV(IRA,3)-NO
      LE=FLOV(IRA,4)-NO
      DO 10 A=FA,LA
         DO 720 IRI=1,NIRRED
         ISYM=IRI-1
         FI=FLOV(IRI,1)
         LI=FLOV(IRI,2)
         FM=FLOV(IRI,1)
         LM=FLOV(IRI,2)
         DO 20 I=FI,LI
            AISYM=IEOR(ASYM,ISYM)
C   READ (AI|BJ) ALL B,J
            AI=INO(A)+I
            DO 730 IRB=1,NIRRED
            BSYM=IRB-1
            FB=FLOV(IRB,3)-NO
            LB=FLOV(IRB,4)-NO
            DO 30 B=FB,LB
               JSYM=IEOR(AISYM,BSYM)+1
               FJ=FLOV(JSYM,1)
               LJ=FLOV(JSYM,2)
               DO 40 J=FJ,LJ
C                 IJRC=INO(I)+J
C                 JIRC=INO(J)+I
                  BJ=INO(B)+J
                  AIBJ=DOFF(MAX0(AI,BJ))+DADD(MIN0(AI,BJ))
                  VAL=MOINTS(AIBJ)
                  I1MAT(I,A)=I1MAT(I,A)+(VAL+VAL)*T1(J,B)
                  I1MAT(J,A)=I1MAT(J,A)-VAL*T1(I,B)
   40          CONTINUE
   30       CONTINUE
  730       CONTINUE
            DO 80 E=FE,LE
               DO 790 IRC=1,NIRRED
               CSYM=IRC-1
               FC=FLOV(IRC,3)-NO
               LC=FLOV(IRC,4)-NO
               DO 90 C=FC,LC
C                 EC=IOFF(MAX0(E,C))+MIN0(E,C)
                  ZL=ZLX(E,C)
                  JSYM=IEOR(AISYM,CSYM)+1
                  FJ=FLOV(JSYM,1)
                  LJ=FLOV(JSYM,2)
                  DO 100 J=FJ,LJ
                     CJ=INO(C)+J
                     IJEC=TOFF(I,J,ZL)+TADD(E,C)
                     JIEC=TOFF(J,I,ZL)+TADD(E,C)
C                    IJRC=UOFF(I,J,ZL)
C                    JIRC=UOFF(J,I,ZL)
                     AICJ=DOFF(MAX0(AI,CJ))+DADD(MIN0(AI,CJ))
                     VAL=MOINTS(AICJ)
                     GVMAT(E,A)=GVMAT(E,A)+VAL*(T2(IJEC)+T2(IJEC)
     .                          -T2(JIEC)+T1(I,E)*T1(J,C)+T1(I,E)*T1(
     .                          J,C)-T1(J,E)*T1(I,C))
  100             CONTINUE
   90          CONTINUE
  790          CONTINUE
   80       CONTINUE
            DO 131 M=FM,LM
               DO 7141 IRK=1,NIRRED
               KSYM=IRK-1
               FK=FLOV(IRK,1)
               LK=FLOV(IRK,2)
               DO 141 K=FK,LK
                  BSYM=IEOR(AISYM,KSYM)+1
                  FB=FLOV(BSYM,3)-NO
                  LB=FLOV(BSYM,4)-NO
                  DO 151 B=FB,LB
                     BK=INO(B)+K
                     AIBK=DOFF(MAX0(AI,BK))+DADD(MIN0(AI,BK))
                     VAL=MOINTS(AIBK)
C                    AB=IOFF(MAX0(A,B))+MIN0(A,B)
                     ZL=ZLX(A,B)
                     MKAB=TOFF(M,K,ZL)+TADD(A,B)
                     KMAB=TOFF(K,M,ZL)+TADD(A,B)
C                    MKRC=UOFF(M,K,ZL)
C                    KMRC=UOFF(K,M,ZL)
                     GOMAT(I,M)=GOMAT(I,M)+VAL*(T2(MKAB)+T2(MKAB)
     .                          -T2(KMAB)+T1(M,A)*T1(K,B)+T1(M,A)*T1(
     .                          K,B)-T1(M,B)*T1(K,A))
  151             CONTINUE
  141          CONTINUE
 7141          CONTINUE
  131       CONTINUE
            DO 300 J=1,NO
               JSYM=ORBSYM(J)
               KSYM=IEOR(AISYM,JSYM)+1
               FK=FLOV(KSYM,1)
               LK=FLOV(KSYM,2)
               FB=FLOV(KSYM,3)-NO
               LB=FLOV(KSYM,4)-NO
               DO 310 K=FK,LK
                  JKX=INO(J)+K
                  JKIA=EMOFF(AI)+EMADD(JKX)
       IF(JKIA.GT.LEMAT)WRITE(6,*)'ERROR JKIA'
                  DO 320 B=FB,LB
                     BJ=INO(B)+J
                     AIBJ=DOFF(MAX0(AI,BJ))+DADD(MIN0(AI,BJ))
                     EMAT(JKIA)=EMAT(JKIA)+MOINTS(AIBJ)*T1(K,B)
  320             CONTINUE
  310          CONTINUE
  300       CONTINUE
   20    CONTINUE
  720    CONTINUE
   10 CONTINUE
  710 CONTINUE
C
C     A TERM
C
      CALL RFILE(TPAMAT)
      PON=1
      DO 14092 TSYM=1,NIRRED
      IDIM=NIJ(TSYM)
C
      XAB=0
      DO 19490 A=1,NV
C     IF(FZV(A).EQ.1)GO TO 19490
      ASYM=ORBSYM(A+NO)
      DO 19480 B=1,A
C     IF(FZV(B).EQ.1)GO TO 19480
      BSYM=ORBSYM(B+NO)
      BASYM=IEOR(BSYM,ASYM)
      IF(BASYM.NE.TSYM-1)GO TO 19480
      XAB=XAB+1
      XIJ=0
      DO 19470 I=1,NO
C     IF(FZO(I).EQ.1)GO TO 19470
      ISYM=ORBSYM(I)
      JSYM=IEOR(ISYM,BASYM)+1
      FJ=FLOV(JSYM,1)
      LJ=FLOV(JSYM,2)
      IF(LJ.GT.I)LJ=I
      DO 19460 J=FJ,LJ
      XIJ=XIJ+1
      IJAB=TOFF(I,J,1)+TADD(A,B)
      JIAB=TOFF(J,I,1)+TADD(A,B)
      VAL1=T2(IJAB)+T1(I,A)*T1(J,B)
      VAL2=T2(JIAB)+T1(J,A)*T1(I,B)
      AR3(XAB,XIJ)=VAL1+VAL2
      AR4(XAB,XIJ)=VAL1-VAL2
19460 CONTINUE
19470 CONTINUE
19480 CONTINUE
19490 CONTINUE
      LIMO=XIJ
      LIMV=XAB
C
      DO 14091 U=1,NO
C     IF(FZO(U).EQ.1)GO TO 14091
      USYM=ORBSYM(U)
      DO 14081 V=1,U
C     IF(FZO(V).EQ.1)GO TO 14081
      VSYM=ORBSYM(V)
      UVSYM=IEOR(USYM,VSYM)
      IF(UVSYM.NE.TSYM-1)GO TO 14081
C
C
          XBA=0
          DO 14025 A=1,NV
C         IF(FZV(A).EQ.1)GO TO 14025
             AV=INO(A)+V
             AU=INO(A)+U
          ASYM=ORBSYM(A+NO)
          BSYM=IEOR(ASYM,UVSYM)
          FB=FLOV(BSYM+1,3)-NO
          LB=FLOV(BSYM+1,4)-NO
          IF(LB.GT. A)LB = A
             DO 14020 B=FB,LB
             BV=INO(B)+V
             BU=INO(B)+U
             AUBV=DOFF(MAX0(AU,BV))+DADD(MIN0(AU,BV))
             BUAV=DOFF(MAX0(BU,AV))+DADD(MIN0(BU,AV))
             XBA=XBA+1
             TMP=MOINTS(AUBV)+MOINTS(BUAV)
             TMV=MOINTS(AUBV)-MOINTS(BUAV)
             SFV(XBA)= TMP*0.5D0
            SUX3(XBA)= TMV*0.5D0
14020        CONTINUE
             IF(ASYM.EQ.BSYM)SFV(XBA)=SFV(XBA)*0.5D0
14025 CONTINUE
      DO 14077 IJ=1,LIMO
      TMP = 0.0D0
      TMV = 0.0D0
      DO 14029 AB=1,LIMV
      TMP=TMP+ SFV(AB)* AR3(AB,IJ)
      TMV=TMV+SUX3(AB)* AR4(AB,IJ)
14029 CONTINUE
      SUX1(IJ)=TMP
      SUX2(IJ)=TMV
14077 CONTINUE
C
      IJ=0
      DO 14068 I=1,NO
C     IF(FZO(I).EQ.1)GO TO 14068
      ISYM=ORBSYM(I)
      JSYM=IEOR(ISYM,UVSYM)+1
      FJ=FLOV(JSYM,1)
      LJ=FLOV(JSYM,2)
      IF(LJ.GT.I )LJ=I
      DO 14063 J=FJ,LJ
      IJ=IJ+1
      OMG1(I,J)=SUX1(IJ)+SUX2(IJ)
      OMG1(J,I)=SUX1(IJ)-SUX2(IJ)
14063 CONTINUE
14068 CONTINUE
C
      CALL WREADW(TPAMAT,AMAT,INTOWP(IDIM),PON,IDUM)
      IJ=0
      DO 14768 I=1,NO
C     IF(FZO(I).EQ.1)GO TO 14768
      ISYM=ORBSYM(I)
      JSYM=IEOR(ISYM,UVSYM)+1
      FJ=FLOV(JSYM,1)
      LJ=FLOV(JSYM,2)
      DO 14763 J=FJ,LJ
      IJ=IJ+1
      AMAT(IJ)=AMAT(IJ)-OMG1(I,J)
14763 CONTINUE
14768 CONTINUE
      CALL WWRITW(TPAMAT,AMAT,INTOWP(IDIM),PON,PON)
C
14081 CONTINUE
14091 CONTINUE
14092 CONTINUE
      CALL RCLOSE(TPAMAT,3)
C
C
C
      CALL RFILE(TPJMAT)
      POINT=1
      DO 130 K=1,NO
      KSYM=ORBSYM(K)
         DO 134 J=1,NO
         JSYM=ORBSYM(J)
         KJSYM=IEOR(KSYM,JSYM)
      CALL WREADW(TPJMAT,IDIM,1,POINT,POINT)
      CALL WREADW(TPJMAT,JMAT,INTOWP(IDIM),POINT,IDUM )
      ICNT=0
            DO 132 I=1,NO
            ISYM=ORBSYM(I)
            ASYM=IEOR(KJSYM,ISYM)+1
            FA=FLOV(ASYM,3)-NO
            LA=FLOV(ASYM,4)-NO
            FB=FLOV(JSYM+1,3)-NO
            LB=FLOV(JSYM+1,4)-NO
               DO 140 A=FA,LA
               AK=INO(A)+K
               AI=INO(A)+I
      ICNT=ICNT+1
                  DO 150 B=FB,LB
                  BI=INO(B)+I
                  BK=INO(B)+K
                  AIBK=DOFF(MAX0(AI,BK))+DADD(MIN0(AI,BK))
                  AKBI=DOFF(MAX0(AK,BI))+DADD(MIN0(AK,BI))
                  VAL=MOINTS(AIBK)
                  VAL1=MOINTS(AKBI)
CJ                JMAT(A,I,K,J)=JMAT(A,I,K,J)+(VAL+VAL-VAL1)*T1(J,B)
                  JMAT(ICNT   )=JMAT(ICNT   )+(VAL+VAL-VAL1)*T1(J,B)
  150             CONTINUE
  140          CONTINUE
  132       CONTINUE
      CALL WWRITW(TPJMAT,JMAT,INTOWP(IDIM),POINT,POINT)
  134       CONTINUE
  130       CONTINUE
      CALL RCLOSE(TPJMAT,3)
C
      DO 711 IRI=1,NIRRED
      ISYM=IRI-1
      FI=FLOV(IRI,1)
      LI=FLOV(IRI,2)
      DO 11 I=FI,LI
         DO 721 IRJ=1,NIRRED
         JSYM=IRJ-1
         FJ=FLOV(IRJ,1)
         LJ=FLOV(IRJ,2)
         DO 21 J=FJ,LJ
            IJSYM=IEOR(ISYM,JSYM)
C   READ (AI|BJ) ALL A,B
            CALL ZERO(OMG1,NO*NV)
            CALL ZERO(OMG2,NO*NV)
            DO 31 B=1,NV
               BSYM=ORBSYM(B+NO)
               ASYM=IEOR(IJSYM,BSYM)+1
               FA=FLOV(ASYM,3)-NO
               LA=FLOV(ASYM,4)-NO
               FL=FLOV(ASYM,1)
               LL=FLOV(ASYM,2)
               BI=INO(B)+I
               BJ=INO(B)+J
               DO 41 L=FL,LL
                  VAL=0.0D+00
                  VALK=0.0D+00
                  DO 51 A=FA,LA
                     AI=INO(A)+I
                     AJ=INO(A)+J
                     AIBJ=DOFF(MAX0(AI,BJ))+DADD(MIN0(AI,BJ))
                     BIAJ=DOFF(MAX0(AJ,BI))+DADD(MIN0(AJ,BI))
                     VAL=VAL-MOINTS(AIBJ)*T1(L,A)
                     VALK=VALK-MOINTS(BIAJ)*T1(L,A)
   51             CONTINUE
                  OMG1(L,B)=OMG1(L,B)+VAL
                  OMG2(L,B)=OMG2(L,B)+VALK
   41          CONTINUE
   31       CONTINUE
            DO 761 IRC=1,NIRRED
            CSYM=IRC-1
            FC=FLOV(IRC,3)-NO
            LC=FLOV(IRC,4)-NO
            DO 61 C=FC,LC
               ICSYM=IEOR(ISYM,CSYM)
               JCSYM=IEOR(JSYM,CSYM)
               DO 71 L=1,NO
                  ILX=INO(I)+L
                  LSYM=ORBSYM(L)
                  KSYM=IEOR(ICSYM,LSYM)+1
                  FK=FLOV(KSYM,1)
                  LK=FLOV(KSYM,2)
                  BSYM=IEOR(JCSYM,KSYM-1)+1
                  FB=FLOV(BSYM,3)-NO
                  LB=FLOV(BSYM,4)-NO
                  DO 81 K=FK,LK
                     KCX=INO(C)+K
                     ILKC=EMOFF(KCX)+EMADD(ILX)
       IF(ILKC.GT.LEMAT)WRITE(6,*)'ERROR ILKC'
                     DO 91 B=FB,LB
                       ZL=ZLX(C,B)
                       JKCB=TOFF(J,K,ZL)+TADD(C,B)
                       EMAT(ILKC)=EMAT(ILKC)+OMG1(L,B)*T2(JKCB)
   91                CONTINUE
   81             CONTINUE
                  BSYM=IEOR(JCSYM,LSYM)+1
                  FB=FLOV(BSYM,3)-NO
                  LB=FLOV(BSYM,4)-NO
                  DO 181 K=FK,LK
                     KCX=INO(C)+K
                     ILKC=EMOFF(KCX)+EMADD(ILX)
       IF(ILKC.GT.LEMAT)WRITE(6,*)'ERROR ILKC 2'
                     DO 191 B=FB,LB
                       ZL=ZLX(C,B)
                       JLCB=TOFF(J,L,ZL)+TADD(C,B)
                       EMAT(ILKC)=EMAT(ILKC)+OMG2(K,B)*T2(JLCB)
  191                CONTINUE
  181             CONTINUE
   71          CONTINUE
   61       CONTINUE
  761       CONTINUE
   21    CONTINUE
  721    CONTINUE
   11 CONTINUE
  711 CONTINUE
C
C
      CALL RFILE(TPFMAT)
      POINT=1
      DO 3328 TSYM=1,NIRRED
            DO 3330 BE=1,NV
               BESYM=ORBSYM(BE+NO)
            DO 3331 A=1,NV
               ASYM=ORBSYM(A+NO)
               BEASYM=IEOR(BESYM,ASYM)
               IF(BEASYM.NE.TSYM-1)GO TO 3331
      CALL WREADW(TPFMAT,IDIM,1,POINT,POINT)
      CALL WREADW(TPFMAT,FMAT,INTOWP(IDIM),POINT,IDUM )
      ICNT1=0
      ICNT2=0
      ICNT3=0
      ICNT4=0
      ICNT5=0
      ICNT6=0
C
            DO 332 B=1,NV
               BSYM=ORBSYM(B+NO)
               ISYM=IEOR(BEASYM,BSYM)+1
               FI=FLOV(ISYM,1)
               LI=FLOV(ISYM,2)
               FJ=FLOV(ASYM+1,1)
               LJ=FLOV(ASYM+1,2)
               DO 340 I=FI,LI
                     BI=INO(B)+I
      ICNT1=ICNT1+1
                  DO 350 J=FJ,LJ
                     BEJ=INO(BE)+J
                     BIBEJ=DOFF(MAX0(BI,BEJ))+DADD(MIN0(BI,BEJ))
CF                   FMAT(BE,A,B,I)=FMAT(BE,A,B,I)+MOINTS(BIBEJ)*T1(J,A)
      FMAT(ICNT1)=FMAT(ICNT1)+MOINTS(BIBEJ)*T1(J,A)
  350             CONTINUE
  340          CONTINUE
  332       CONTINUE
C
C           CALL ZERO(OMG2,NO*NV)
C           DO 32 C=1,NV
C           CSYM=ORBSYM(C+NO)
C           KSYM=IEOR(BEASYM,CSYM)+1
C           FK=FLOV(KSYM,1)
C           LK=FLOV(KSYM,2)
C              DO 42 K=FK,LK
C              FJ=FLOV(ASYM+1,1)
C              LJ=FLOV(ASYM+1,2)
C              CK=INO(C)+K
C              VAL=0.0D0
C                 DO 52 J=FJ,LJ
C                 BEJ=INO(BE)+J
C                 BEJCK=DOFF(MAX0(BEJ,CK))+DADD(MIN0(BEJ,CK))
C                 OMG2(K,C)=OMG2(K,C)-MOINTS(BEJCK)*T1(J,A)
C  52             CONTINUE
C  42  CONTINUE
C  32  CONTINUE
C      DO 82 B=1,NV
C      BSYM=ORBSYM(B+NO)
C      ISYM=IEOR(BEASYM,BSYM)+1
C      FI=FLOV(ISYM,1)
C      LI=FLOV(ISYM,2)
C      DO 92 I=FI,LI
C     ICNT2=ICNT2+1
C           DO 632 C=1,NV
C           CSYM=ORBSYM(C+NO)
C           ZLB=ZLX(C,B)
C           KSYM=IEOR(BEASYM,CSYM)+1
C           FK=FLOV(KSYM,1)
C           LK=FLOV(KSYM,2)
C              DO 642 K=FK,LK
C      IKCB=TOFF(I,K,ZLB)+TADD(C,B)
CF     FMAT(BE,A,B,I)=FMAT(BE,A,B,I)+OMG2(K,C)*T2(IK,CB)
C      FMAT(ICNT2)=FMAT(ICNT2)+OMG2(K,C)*T2(IKCB)
C 642  CONTINUE
C 632  CONTINUE
C  92  CONTINUE
C  82  CONTINUE
C
C           CALL ZERO(OMG1,NO*NO)
C           DO 732 I=1,NO
C           ISYM=ORBSYM(I)
C           JSYM=IEOR(BEASYM,ISYM)+1
C           FJ=FLOV(JSYM,1)
C           LJ=FLOV(JSYM,2)
C              DO 742 J=FJ,LJ
C              DO 744 C=1,NV
C              CJ=INO(C)+J
C              ZLA=ZLX(C,A)
C              CSYM=ORBSYM(C+NO)
C              CASYM=IEOR(CSYM,ASYM)
C              KSYM=IEOR(ISYM,CASYM)+1
C              FK=FLOV(KSYM,1)
C              LK=FLOV(KSYM,2)
C                 DO 752 K=FK,LK
C                 BEK=INO(BE)+K
C                 IKCA=TOFF(I,K,ZLA)+TADD(C,A)
C                 BEKCJ=DOFF(MAX0(BEK,CJ))+DADD(MIN0(BEK,CJ))
C                 OMG1(J,I)=OMG1(J,I)-MOINTS(BEKCJ)*T2(IKCA)
C 752             CONTINUE
C 744  CONTINUE
C 742  CONTINUE
C 732  CONTINUE
C      DO 782 B=1,NV
C      BSYM=ORBSYM(B+NO)
C      FJ=FLOV(BSYM+1,1)
C      LJ=FLOV(BSYM+1,2)
C      ISYM=IEOR(BEASYM,BSYM)+1
C      FI=FLOV(ISYM,1)
C      LI=FLOV(ISYM,2)
C      DO 772 I=FI,LI
C     ICNT3=ICNT3+1
C      DO 792 J=FJ,LJ
CF     FMAT(BE,A,B,I)=FMAT(BE,A,B,I)+OMG1(J,I)*T1(J,B)
C      FMAT(ICNT3   )=FMAT(ICNT3   )+OMG1(J,I)*T1(J,B)
C 792  CONTINUE
C 772  CONTINUE
C 782  CONTINUE
C
CF
CF CHANGE#3
C              DO 122 B=1,NV
C              AB=IOFF(MAX0(A,B))+MIN0(A,B)
C              ZL=ZLX(A,B)
C              BSYM=ORBSYM(B+NO)
C              ABSYM=IEOR(BSYM,ASYM)
C              CSYM=IEOR(BEASYM,BSYM)+1
C              FC=FLOV(CSYM,3)-NO
C              LC=FLOV(CSYM,4)-NO
C           CALL ZERO(OMG3,NV*NV)
C                 DO 23 C=FC,LC
C                 VAL=0.0D+00
C                 DO 933 IRJ=1,NIRRED
C                 JSYM=IRJ-1
C                 FJ=FLOV(IRJ,1)
C                 LJ=FLOV(IRJ,2)
C                    DO 33 J=FJ,LJ
C                    KSYM=IEOR(ABSYM,JSYM)+1
C                    FK=FLOV(KSYM,1)
C                    LK=FLOV(KSYM,2)
C                    BEJ=INO(BE)+J
C                       DO 43 K=FK,LK
C                       JKAB=TOFF(J,K,ZL)+TADD(A,B)
C                       JK=UOFF(J,K,ZL)
C                       CK=INO(C)+K
C                       BEJCK=DOFF(MAX0(BEJ,CK))+DADD(MIN0(BEJ,CK))
C                       VAL=VAL+MOINTS(BEJCK)*T2(JKAB)
C  43                CONTINUE
C  33             CONTINUE
C 933             CONTINUE
C                 OMG3(C,1)=OMG3(C,1)+VAL
C                 VAL=0.0D+00
C                 FJ=FLOV(ASYM+1,1)
C                 LJ=FLOV(ASYM+1,2)
C                 FK=FLOV(BSYM+1,1)
C                 LK=FLOV(BSYM+1,2)
C                 DO 733 J=FJ,LJ
C                    BEJ=INO(BE)+J
C                    DO 743 K=FK,LK
C                       CK=INO(C)+K
C                       BEJCK=DOFF(MAX0(BEJ,CK))+DADD(MIN0(BEJ,CK))
C                       VAL=VAL+MOINTS(BEJCK)*T1(J,A)*T1(K,B)
C 743                CONTINUE
C 733             CONTINUE
C                 OMG3(C,1)=OMG3(C,1)+VAL
C  23             CONTINUE
C
C           FI=FLOV(CSYM,1)
C           LI=FLOV(CSYM,2)
C           DO 93 I=FI,LI
C           ICNT4=ICNT4+1
C           DO 83 C=FC,LC
CF          FMAT(BE,A,B,I)=FMAT(BE,A,B,I)-OMG3(C,1)*T1(I,C)
C           FMAT(ICNT4   )=FMAT(ICNT4   )-OMG3(C,1)*T1(I,C)
C  83       CONTINUE
C  93       CONTINUE
C 122    CONTINUE
C
C           CALL ZERO(OMG1,NO*NV)
C           DO 117 C=1,NV
C           CSYM=ORBSYM(C+NO)
C           JSYM=IEOR(BEASYM,CSYM)+1
C           FJ=FLOV(JSYM,1)
C           LJ=FLOV(JSYM,2)
C           FK=FLOV(ASYM+1,1)
C           LK=FLOV(ASYM+1,2)
C              DO 123 J=FJ,LJ
C              BEJ=INO(BE)+J
C              CJ=INO(C)+J
C                 DO 133 K=FK,LK
C                 BEK=INO(BE)+K
C                 CK=INO(C)+K
C                 BEJCK=DOFF(MAX0(BEJ,CK))+DADD(MIN0(BEJ,CK))
C                 BEKCJ=DOFF(MAX0(BEK,CJ))+DADD(MIN0(BEK,CJ))
C      OMG1(J,C)=OMG1(J,C)+(MOINTS(BEKCJ)+MOINTS(BEKCJ)-MOINTS(BEJCK))
C    .           *T1(K,A)
C 133             CONTINUE
C 123    CONTINUE
C 117    CONTINUE
C           DO 153 B=1,NV
C           BSYM=ORBSYM(B+NO)
C           ISYM=IEOR(BEASYM,BSYM)+1
C           FI=FLOV(ISYM,1)
C           LI=FLOV(ISYM,2)
C           DO 143 I=FI,LI
C           ICNT5=ICNT5+1
C           DO 118 C=1,NV
C           ZL=ZLX(C,B)
C           CSYM=ORBSYM(C+NO)
C           JSYM=IEOR(BEASYM,CSYM)+1
C           FJ=FLOV(JSYM,1)
C           LJ=FLOV(JSYM,2)
C           DO 124 J=FJ,LJ
C           JICB=TOFF(J,I,ZL)+TADD(C,B)
CF          FMAT(BE,A,B,I)=FMAT(BE,A,B,I)+OMG1(J,C)*T2(JI,CB)
C           FMAT(ICNT5   )=FMAT(ICNT5   )+OMG1(J,C)*T2(JICB)
C 124    CONTINUE
C 118    CONTINUE
C 143       CONTINUE
C 153       CONTINUE
C
         FK=FLOV(BESYM+1,1)
         LK=FLOV(BESYM+1,2)
            DO 34 B=1,NV
            BSYM=ORBSYM(B+NO)
               ISYM=IEOR(BEASYM,BSYM)+1
               FI=FLOV(ISYM,1)
               LI=FLOV(ISYM,2)
               DO 44 I=FI,LI
       ICNT6=ICNT6+1
                  ZL=ZLX(B,A)
                  VAL=0.0D+00
                  DO 54 K=FK,LK
                     IKBA=TOFF(I,K,ZL)+TADD(B,A)
                     VAL=VAL+I1MAT(K,BE)*T2(IKBA)
   54             CONTINUE
CF                FMAT(BE,A,B,I)=FMAT(BE,A,B,I)+VAL
                  FMAT(ICNT6   )=FMAT(ICNT6   )+VAL
   44          CONTINUE
   34       CONTINUE
C
      CALL WWRITW(TPFMAT,FMAT,INTOWP(IDIM),POINT,POINT)
 3331       CONTINUE
 3330       CONTINUE
 3328       CONTINUE
      CALL RCLOSE(TPFMAT,3)
C
      RETURN
      END
C
C                         ********************
C-------------------------****** HDINTS ******-------------------------
C                         ********************
C
      SUBROUTINE HDINTS(HMAT,MOINTS,NO2,NV2,T1,NTRO,NTRV,NO,NV,LENINT,
     .                 NTR,IOFF,JOUT,INO,INTRO,INTRV,NOV,INV,N2OV,FLOV,
     .                 ORBSYM,NIRRED,
     .                 DOFF,NOFF,DADD,NADD)
      IMPLICIT INTEGER(A-Z)
      REAL*8 T1(NO,NV),HMAT(NV*NV),VAL,VAL2,MOINTS(LENINT),VALK
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER DOFF(NOFF),DADD(NADD)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
C
      CALL RFILE(TPHMAT)
      POINT=1
      DO 10 V=1,NO
         VSYM=ORBSYM(V)
         DO 20 GA=1,NV
            GASYM=ORBSYM(GA+NO)
            VGASYM=IEOR(VSYM,GASYM)
            GAV=INO(GA)+V
      CALL WREADW(TPHMAT,IDIM,1,POINT,POINT)
      CALL WREADW(TPHMAT,HMAT,INTOWP(IDIM),POINT,IDUM )
      ICNT=0
            DO 30 BE=1,NV
               BESYM=ORBSYM(BE+NO)
               ISYM=IEOR(VGASYM,BESYM)+1
               FI=FLOV(ISYM,1)
               LI=FLOV(ISYM,2)
               FA=FLOV(ISYM,3)-NO
               LA=FLOV(ISYM,4)-NO
               BEV=INO(BE)+V
               DO 40 A=FA,LA
                  VAL=0.0D+00
                  VAL2=0.0D+00
      ICNT=ICNT+1
                  DO 50 I=FI,LI
                     BEI=INO(BE)+I
                     GAI=INO(GA)+I
                     BEIGAV=DOFF(MAX0(BEI,GAV))+DADD(MIN0(BEI,GAV))
                     BEVGAI=DOFF(MAX0(BEV,GAI))+DADD(MIN0(BEV,GAI))
                     VAL=VAL+MOINTS(BEIGAV)*T1(I,A)
                     VAL2=VAL2+MOINTS(BEVGAI)*T1(I,A)
   50             CONTINUE
CH                HMAT(V,GA,BE,A)=HMAT(V,GA,BE,A)+VAL+VAL-VAL2
                  HMAT(ICNT     )=HMAT(ICNT     )+VAL+VAL-VAL2
   40         CONTINUE
   30      CONTINUE
      CALL WWRITW(TPHMAT,HMAT,INTOWP(IDIM),POINT,POINT)
   20    CONTINUE
   10 CONTINUE
      CALL RCLOSE(TPHMAT,3)
      RETURN
      END
C
C                         ********************
C-------------------------****** BDINTS ******-------------------------
C                         ********************
C
      SUBROUTINE BDENTS(BMAT,MOINTS,NO2,NV2,T1,T2,NTRO,NTRV,NO,NV,LENINT
     .                 ,NTR,IOFF,JOUT,INO,INTRO,INTRV,NOV,INV,N2OV,FLOV,
     .                  ORBSYM,NIRRED,ZLX,UOFF,
     .                 DOFF,NOFF,DADD,NADD,
     .                 TOFF,TADD,NDIMT2)
      IMPLICIT INTEGER(A-Z)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
      COMMON/NEWPAR/NAB(8),NAI(8),NIJ(8),MAXOO,MAXVV,MAXOV
      REAL*8 T1(NO,NV),BMAT(NV2),VAL,VAL2,T2(NDIMT2),MOINTS(LENINT)
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER DOFF(NOFF),DADD(NADD)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
      DIMENSION ZLX(NV,NV),UOFF(NO,NO,2)
    1 FORMAT (' B(',I2,',',I2,',',I2,',',I2,')=',F20.12)
C
      CALL RFILE(TPBMAT)
      POINT=1
      DO 100 TSYM=1,NIRRED
      LAB=NAB(TSYM)
      DO 10 BE=1,NV
      BESYM=ORBSYM(BE+NO)
          DO 20 GA=1,BE
          GASYM=ORBSYM(GA+NO)
          BEGAS=IEOR(BESYM,GASYM)
          BEGA=IOFF(BE)+GA
          IF(BEGAS.NE.TSYM-1)GO TO 20
      CALL WREADW(TPBMAT,BMAT,INTOWP(LAB),POINT,IDUM )
      ICNT=0
      DO 30 A=1,NV
      ASYM=ORBSYM(A+NO)
      BSYM=IEOR(BEGAS,ASYM)+1
      FB=FLOV(BSYM,3)-NO
      LB=FLOV(BSYM,4)-NO
         DO 40 B=FB,LB
            AB=INV(A)+B
            ZLAB=ZLX(A,B)
            ICNT=ICNT+1
                  VAL=0.0D+00
                  DO 750 IRI=1,NIRRED
                  ISYM=IRI-1
                  JSYM=IEOR(BEGAS,ISYM)+1
                  FJ=FLOV(JSYM,1)
                  LJ=FLOV(JSYM,2)
                  FI=FLOV(IRI,1)
                  LI=FLOV(IRI,2)
                  DO 50 I=FI,LI
                     BEI=INO(BE)+I
                     DO 60 J=FJ,LJ
                        IJAB=TOFF(I,J,ZLAB)+TADD(A,B)
                        GAJ=INO(GA)+J
                        BEIGAJ=DOFF(MAX0(BEI,GAJ))+DADD(MIN0(BEI,GAJ))
                        VAL=VAL+MOINTS(BEIGAJ)*T2(IJAB)
   60                CONTINUE
   50             CONTINUE
  750             CONTINUE
CB                BMAT(AB,BEGA)=BMAT(AB,BEGA)-VAL
                  BMAT(ICNT)=BMAT(ICNT)-VAL
                  VAL=0.0D+00
                  FI=FLOV(ASYM+1,1)
                  LI=FLOV(ASYM+1,2)
                  FJ=FLOV(BSYM,1)
                  LJ=FLOV(BSYM,2)
                  DO 51 I=FI,LI
                     BEI=INO(BE)+I
                     DO 61 J=FJ,LJ
                        GAJ=INO(GA)+J
                        BEIGAJ=DOFF(MAX0(BEI,GAJ))+DADD(MIN0(BEI,GAJ))
                        VAL=VAL+MOINTS(BEIGAJ)*T1(I,A)*T1(J,B)
   61                CONTINUE
   51             CONTINUE
CB                BMAT(AB,BEGA)=BMAT(AB,BEGA)-VAL
                  BMAT(ICNT)=BMAT(ICNT)-VAL
   40          CONTINUE
   30       CONTINUE
      CALL WWRITW(TPBMAT,BMAT,INTOWP(LAB),POINT,POINT)
   20    CONTINUE
   10 CONTINUE
  100 CONTINUE
      CALL RCLOSE(TPBMAT,3)
      RETURN
      END
C
C
C
      SUBROUTINE BDINTS(BMAT,MOINTS,NO2,NV2,T1,T2,NTRO,NTRV,NO,NV,LENINT
     .                 ,NTR,IOFF,JOUT,INO,INTRO,INTRV,NOV,INV,N2OV,FLOV,
     .                  ORBSYM,NIRRED,ZLX,UOFF,
     .                 DOFF,NOFF,DADD,NADD,
     .                 TOFF,TADD,NDIMT2,
     .                 AR5,AR6,SUX1,SUX2,SUX3,SFV,OMG3)
      IMPLICIT INTEGER(A-Z)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
      COMMON/NEWPAR/NAB(8),NAI(8),NIJ(8),MAXOO,MAXVV,MAXOV
      REAL*8 T1(NO,NV),BMAT(NV2),VAL1,VAL2,T2(NDIMT2),MOINTS(LENINT)
      REAL*8 AR5(MAXOO,MAXVV),AR6(MAXOO,MAXVV),
     .       SUX1(NO*NO),SUX2(NO*NO),SUX3(NV*NV),SFV(NV*NV),
     .       OMG3(NV,NV),TMP,TMV
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER DOFF(NOFF),DADD(NADD)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
      DIMENSION ZLX(NV,NV),UOFF(NO,NO,2)
    1 FORMAT (' B(',I2,',',I2,',',I2,',',I2,')=',F20.12)
C
      CALL RFILE(TPBMAT)
      PON=1
      DO 12392 TSYM=1,NIRRED
      XAB=0
      DO 33590 A=1,NV
C     IF(FZV(A).EQ.1)GO TO 33590
      ASYM=ORBSYM(A+NO)
      DO 33580 B=1,A
C     IF(FZV(B).EQ.1)GO TO 33580
      BSYM=ORBSYM(B+NO)
      ABSYM=IEOR(ASYM,BSYM)
      IF(ABSYM.NE.TSYM-1)GO TO 33580
      XAB=XAB+1
      XIJ=0
      DO 33570 I=1,NO
C     IF(FZO(I).EQ.1)GO TO 33570
      ISYM=ORBSYM(I)
      JSYM=IEOR(ISYM,ABSYM)+1
      FJ=FLOV(JSYM,1)
      LJ=FLOV(JSYM,2)
      IF(LJ.GT.I)LJ=I
      DO 33560 J=FJ,LJ
      XIJ=XIJ+1
      IJAB=TOFF(I,J,1)+TADD(A,B)
      JIAB=TOFF(J,I,1)+TADD(A,B)
      VAL1=T2(IJAB)+T1(I,A)*T1(J,B)
      VAL2=T2(JIAB)+T1(J,A)*T1(I,B)
      AR5(XIJ,XAB)=VAL1+VAL2
      AR6(XIJ,XAB)=VAL1-VAL2
33560 CONTINUE
33570 CONTINUE
33580 CONTINUE
33590 CONTINUE
      LIMO=XIJ
      LIMV=XAB
C
      DO 12391 BE=1,NV
C     IF(FZV(BE).EQ.1)GO TO 12391
      BESYM=ORBSYM(BE+NO)
      DO 12381 GA=1,BE
C     IF(FZV(GA).EQ.1)GO TO 12381
      GASYM=ORBSYM(GA+NO)
      BEGAS=IEOR(BESYM,GASYM)
      IF(BEGAS.NE.TSYM-1)GO TO 12381
C
          XJI=0
          DO 15025 I=1,NO
C         IF(FZO(I).EQ.1)GO TO 15025
          BEI=INO(BE)+I
          GAI=INO(GA)+I
          ISYM=ORBSYM(I)
          JSYM=IEOR(ISYM,BEGAS)
          FJ=FLOV(JSYM+1,1)
          LJ=FLOV(JSYM+1,2)
          IF(LJ.GT. I)LJ = I
             DO 15020 J=FJ,LJ
             BEJ=INO(BE)+J
             GAJ=INO(GA)+J
             BEIGAJ=DOFF(MAX0(BEI,GAJ))+DADD(MIN0(BEI,GAJ))
             BEJGAI=DOFF(MAX0(BEJ,GAI))+DADD(MIN0(BEJ,GAI))
             XJI=XJI+1
             VAL1=MOINTS(BEIGAJ)
             VAL2=MOINTS(BEJGAI)
             TMP=VAL1+VAL2
             TMV=VAL1-VAL2
            SUX1(XJI)= TMP*0.5D0
            SUX2(XJI)= TMV*0.5D0
15020        CONTINUE
             IF(ISYM.EQ.JSYM)SUX1(XJI)=SUX1(XJI)*0.5D0
15025 CONTINUE
      DO 14370 AB=1,LIMV
      TMP=0.0D0
      TMV=0.0D0
      DO 14350 IJ=1,LIMO
      TMP=TMP+SUX1(IJ)* AR5(IJ,AB)
      TMV=TMV+SUX2(IJ)* AR6(IJ,AB)
14350 CONTINUE
      SUX3(AB)=TMP
       SFV(AB)=TMV
14370 CONTINUE
C
      AB=0
      DO 14068 A=1,NV
C     IF(FZV(A).EQ.1)GO TO 14068
      ASYM=ORBSYM(A+NO)
      BSYM=IEOR(ASYM,BEGAS)+1
      FB=FLOV(BSYM,3)-NO
      LB=FLOV(BSYM,4)-NO
      IF(LB.GT.A )LB=A
      DO 14063 B=FB,LB
      AB=AB+1
      OMG3(A,B)=SUX3(AB)+SFV (AB)
      OMG3(B,A)=SUX3(AB)-SFV (AB)
14063 CONTINUE
14068 CONTINUE
C
      IDIM=NAB(TSYM)
      CALL WREADW(TPBMAT,BMAT,INTOWP(IDIM),PON,IDUM)
      AB=0
      DO 14768 A=1,NV
C     IF(FZV(A).EQ.1)GO TO 14768
      ASYM=ORBSYM(A+NO)
      BSYM=IEOR(ASYM,BEGAS)+1
      FB=FLOV(BSYM,3)-NO
      LB=FLOV(BSYM,4)-NO
      DO 14763 B=FB,LB
      AB=AB+1
      BMAT(AB)=BMAT(AB)-OMG3(A,B)
14763 CONTINUE
14768 CONTINUE
      CALL WWRITW(TPBMAT,BMAT,INTOWP(IDIM),PON,PON)
C
12381 CONTINUE
12391 CONTINUE
12392 CONTINUE
      CALL RCLOSE(TPBMAT,3)
      RETURN
      END
C
C                         ********************
C-------------------------****** RQDINT ******-------------------------
C                         ********************
C
C
      SUBROUTINE RQDINT(QMAT,RMAT,MOINTS,NO2,NV2,T1,T2,
     .                  NTRO,NTRV,NO,NV,
     .                  LENINT,NTR,IOFF,JOUT,INO,INTRO,INTRV,NOV,INV,
     .                  N2OV,ZLX,UOFF,FLOV,ORBSYM,NIRRED,
     .                  DOFF,NOFF,DADD,NADD,
     .                  TOFF,TADD,NDIMT2,
     .                  AR1,AR2,SUX1,SUX2,JAR,KAR)
      IMPLICIT INTEGER(A-Z)
      REAL*8 T2(NDIMT2),T1(NO,NV),QMAT(NV*NO),RMAT(NO*NV),MOINTS(LENINT)
     .       ,VAL,VAL1,VAL2,VAL3,VALR,VALQ
      REAL*8 AR1(MAXOV,MAXOV),AR2(MAXOV,MAXOV),
     .       SUX1(NO*NV),SUX2(NO*NV),JAR(NO*NV),KAR(NO*NV)
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER DOFF(NOFF),DADD(NADD)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV)
      INTEGER ZLX(NV,NV),UOFF(NO,NO,2)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
      COMMON/NEWPAR/NAB(8),NAI(8),NIJ(8),MAXOO,MAXVV,MAXOV
C
      CALL RFILE(TPRMAT)
      CALL RFILE(TPQMAT)
      POINTR=1
      POINTQ=1
C
      DO 16695 TSYM=1,NIRRED
      IDIM=NAI(TSYM)
C
      XVG=0
      DO 16790 GA=1,NV
C     IF(FZV(GA).EQ.1)GO TO 16790
      GASYM=ORBSYM(GA+NO)
      DO 16770 V=1,NO
C     IF(FZO(V).EQ.1)GO TO 16770
      VSYM=ORBSYM(V)
      VGASYM=IEOR(VSYM,GASYM)
      IF(VGASYM.NE.TSYM-1)GO TO 16770
      XVG=XVG+1
      XAI=0
      DO 16750 A=1,NV
C     IF(FZV(A).EQ.1)GO TO 16750
      ASYM=ORBSYM(A+NO)
      ISYM=IEOR(ASYM,VGASYM)+1
      ZL=ZLX(GA,A)
      FI=FLOV(ISYM,1)
      LI=FLOV(ISYM,2)
      DO 16730 I=FI,LI
      XAI=XAI+1
      IVGAA=TOFF(I,V,ZL)+TADD(GA,A)
      VIGAA=TOFF(V,I,ZL)+TADD(GA,A)
      VAL1=T2(VIGAA)
      VAL2=T2(IVGAA)+T1(I,GA)*T1(V,A)
      AR1(XAI,XVG)=VAL1+VAL1-VAL2
      AR2(XAI,XVG)=-VAL2
16730 CONTINUE
16750 CONTINUE
16770 CONTINUE
16790 CONTINUE
      LIM=XVG
C
      DO 16690 BE=1,NV
C     IF(FZV(BE).EQ.1)GO TO 16690
      BESYM=ORBSYM(BE+NO)
      DO 16680 U=1,NO
C     IF(FZO(U).EQ.1)GO TO 16680
      USYM=ORBSYM(U)
      BEUSYM=IEOR(BESYM,USYM)
      IF(BEUSYM.NE.TSYM-1)GO TO 16680
      BEU=INO(BE)+U
      XAI=0
           DO 12300 A=1,NV
           ASYM=ORBSYM(A+NO)
           ISYM=IEOR(ASYM,BEUSYM)+1
           FI=FLOV(ISYM,1)
           LI=FLOV(ISYM,2)
            AU=INO( A)+U
           DO 12280 I=FI,LI
           BEI=INO(BE)+I
            AI=INO( A)+I
           BEUAI=DOFF(MAX0(BEU,AI))+DADD(MIN0(BEU,AI))
           BEIAU=DOFF(MAX0(BEI,AU))+DADD(MIN0(BEI,AU))
           VAL1=MOINTS(BEUAI)
           VAL2=MOINTS(BEIAU)
           XAI=XAI+1
           JAR(XAI)=VAL1+VAL1-VAL2
           KAR(XAI)=VAL2
12280 CONTINUE
12300 CONTINUE
C
      DO 15661 VGA=1,LIM
      VAL1=0.0D0
      VAL2=0.0D0
      DO 15391 AI=1,LIM
      VAL1=VAL1+JAR(AI)*AR1(AI,VGA)
      VAL2=VAL2+KAR(AI)*AR2(AI,VGA)
15391 CONTINUE
      SUX1(VGA)= VAL1
      SUX2(VGA)= VAL2
15661 CONTINUE
C
      CALL WREADW(TPRMAT,RMAT,INTOWP(IDIM),POINTR,DUM)
      CALL WREADW(TPQMAT,QMAT,INTOWP(IDIM),POINTQ,DUM)
      VGA=0
      DO 15660 GA=1,NV
C     IF(FZV(GA).EQ.1)GO TO 15660
      GASYM=ORBSYM(GA+NO)
      VSYM=IEOR(GASYM,BEUSYM)+1
      FV=FLOV(VSYM,1)
      LV=FLOV(VSYM,2)
      DO 15410  V=FV,LV
      GAV=INO(GA)+V
      BEUGAV=DOFF(MAX0(BEU,GAV))+DADD(MIN0(BEU,GAV))
      VGA=VGA+1
      QMAT(VGA)=QMAT(VGA)+SUX1(VGA)+MOINTS(BEUGAV)+MOINTS(BEUGAV)
      RMAT(VGA)=RMAT(VGA)+SUX2(VGA)
15410 CONTINUE
15660 CONTINUE
      CALL WWRITW(TPRMAT,RMAT,INTOWP(IDIM),POINTR,POINTR)
      CALL WWRITW(TPQMAT,QMAT,INTOWP(IDIM),POINTQ,POINTQ)
16680 CONTINUE
16690 CONTINUE
16695 CONTINUE
      CALL RCLOSE(TPRMAT,3)
      CALL RCLOSE(TPQMAT,3)
C
      RETURN
      END
      SUBROUTINE RQDENT(QMAT,RMAT,MOINTS,NO2,NV2,T1,T2,
     .                  NTRO,NTRV,NO,NV,
     .                  LENINT,NTR,IOFF,JOUT,INO,INTRO,INTRV,NOV,INV,
     .                  N2OV,ZLX,UOFF,FLOV,ORBSYM,NIRRED,
     .                  DOFF,NOFF,DADD,NADD,
     .                  TOFF,TADD,NDIMT2)
      IMPLICIT INTEGER(A-Z)
      REAL*8 T2(NDIMT2),T1(NO,NV),QMAT(NV*NO),RMAT(NO*NV),MOINTS(LENINT)
     .       ,VAL,VAL2,VAL3,VALR,VALQ
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER DOFF(NOFF),DADD(NADD)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV)
      INTEGER ZLX(NV,NV),UOFF(NO,NO,2)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
      COMMON/NEWPAR/NAB(8),NAI(8),NIJ(8),MAXOO,MAXVV,MAXOV
C
      CALL RFILE(TPQMAT)
      CALL RFILE(TPRMAT)
      POINTR=1
      POINTQ=1
      DO 100 TSYM=1,NIRRED
      IDIM=NAI(TSYM)
      DO 10 BE=1,NV
         BESYM=ORBSYM(BE+NO)
         DO 20 U=1,NO
            USYM=ORBSYM(U)
            BEUSYM=IEOR(BESYM,USYM)
            IF(BEUSYM.NE.TSYM-1)GO TO 20
C     CALL WREADW(TPQMAT,IDIM,1,POINTQ,POINTQ)
      CALL WREADW(TPQMAT,QMAT,INTOWP(IDIM),POINTQ,IDUM )
C     CALL WREADW(TPRMAT,IDIM,1,POINTR,POINTR)
      CALL WREADW(TPRMAT,RMAT,INTOWP(IDIM),POINTR,IDUM )
      ICNT=0
            BEU=INO(BE)+U
            DO 730 IRA=1,NIRRED
            ASYM=IRA-1
            FA=FLOV(IRA,3)-NO
            LA=FLOV(IRA,4)-NO
            ISYM=IEOR(BEUSYM,ASYM)+1
            FI=FLOV(ISYM,1)
            LI=FLOV(ISYM,2)
            DO 30 A=FA,LA
               DO 40 I=FI,LI
      ICNT=ICNT+1
                  AI=INO(A)+I
                  BEUAI=DOFF(MAX0(BEU,AI))+DADD(MIN0(BEU,AI))
                  VAL=0.0D+00
                  VALR=0.0D+00
                  VAL2=0.0D+00
                  VAL3=0.0D+00
                  DO 750 IRJ=1,NIRRED
                  JSYM=IRJ-1
                  FJ=FLOV(IRJ,1)
                  LJ=FLOV(IRJ,2)
                  BSYM=IEOR(BEUSYM,JSYM)+1
                  FB=FLOV(BSYM,3)-NO
                  LB=FLOV(BSYM,4)-NO
                  DO 50 J=FJ,LJ
                     BEJ=INO(BE)+J
                     DO 60 B=FB,LB
                        ZL=ZLX(A,B)
                        JIAB=TOFF(J,I,ZL)+TADD(A,B)
                        IJAB=TOFF(I,J,ZL)+TADD(A,B)
                        BJ=INO(B)+J
                        BU=INO(B)+U
                        BEJBU=DOFF(MAX0(BEJ,BU))+DADD(MIN0(BEJ,BU))
                        BEUBJ=DOFF(MAX0(BEU,BJ))+DADD(MIN0(BEU,BJ))
                        VAL=VAL+MOINTS(BEUBJ)*T2(JIAB)
                        VAL2=VAL2+MOINTS(BEJBU)*T2(IJAB)
                        VAL3=VAL3+MOINTS(BEUBJ)*T2(IJAB)
                        VALR=VALR+MOINTS(BEJBU)*T2(JIAB)
   60                CONTINUE
   50             CONTINUE
  750             CONTINUE
                  VALQ=-VAL-VAL2+VAL3+VAL3+MOINTS(BEUAI)
C                 QMAT(ICNT)=QMAT(ICNT)-VAL-VAL2+VAL3+VAL3
C    .                                 +MOINTS(BEUAI)
                  QMAT(ICNT)=QMAT(ICNT)+VALQ+VALQ+VALR
                  RMAT(ICNT)=RMAT(ICNT)-VALR
                  VALQ=0.0D+00
                  VALR=0.0D+00
                  FJ=FLOV(IRA,1)
                  LJ=FLOV(IRA,2)
                  FB=FLOV(ISYM,3)-NO
                  LB=FLOV(ISYM,4)-NO
                  DO 51 J=FJ,LJ
                     BEJ=INO(BE)+J
                     DO 61 B=FB,LB
                        BU=INO(B)+U
                        BJ=INO(B)+J
                        BEUBJ=DOFF(MAX0(BEU,BJ))+DADD(MIN0(BEU,BJ))
                        BEJBU=DOFF(MAX0(BEJ,BU))+DADD(MIN0(BEJ,BU))
                        VALQ=VALQ+MOINTS(BEUBJ)*T1(J,A)*T1(I,B)
                        VALR=VALR+MOINTS(BEJBU)*T1(J,A)*T1(I,B)
   61                CONTINUE
   51             CONTINUE
C                 QMAT(ICNT)=QMAT(ICNT)-VALQ
                  QMAT(ICNT)=QMAT(ICNT)-VALQ-VALQ+VALR
                  RMAT(ICNT)=RMAT(ICNT)-VALR
   40          CONTINUE
   30       CONTINUE
  730       CONTINUE
            CALL WWRITW(TPQMAT,QMAT,INTOWP(IDIM),POINTQ,POINTQ)
            CALL WWRITW(TPRMAT,RMAT,INTOWP(IDIM),POINTR,POINTR)
   20    CONTINUE
   10 CONTINUE
  100 CONTINUE
      CALL RCLOSE(TPQMAT,3)
      CALL RCLOSE(TPRMAT,3)
      RETURN
      END
C
C                         ********************
C-------------------------******  ADDE  ******-------------------------
C                         ********************
C
      SUBROUTINE ADDE(EMAT,I1MAT,JMAT,T1,T2,IOFF,NO,NV,NTRO,NTRV,
     .                NO2,NV2,NTR,JOUT,INO,INTRO,INTRV,NOV,INV,N2OV,ZLX,
     .                ZLXO,UOFF,FLOV,ORBSYM,NIRRED,
     .                TOFF,TADD,NDIMT2,EMOFF,EMADD,LEMAT)
      IMPLICIT INTEGER(A-Z)
      REAL*8 T2(NDIMT2),T1(NO,NV),JMAT(NV*NO),EMAT(LEMAT),
     .       I1MAT(NO,NV)
      INTEGER IOFF(NTR),EMOFF(NO*NV),EMADD(NO*NO)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV)
      INTEGER ZLX(NV,NV),UOFF(NO,NO,2),ZLXO(NO,NO)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
C
      CALL RFILE(TPJMAT)
      POINT=1
      DO 10 U=1,NO
         USYM=ORBSYM(U)
         DO 720 IRI=1,NIRRED
         ISYM=IRI-1
         UISYM=IEOR(USYM,ISYM)
         FI=FLOV(IRI,1)
         LI=FLOV(IRI,2)
         DO 20 I=FI,LI
            CALL WREADW(TPJMAT,IDIM,1,POINT,POINT)
            CALL WREADW(TPJMAT,JMAT,INTOWP(IDIM),POINT,POINT)
            ICNTJ=0
            UIX=INO(U)+I
            DO 730 IRJ=1,NIRRED
               JSYM=IRJ-1
               FJ=FLOV(IRJ,1)
               LJ=FLOV(IRJ,2)
               ASYM=IEOR(UISYM,JSYM)+1
               FA=FLOV(ASYM,3)-NO
               LA=FLOV(ASYM,4)-NO
               FK=FLOV(ASYM,1)
               LK=FLOV(ASYM,2)
C
            DO 30 J=FJ,LJ
               DO 40 A=FA,LA
                  FB=FLOV(USYM+1,3)-NO
                  LB=FLOV(USYM+1,4)-NO
                  JAX=INO(A)+J
                  UIJA=EMOFF(JAX)+EMADD(UIX)
       IF(UIJA.GT.LEMAT)WRITE(6,*)'ERROR UIJA ADDE'
                  DO 70 B=FB,LB
                     ZL=ZLX(A,B)
                     JIAB=TOFF(J,I,ZL)+TADD(A,B)
                     EMAT(UIJA)=EMAT(UIJA)+T2(JIAB)*I1MAT(U,B)
   70             CONTINUE
   40          CONTINUE
   30       CONTINUE
  730       CONTINUE
C
            DO 90 K=1,NO
            KSYM=ORBSYM(K)
            BSYM=IEOR(UISYM,KSYM)+1
            FB=FLOV(BSYM,3)-NO
            LB=FLOV(BSYM,4)-NO
               DO 100 B=FB,LB
      ICNTJ=ICNTJ+1
                  DO 110 J=1,NO
                  JSYM=ORBSYM(J)
                  ASYM=IEOR(UISYM,JSYM)+1
                  FA=FLOV(ASYM,3)-NO
                  LA=FLOV(ASYM,4)-NO
                     DO 120 A=FA,LA
                     ZL=ZLX(A,B)
                     JKAB=TOFF(J,K,ZL)+TADD(A,B)
CJ                 EMAT(U,I,J,A)=EMAT(U,I,J,A)+JMAT(B,K,U,I)*T2(JKAB)
                   JAX=INO(A)+J
                   UIJA=EMOFF(JAX)+EMADD(UIX)
       IF(UIJA.GT.LEMAT)WRITE(6,*)'ERROR UIJA ADDE 2'
                   EMAT(UIJA)=EMAT(UIJA)+JMAT(ICNTJ)*T2(JKAB)
  120          CONTINUE
  110       CONTINUE
  100                CONTINUE
   90             CONTINUE
   20    CONTINUE
  720    CONTINUE
   10 CONTINUE
      CALL RCLOSE(TPJMAT,3)
      RETURN
      END
C
C                         ********************
C-------------------------******  INITZ ******-------------------------
C                         ********************
C
      SUBROUTINE INITZ(Z1,Z2,I1MAT,MOINTS,LENINT,EIGVAL,IOFF,NO,NV,
     .              NTRO,NTRV,NO2,NV2,NTR,NBF,JOUT,IFLG,INO,INTRO,INTRV,
     .              NOV,INV,N2OV,FLOV,ORBSYM,NIRRED,
     .                 DOFF,NOFF,DADD,NADD,ZLX,TOFF,TADD,NDIMT2)
      IMPLICIT INTEGER(A-Z)
      REAL*8 Z1(NO,NV),Z2(NDIMT2),I1MAT(NO,NV),MOINTS(LENINT),
     .       EIGVAL(NBF),VAL2N,VAL2D,VAL1N,VAL1D
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER DOFF(NOFF),DADD(NADD),TOFF(NO,NO,2),TADD(NV,NV),ZLX(NV,NV)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
C
      CALL ZERO(Z1,NO*NV)
C
      DO 10 U=1,NO
         USYM=ORBSYM(U)
         DO 20 BE=1,NV
            BESYM=ORBSYM(BE+NO)
            UBESYM=IEOR(USYM,BESYM)
            VAL1N=I1MAT(U,BE)+I1MAT(U,BE)
            VAL1D=1.0D+00
CGES        IF (IFLG.EQ.0) VAL1D=EIGVAL(BE+NO)-EIGVAL(U)
            BEBE=IOFF(BE+NO)+BE+NO
            UU  =IOFF(U)+U
            IF (IFLG.EQ.0) VAL1D=EIGVAL(BEBE)-EIGVAL(UU)
            Z1(U,BE)=-VAL1N/VAL1D
            BEU=INO(BE)+U
            DO 30 GA=1,BE
               GAU=INO(GA)+U
               GASYM=ORBSYM(GA+NO)
               VSYM=IEOR(UBESYM,GASYM)+1
               FV=FLOV(VSYM,1)
               LV=FLOV(VSYM,2)
               DO 40 V=FV,LV
                  BEV=INO(BE)+V
                  GAV=INO(GA)+V
                  BEUGAV=DOFF(MAX0(BEU,GAV))+DADD(MIN0(BEU,GAV))
                  BEVGAU=DOFF(MAX0(BEV,GAU))+DADD(MIN0(BEV,GAU))
                  VAL2N=MOINTS(BEUGAV)+MOINTS(BEUGAV)+MOINTS(BEUGAV)+
     .                MOINTS(BEUGAV)-MOINTS(BEVGAU)-MOINTS(BEVGAU)
                  VAL2D=1.0D+00
            BEBE=IOFF(BE+NO)+BE+NO
            UU  =IOFF(U)+U
            GAGA=IOFF(GA+NO)+GA+NO
            VV  =IOFF(V)+V
                  IF (IFLG.EQ.0)
     .  VAL2D=EIGVAL(BEBE)+EIGVAL(GAGA)-EIGVAL(UU)-EIGVAL(VV)
CGES .             VAL2D=EIGVAL(BE+NO)+EIGVAL(GA+NO)-EIGVAL(U)-EIGVAL(V)
                  UVBEGA=TOFF(U,V,1)+TADD(BE,GA)
                  Z2(UVBEGA)=-VAL2N/VAL2D
   40          CONTINUE
   30       CONTINUE
   20    CONTINUE
   10 CONTINUE
      RETURN
      END
C
C                         ********************
C-------------------------******  T2Z2  ******-------------------------
C                         ********************
C
      SUBROUTINE T2Z2(TZV,TZO,Z2O,T2,NO,NV,NO2,NV2,NTRO,NTRV,NTR,IOFF,
     .                JOUT,INO,INTRO,INTRV,NOV,INV,N2OV,ZLX,UOFF,
     .                FLOV,ORBSYM,NIRRED,
     .                TOFF,TADD,NDIMT2)
      IMPLICIT INTEGER(A-Z)
      REAL*8 Z2O(NDIMT2),TZV(NV,NV),TZO(NO,NO),T2(NDIMT2),VALO,VALV
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV),
     .        ZLX(NV,NV),UOFF(NO,NO,2),
     .        FLOV(NIRRED,4),ORBSYM(NO+NV)
C
      CALL ZERO(TZO,NO2)
      CALL ZERO(TZV,NV2)
      DO 10 I=1,NO
      ISYM=ORBSYM(I)
         DO 20 J=1,NO
            JSYM=ORBSYM(J)
            IJSYM=IEOR(ISYM,JSYM)
            DO 30 C=1,NV
            CSYM=ORBSYM(C+NO)
            ASYM=IEOR(IJSYM,CSYM)+1
            FA=FLOV(ASYM,3)-NO
            LA=FLOV(ASYM,4)-NO
               DO 40 A=FA,LA
                  ZLA=ZLX(A,C)
                  IJAC=TOFF(I,J,ZLA)+TADD(A,C)
                  DO 50 B=FA,LA
                     ZLB=ZLX(B,C)
                     IJBC=TOFF(I,J,ZLB)+TADD(B,C)
                     VALV=T2(IJAC)*Z2O(IJBC)
                     TZV(A,B)=TZV(A,B)+VALV
   50             CONTINUE
   40          CONTINUE
   30       CONTINUE
   20    CONTINUE
   10 CONTINUE
C     WRITE (JOUT,6047)
 6047 FORMAT(//,2X,' ******   TZV MATRIX   ******')
C     CALL MATOUT(TZV,NV,NV,NV,NV,JOUT)
C
      DO 12 A=1,NV
      ASYM=ORBSYM(A+NO)
         DO 22 B=1,NV
         BSYM=ORBSYM(B+NO)
         ZL=ZLX(A,B)
         ABSYM=IEOR(ASYM,BSYM)
            DO 32 K=1,NO
            KSYM=ORBSYM(K)
            ISYM=IEOR(KSYM,ABSYM)+1
            FI=FLOV(ISYM,1)
            LI=FLOV(ISYM,2)
                DO 42 I=FI,LI
                DO 52 J=FI,LI
                     IKAB=TOFF(I,K,ZL)+TADD(A,B)
                     JKAB=TOFF(J,K,ZL)+TADD(A,B)
                     VALO=T2(IKAB)*Z2O(JKAB)
                     TZO(I,J)=TZO(I,J)+VALO
   52             CONTINUE
   42          CONTINUE
   32       CONTINUE
   22    CONTINUE
   12 CONTINUE
 6048 FORMAT(//,2X,' ******   TZO MATRIX   ******')
C     WRITE (JOUT,6048)
C     CALL MATOUT(TZO,NO,NO,NO,NO,JOUT)
C
      RETURN
      END
C
C                         *********************
C-------------------------******  RQTERM  *****-------------------------
C                         *********************
C
      SUBROUTINE RQTERM(Z1,Z2,Z1O,Z2O,RMAT,QMAT,IOFF,NO,NV,NO2,NV2,NTRO,
     .                  NTRV,NTR,JOUT,INO,INTRO,INTRV,NOV,INV,N2OV,ZLX,
     .                  UOFF,FLOV,ORBSYM,NIRRED,SUX1,SUX2,AR1,AR2,
     .                  TOFF,TADD,NDIMT2)
      IMPLICIT INTEGER(A-Z)
      COMMON/NEWPAR/NAB(8),NAI(8),NIJ(8),MAXOO,MAXVV,MAXOV
      REAL*8 Z2O(NDIMT2),Z2(NDIMT2),Z1(NO,NV),Z1O(NO,NV),
     .       RMAT(NV*NO),QMAT(NO*NV),VAL1,VAL2
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER ZLX(NV,NV),UOFF(NO,NO,2)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
      REAL*8 SUX1(NV*NV),SUX2(NV*NV),AR1(MAXOV,MAXOV),AR2(MAXOV,MAXOV)
C
      CALL RFILE(TPRMAT)
      CALL RFILE(TPQMAT)
      POINTR=1
      POINTQ=1
      DO 16695 TSYM=1,NIRRED
      IDIM=NAI(TSYM)
      XVG=0
      DO 16790 GA=1,NV
C     IF(FZV(GA).EQ.1)GO TO 16790
      GASYM=ORBSYM(GA+NO)
      DO 16770 V=1,NO
C     IF(FZO(V).EQ.1)GO TO 16770
      VSYM=ORBSYM(V)
      VGASYM=IEOR(VSYM,GASYM)
      IF(VGASYM.NE.TSYM-1)GO TO 16770
      XVG=XVG+1
      XAI=0
      DO 16750 A=1,NV
C     IF(FZV(A).EQ.1)GO TO 16750
      ASYM=ORBSYM(A+NO)
      ISYM=IEOR(ASYM,VGASYM)+1
      ZL=ZLX(GA,A)
      FI=FLOV(ISYM,1)
      LI=FLOV(ISYM,2)
      DO 16730 I=FI,LI
      XAI=XAI+1
      IVGAA=TOFF(I,V,ZL)+TADD(GA,A)
      VIGAA=TOFF(V,I,ZL)+TADD(GA,A)
      AR1(XAI,XVG)=Z2O(IVGAA)+Z2O(IVGAA)+Z2O(VIGAA)
      AR2(XAI,XVG)=Z2O(VIGAA)
16730 CONTINUE
16750 CONTINUE
16770 CONTINUE
16790 CONTINUE
      LIM=XVG
C
      DO 16690 BE=1,NV
C     IF(FZV(BE).EQ.1)GO TO 16690
      BESYM=ORBSYM(BE+NO)
      DO 16680 U=1,NO
C     IF(FZO(U).EQ.1)GO TO 16680
      USYM=ORBSYM(U)
      BEUSYM=IEOR(BESYM,USYM)
      IF(BEUSYM.NE.TSYM-1)GO TO 16680
      CALL WREADW(TPRMAT,RMAT,INTOWP(IDIM),POINTR,POINTR)
      CALL WREADW(TPQMAT,QMAT,INTOWP(IDIM),POINTQ,POINTQ)
      ICNT2=0
C
      DO 15661 VGA=1,LIM
      VAL1=0.0D0
      VAL2=0.0D0
      DO 15391 AI=1,LIM
      VAL1=VAL1+RMAT(AI)*AR1(AI,VGA)
      VAL2=VAL2+QMAT(AI)*AR2(AI,VGA)
15391 CONTINUE
      SUX1(VGA)= 0.5D0*VAL1
      SUX2(VGA)= 0.5D0*VAL2
15661 CONTINUE
C
      VGA=0
      DO 15660 GA=1,NV
C     IF(FZV(GA).EQ.1)GO TO 15660
      GASYM=ORBSYM(GA+NO)
      VSYM=IEOR(GASYM,BEUSYM)+1
      FV=FLOV(VSYM,1)
      LV=FLOV(VSYM,2)
      DO 15410  V=FV,LV
      VGA=VGA+1
 
C
      IF(BE.GE.GA)THEN
      UVBEGA=TOFF(U,V,1)+TADD(BE,GA)
      VUBEGA=TOFF(V,U,1)+TADD(BE,GA)
      Z2(UVBEGA)=Z2(UVBEGA)-SUX2(VGA)-SUX2(VGA)
      Z2(VUBEGA)=Z2(VUBEGA)+SUX2(VGA)+SUX1(VGA)
      ENDIF
      IF(BE.LE.GA)THEN
      UVGABE=TOFF(U,V,1)+TADD(GA,BE)
      VUGABE=TOFF(V,U,1)+TADD(GA,BE)
      Z2(VUGABE)=Z2(VUGABE)-SUX2(VGA)-SUX2(VGA)
      Z2(UVGABE)=Z2(UVGABE)+SUX2(VGA)+SUX1(VGA)
      ENDIF
15410 CONTINUE
C
15660 CONTINUE
            DO 90 GA=1,NV
            GASYM=ORBSYM(GA+NO)
            VSYM=IEOR(GASYM,BEUSYM)+1
            FV=FLOV(VSYM,1)
            LV=FLOV(VSYM,2)
               DO 100 V=FV,LV
          ICNT2=ICNT2+1
                  VAL1=QMAT(ICNT2)*Z1O(V,GA)
                  Z1(U,BE)=Z1(U,BE)-VAL1
  100          CONTINUE
   90       CONTINUE
  110          CONTINUE
   20    CONTINUE
   10 CONTINUE
16680 CONTINUE
16690 CONTINUE
16695 CONTINUE
      CALL RCLOSE(TPRMAT,3)
      CALL RCLOSE(TPQMAT,3)
C
      RETURN
      END
C
C                         *********************
C-------------------------******  HJTERM  *****-------------------------
C                         *********************
C
      SUBROUTINE HJTERM(Z1,Z2,Z1O,TZO,TZV,HMAT,JMAT,NO,NV,NO2,NV2,NTRO,
     .                  NTRV,NTR,IOFF,JOUT,FOCK,INO,INTRO,INTRV,NOV,INV,
     .                  N2OV,FLOV,ORBSYM,NIRRED,
     .                  ZLX,TOFF,TADD,NDIMT2)
      IMPLICIT INTEGER(A-Z)
      REAL*8 Z2(NDIMT2  ),Z1(NO,NV),Z1O(NO,NV),TZO(NO,NO),TZV(NV,NV),
     .       HMAT(NV*NV),JMAT(NV*NO),FOCK(NTR),VAL
C    .       HMAT(NV*NV),JMAT(NV,NO,NO,NO),FOCK(NTR),VAL
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER ZLX(NV,NV),TOFF(NO,NO,2),TADD(NV,NV)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
C
      CALL RFILE(TPHMAT)
      POINT=1
      DO 10 U=1,NO
      USYM=ORBSYM(U)
         DO 20 BE=1,NV
         BESYM=ORBSYM(BE+NO)
         UBESYM=IEOR(USYM,BESYM)
      CALL WREADW(TPHMAT,IDIM,1,POINT,POINT)
      CALL WREADW(TPHMAT,HMAT,INTOWP(IDIM),POINT,POINT)
      ICNT1=0
      ICNT2=0
         IF (USYM.NE.BESYM) GO TO 31
            DO 30 I=1,NO
               IBE=IOFF(BE+NO)+I
               Z1(U,BE)=Z1(U,BE)+FOCK(IBE)*TZO(I,U)
   30       CONTINUE
   31       CONTINUE
            DO 50 A=1,NV
            ASYM=ORBSYM(A+NO)
               UA=IOFF(A+NO)+U
               Z1(U,BE)=Z1(U,BE)+FOCK(UA)*TZV(A,BE)
            BSYM=IEOR(UBESYM,ASYM)+1
            FB=FLOV(BSYM,3)-NO
            LB=FLOV(BSYM,4)-NO
               DO 60 B=FB,LB
       ICNT1=ICNT1+1
                  Z1(U,BE)=Z1(U,BE)+HMAT(ICNT1   )*TZV(A,B)
CH                Z1(U,BE)=Z1(U,BE)+HMAT(U,BE,A,B)*TZV(A,B)
   60          CONTINUE
   50       CONTINUE
C
            UBE=IOFF(BE+NO)+U
            FI=FLOV(BESYM+1,1)
            LI=FLOV(BESYM+1,2)
               DO 80 GA=1,BE-1
               GASYM=ORBSYM(GA+NO)
CGES  UGA=IOFF(GA+NO)+U
CGES  VGA=IOFF(GA+NO)+V
            VSYM=IEOR(UBESYM,GASYM)+1
            FV=FLOV(VSYM,1)
            LV=FLOV(VSYM,2)
            FA=FLOV(VSYM,3)-NO
            LA=FLOV(VSYM,4)-NO
            DO 70 V=FV,LV
            VBE=IOFF(BE+NO)+V
            UVBEGA=TOFF(U,V,1)+TADD(BE,GA)
            Z2(UVBEGA)=Z2(UVBEGA)
     .      -2.D0*FOCK(UBE)*Z1O(V,GA)+FOCK(VBE)*Z1O(U,GA)
CGES .      -2.D0*FOCK(VGA)*Z1O(U,BE)+FOCK(UGA)*Z1O(V,BE)
CJ                DO 100 I=FI,LI
   70       CONTINUE
                  DO 90 A=FA,LA
       ICNT2=ICNT2+1
                  DO 89 V=FV,LV
            UVBEGA=TOFF(U,V,1)+TADD(BE,GA)
                  Z2(UVBEGA)=Z2(UVBEGA)
     .                          +HMAT(ICNT2    )*Z1O(V,A)
CH   .                          +HMAT(U,BE,GA,A)*Z1O(V,A)
CGES              Z2(UV,BEGA)=Z2(UV,BEGA)+HMAT(V,GA,BE,A)*Z1O(U,A)
CGES .                        +HMAT(U,BE,GA,A)*Z1O(V,A)
   89             CONTINUE
   90             CONTINUE
   80             CONTINUE
C
C      GO FOR GA=BE
C
               GA=BE
               GASYM=ORBSYM(GA+NO)
            VSYM=IEOR(UBESYM,GASYM)+1
            FV=FLOV(VSYM,1)
            LV=FLOV(VSYM,2)
            FA=FLOV(VSYM,3)-NO
            LA=FLOV(VSYM,4)-NO
            DO 75 V=FV,LV
            VBE=IOFF(BE+NO)+V
            VAL=  -2.D0*FOCK(UBE)*Z1O(V,GA)+FOCK(VBE)*Z1O(U,GA)
            UVBEGA=TOFF(U,V,1)+TADD(BE,GA)
            VUBEGA=TOFF(V,U,1)+TADD(BE,GA)
            Z2(UVBEGA)=Z2(UVBEGA)+VAL
            Z2(VUBEGA)=Z2(VUBEGA)+VAL
   75       CONTINUE
                  DO 95 A=FA,LA
       ICNT2=ICNT2+1
                  DO 85 V=FV,LV
                  VAL=HMAT(ICNT2    )*Z1O(V,A)
CH                VAL=HMAT(U,BE,GA,A)*Z1O(V,A)
            UVBEGA=TOFF(U,V,1)+TADD(BE,GA)
            VUBEGA=TOFF(V,U,1)+TADD(BE,GA)
                  Z2(UVBEGA)=Z2(UVBEGA)+VAL
                  Z2(VUBEGA)=Z2(VUBEGA)+VAL
   85             CONTINUE
   95             CONTINUE
C
            DO 81 GA=BE+1,NV
            GASYM=ORBSYM(GA+NO)
            VSYM=IEOR(UBESYM,GASYM)+1
            FV=FLOV(VSYM,1)
            LV=FLOV(VSYM,2)
            FA=FLOV(VSYM,3)-NO
            LA=FLOV(VSYM,4)-NO
            DO 71 V=FV,LV
            VBE=IOFF(BE+NO)+V
            VUGABE=TOFF(V,U,1)+TADD(GA,BE)
            Z2(VUGABE)=Z2(VUGABE)
     .                -2.D0*FOCK(UBE)*Z1O(V,GA)+FOCK(VBE)*Z1O(U,GA)
   71       CONTINUE
                  DO 91 A=FA,LA
       ICNT2=ICNT2+1
                  DO 72 V=FV,LV
            VUGABE=TOFF(V,U,1)+TADD(GA,BE)
                  Z2(VUGABE)=Z2(VUGABE)+HMAT(ICNT2    )*Z1O(V,A)
CH                Z2(VU,GABE)=Z2(VU,GABE)+HMAT(U,BE,GA,A)*Z1O(V,A)
   72             CONTINUE
   91             CONTINUE
   81          CONTINUE
   20    CONTINUE
   10 CONTINUE
      CALL RCLOSE(TPHMAT,3)
C
C
      CALL RFILE(TPJMAT)
      POINT=1
      DO 300 V=1,NO
      VSYM=ORBSYM(V)
      DO 310 I=1,NO
      ISYM=ORBSYM(I)
      VISYM=IEOR(VSYM,ISYM)
      CALL WREADW(TPJMAT,IDIM,1,POINT,POINT)
      CALL WREADW(TPJMAT,JMAT,INTOWP(IDIM),POINT,POINT)
      ICNT=0
      DO 270 U=1,NO
      USYM=ORBSYM(U)
         BESYM=IEOR(VISYM,USYM)+1
         FBE=FLOV(BESYM,3)-NO
         LBE=FLOV(BESYM,4)-NO
         DO 320 BE=FBE,LBE
      ICNT=ICNT+1
C
C              Z1(U,BE)=Z1(U,BE)+JMAT(BE,U,I,J)*TZO(I,J)
         Z1(U,BE)=Z1(U,BE)+JMAT(ICNT    )*TZO(V,I)
C        Z1(U,BE)=Z1(U,BE)+JMAT(BE,U,V,I)*TZO(V,I)
           FGA=FLOV(ISYM+1,3)-NO
           LGA=FLOV(ISYM+1,4)-NO
           FGA2=FGA
           LGA2=LGA
           IF(LGA.GT.BE)LGA2=BE
           DO 280 GA=FGA,LGA2
           UVBEGA=TOFF(U,V,1)+TADD(BE,GA)
           Z2(UVBEGA)=Z2(UVBEGA)+JMAT(ICNT    )*Z1O(I,GA)
  280      CONTINUE
           IF(FGA.LT.BE)FGA2=BE
           DO 281 GA=FGA2,LGA
           VUGABE=TOFF(V,U,1)+TADD(GA,BE)
           Z2(VUGABE)=Z2(VUGABE)+JMAT(ICNT)*Z1O(I,GA)
  281      CONTINUE
C
  320    CONTINUE
  270 CONTINUE
  310 CONTINUE
  300 CONTINUE
      CALL RCLOSE(TPJMAT,3)
      RETURN
      END
C
C                         *********************
C-------------------------******  ABTERM  *****-------------------------
C                         *********************
C
      SUBROUTINE ABTERM(Z2,Z2O,AMAT,BMAT,NO,NV,NO2,NV2,NTRO,NTRV,NTR,
     .                  IOFF,JOUT,INO,INTRO,INTRV,NOV,INV,N2OV,ZLX,UOFF,
     .                  ZLXO,UOFFV,FLOV,ORBSYM,NIRRED,Z1,T1,
     .                  AR3,AR4,AR5,AR6,ABIN,SFV,SUX1,SUX2,SUX3,
     .                  TOFF,TADD,NDIMT2)
      IMPLICIT INTEGER(A-Z)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
      COMMON/NEWPAR/NAB(8),NAI(8),NIJ(8),MAXOO,MAXVV,MAXOV
      REAL*8 Z2(NDIMT2  ),Z2O(NDIMT2  ),AMAT(NO*NO),BMAT(NV2),VAL,
     .       Z1(NO,NV),T1(NO,NV)
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER ZLX(NV,NV),UOFF(NO,NO,2)
      INTEGER ZLXO(NO,NO),UOFFV(NV,NV,2)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
      REAL*8 AR3(MAXVV,MAXOO),AR4(MAXVV,MAXOO),ABIN(NV,NV),
     .       AR5(MAXOO,MAXVV),AR6(MAXOO,MAXVV),
     .       SFV(NV*NV),SUX3(NV*NV),SUX1(NO*NO),SUX2(NO*NO),
     .       TMP,TMV,VAL1,VAL2
C
C     A TERM
C
      CALL RFILE(TPAMAT)
      POINT=1
      DO 12392 TSYM=1,NIRRED
      XAB=0
      DO 33590 A=1,NV
C     IF(FZV(A).EQ.1)GO TO 33590
      ASYM=ORBSYM(A+NO)
      DO 33580 B=1,A
C     IF(FZV(B).EQ.1)GO TO 33580
      BSYM=ORBSYM(B+NO)
      ABSYM=IEOR(ASYM,BSYM)
      IF(ABSYM.NE.TSYM-1)GO TO 33580
C     AB=IOFF(A)+B
      XAB=XAB+1
      XIJ=0
      DO 33570 I=1,NO
C     IF(FZO(I).EQ.1)GO TO 33570
      ISYM=ORBSYM(I)
      JSYM=IEOR(ISYM,ABSYM)+1
      FJ=FLOV(JSYM,1)
      LJ=FLOV(JSYM,2)
      IF(LJ.GT.I)LJ=I
      DO 33560 J=FJ,LJ
      XIJ=XIJ+1
      IJAB=TOFF(I,J,1)+TADD(A,B)
      JIAB=TOFF(J,I,1)+TADD(A,B)
      VAL1=Z2O(IJAB)
      VAL2=Z2O(JIAB)
      AR5(XIJ,XAB)=VAL1+VAL2
      AR6(XIJ,XAB)=VAL1-VAL2
33560 CONTINUE
33570 CONTINUE
33580 CONTINUE
33590 CONTINUE
      LIMO=XIJ
      LIMV=XAB
C
      DO 12391 U=1,NO
C     IF(FZO(U).EQ.1)GO TO 12391
      USYM=ORBSYM(U)
      DO 12381 V=1,U
C     IF(FZO(V).EQ.1)GO TO 12381
      VSYM=ORBSYM(V)
      VUSYM=IEOR(VSYM,USYM)
      IF(VUSYM.NE.TSYM-1)GO TO 12381
C
        IDIM=NIJ(TSYM)
        CALL WREADW(TPAMAT,AMAT,INTOWP(IDIM),POINT,POINT)
        NADD=0
        DO 15925 I=1,NO
C         IF(FZO(I).EQ.1)GO TO 15925
          ISYM=ORBSYM(I)
          JSYM=IEOR(ISYM,VUSYM)
          FJ=FLOV(JSYM+1,1)
          LJ=FLOV(JSYM+1,2)
          DO 15920 J=FJ,LJ
             NADD=NADD+1
             ABIN(I,J)=AMAT(NADD)
15920        CONTINUE
15925     CONTINUE
C
          XJI=0
          DO 15025 I=1,NO
C         IF(FZO(I).EQ.1)GO TO 15025
          ISYM=ORBSYM(I)
          JSYM=IEOR(ISYM,VUSYM)
          FJ=FLOV(JSYM+1,1)
          LJ=FLOV(JSYM+1,2)
          IF(LJ.GT. I)LJ = I
             DO 15020 J=FJ,LJ
             XJI=XJI+1
             TMP=ABIN(I,J)+ABIN(J,I)
             TMV=ABIN(I,J)-ABIN(J,I)
            SUX1(XJI)= TMP*0.5D0
            SUX2(XJI)= TMV*0.5D0
15020        CONTINUE
             IF(ISYM.EQ.JSYM)SUX1(XJI)=SUX1(XJI)*0.5D0
15025 CONTINUE
      DO 14370 BEGA=1,LIMV
      TMP=0.0D0
      TMV=0.0D0
      DO 14350 IJ=1,LIMO
      TMP=TMP+SUX1(IJ)* AR5(IJ,BEGA)
      TMV=TMV+SUX2(IJ)* AR6(IJ,BEGA)
14350 CONTINUE
      SUX3(BEGA)=TMP
       SFV(BEGA)=TMV
14370 CONTINUE
C
      BEGA=0
      DO 52374 BE=1,NV
C     IF(FZV(BE).EQ.1)GO TO 52374
      BESYM=ORBSYM(BE+NO)
      GASYM=IEOR(BESYM,VUSYM)+1
      FGA=FLOV(GASYM,3)-NO
      LGA=FLOV(GASYM,4)-NO
      IF(LGA.GT.BE)LGA=BE
      DO 52364 GA=FGA,LGA
      BEGA=BEGA+1
      UVBEGA=TOFF(U,V,1)+TADD(BE,GA)
      VUBEGA=TOFF(V,U,1)+TADD(BE,GA)
 
      VAL1=SUX3(BEGA)+SFV(BEGA)
      VAL2=SUX3(BEGA)-SFV(BEGA)
           Z2(UVBEGA)=Z2(UVBEGA)+VAL1
           IF(BE.EQ.GA)VAL1=VAL1*0.5D0
           Z1(U,BE)=Z1(U,BE)+VAL1*T1(V,GA)
           Z1(V,GA)=Z1(V,GA)+VAL1*T1(U,BE)
      IF(U.NE.V)THEN
           Z2(VUBEGA)=Z2(VUBEGA)+VAL2
           IF(BE.EQ.GA)VAL2=VAL2*0.5D0
           Z1(V,BE)=Z1(V,BE)+VAL2*T1(U,GA)
           Z1(U,GA)=Z1(U,GA)+VAL2*T1(V,BE)
      ENDIF
52364 CONTINUE
52374 CONTINUE
C
12381 CONTINUE
12391 CONTINUE
12392 CONTINUE
      CALL RCLOSE(TPAMAT,3)
C
C     B TERM
C
      CALL RFILE(TPBMAT)
      POINT=1
      DO 14092 TSYM=1,NIRRED
C
      XAB=0
      DO 19490 A=1,NV
C     IF(FZV(A).EQ.1)GO TO 19490
      ASYM=ORBSYM(A+NO)
      DO 19480 B=1,A
C     IF(FZV(B).EQ.1)GO TO 19480
      BSYM=ORBSYM(B+NO)
      BASYM=IEOR(BSYM,ASYM)
      IF(BASYM.NE.TSYM-1)GO TO 19480
C     AB=IOFF(A)+B
      XAB=XAB+1
      XIJ=0
      DO 19470 I=1,NO
C     IF(FZO(I).EQ.1)GO TO 19470
      ISYM=ORBSYM(I)
      JSYM=IEOR(ISYM,BASYM)+1
      FJ=FLOV(JSYM,1)
      LJ=FLOV(JSYM,2)
      IF(LJ.GT.I)LJ=I
      DO 19460 J=FJ,LJ
      XIJ=XIJ+1
      IJAB=TOFF(I,J,1)+TADD(A,B)
      JIAB=TOFF(J,I,1)+TADD(A,B)
      VAL1=Z2O(IJAB)
      VAL2=Z2O(JIAB)
      AR3(XAB,XIJ)=VAL1+VAL2
      AR4(XAB,XIJ)=VAL1-VAL2
19460 CONTINUE
19470 CONTINUE
19480 CONTINUE
19490 CONTINUE
      LIMO=XIJ
      LIMV=XAB
C
      DO 14091 BE=1,NV
C     IF(FZV(BE).EQ.1)GO TO 14091
      BESYM=ORBSYM(BE+NO)
      DO 14081 GA=1,BE
C     IF(FZV(GA).EQ.1)GO TO 14081
      GASYM=ORBSYM(GA+NO)
      BEGAS=IEOR(GASYM,BESYM)
      IF(BEGAS.NE.TSYM-1)GO TO 14081
C
        IDIM=NAB(TSYM)
        CALL WREADW(TPBMAT,BMAT,INTOWP(IDIM),POINT,POINT)
        NADD=0
        DO 14925 A=1,NV
C         IF(FZV(A).EQ.1)GO TO 14925
          ASYM=ORBSYM(A+NO)
          BSYM=IEOR(ASYM,BEGAS)
          FB=FLOV(BSYM+1,3)-NO
          LB=FLOV(BSYM+1,4)-NO
          DO 14920 B=FB,LB
             NADD=NADD+1
             ABIN(A,B)=BMAT(NADD)
14920        CONTINUE
14925     CONTINUE
C
          XBA=0
          DO 14025 A=1,NV
C         IF(FZV(A).EQ.1)GO TO 14025
          ASYM=ORBSYM(A+NO)
          BSYM=IEOR(ASYM,BEGAS)
          FB=FLOV(BSYM+1,3)-NO
          LB=FLOV(BSYM+1,4)-NO
          IF(LB.GT. A)LB = A
             DO 14020 B=FB,LB
             XBA=XBA+1
             TMP=ABIN(A,B)+ABIN(B,A)
             TMV=ABIN(A,B)-ABIN(B,A)
             SFV(XBA)= TMP*0.5D0
            SUX3(XBA)= TMV*0.5D0
14020        CONTINUE
             IF(ASYM.EQ.BSYM)SFV(XBA)=SFV(XBA)*0.5D0
14025 CONTINUE
      DO 14077 UV=1,LIMO
      TMP = 0.0D0
      TMV = 0.0D0
      DO 14029 AB=1,LIMV
      TMP=TMP+ SFV(AB)* AR3(AB,UV)
      TMV=TMV+SUX3(AB)* AR4(AB,UV)
14029 CONTINUE
      SUX1(UV)=TMP
      SUX2(UV)=TMV
14077 CONTINUE
C
      BEGA=IOFF(BE)+GA
      UV=0
      DO 14068 U=1,NO
C     IF(FZO(U).EQ.1)GO TO 14068
      USYM=ORBSYM(U)
      VSYM=IEOR(USYM,BEGAS)+1
      SV=FLOV(VSYM,1)
      LV=FLOV(VSYM,2)
      IF(LV.GT.U )LV=U
      DO 14063 V=SV,LV
      UV=UV+1
      VAL1=SUX1(UV)+SUX2(UV)
      VAL2=SUX1(UV)-SUX2(UV)
      UVBEGA=TOFF(U,V,1)+TADD(BE,GA)
      Z2(UVBEGA)=Z2(UVBEGA)+VAL1
                  IF(BE.EQ.GA)VAL1=VAL1*0.5D0
                  Z1(U,BE)=Z1(U,BE)+VAL1*T1(V,GA)
                  Z1(V,GA)=Z1(V,GA)+VAL1*T1(U,BE)
      IF(U.NE.V)THEN
      VUBEGA=TOFF(V,U,1)+TADD(BE,GA)
      Z2(VUBEGA)=Z2(VUBEGA)+VAL2
                  IF(BE.EQ.GA)VAL2=VAL2*0.5D0
                  Z1(V,BE)=Z1(V,BE)+VAL2*T1(U,GA)
                  Z1(U,GA)=Z1(U,GA)+VAL2*T1(V,BE)
      ENDIF
C
14063 CONTINUE
14068 CONTINUE
14081 CONTINUE
14091 CONTINUE
14092 CONTINUE
      CALL RCLOSE(TPBMAT,3)
C
      RETURN
      END
C
C                         *********************
C-------------------------******  ETERM   *****-------------------------
C                         *********************
C
      SUBROUTINE ETERM(Z1,Z2O,EMAT,NO,NV,NO2,NV2,NTRO,NTRV,NTR,IOFF,
     .                 JOUT,INO,INTRO,INTRV,NOV,INV,N2OV,ZLX,UOFF,
     .                 FLOV,ORBSYM,NIRRED,TOFF,TADD,NDIMT2,
     .                 EMOFF,EMADD,LEMAT)
      IMPLICIT INTEGER(A-Z)
      REAL*8 Z1(NO,NV),Z2O(NDIMT2),EMAT(LEMAT)
      INTEGER IOFF(NTR),EMOFF(NO*NV),EMADD(NO*NO)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER ZLX(NV,NV),UOFF(NO,NO,2)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV)
      INTEGER FLOV(NIRRED,4),ORBSYM(NO+NV)
C
      DO 10 U=1,NO
      USYM=ORBSYM(U)
         DO 20 BE=1,NV
            BESYM=ORBSYM(BE+NO)
            IF(USYM.NE.BESYM)GO TO 20
            DO 30 I=1,NO
               UIX=INO(U)+I
            ISYM=ORBSYM(I)
            IUSYM=IEOR(ISYM,USYM)
               DO 40 J=1,NO
               JSYM=ORBSYM(J)
               ASYM=IEOR(IUSYM,JSYM)+1
               FA=FLOV(ASYM,3)-NO
               LA=FLOV(ASYM,4)-NO
                  DO 50 A=FA,LA
                     ZL=ZLX(BE,A)
                     IJBEA=TOFF(I,J,ZL)+TADD(BE,A)
                     JAX=INO(A)+J
                     UIJA=EMOFF(JAX)+EMADD(UIX)
       IF(UIJA.GT.LEMAT)WRITE(6,*)'ERROR UIJA ETERM'
                     Z1(U,BE)=Z1(U,BE)+EMAT(UIJA)*Z2O(IJBEA)
   50             CONTINUE
   40          CONTINUE
   30       CONTINUE
   20    CONTINUE
   10 CONTINUE
C
      RETURN
      END
C
C                         *********************
C-------------------------******  FTERM   *****-------------------------
C                         *********************
C
      SUBROUTINE FTERM(Z1,Z2O,FMAT,NO,NV,NO2,NV2,NTRO,NTRV,NTR,IOFF,
     .                 JOUT,INO,INTRO,INTRV,NOV,INV,N2OV,ZLX,UOFF,
     .                 FLOV,ORBSYM,NIRRED,TOFF,TADD,NDIMT2)
      IMPLICIT INTEGER(A-Z)
      REAL*8 Z1(NO,NV),Z2O(NDIMT2  ),FMAT(NV*NV)
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER ZLX(NV,NV),UOFF(NO,NO,2)
      INTEGER FLOV(NIRRED,4),ORBSYM(NO+NV)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV)
      COMMON/TAPES/TPBMAT,TPFMAT,TPHMAT,TPRMAT,TPQMAT,TPJMAT,ITAP71,
     .             TPAMAT
C
      CALL RFILE(TPFMAT)
      POINT=1
      DO 9 TSYM =1,NIRRED
      DO 10 BE=1,NV
      BESYM=ORBSYM(BE+NO)
            DO 20 A=1,NV
            ASYM=ORBSYM(A+NO)
            BEASYM=IEOR(BESYM,ASYM)
            IF(BEASYM.NE.TSYM-1)GO TO 20
      CALL WREADW(TPFMAT,IDIM,1,POINT,POINT)
      CALL WREADW(TPFMAT,FMAT,INTOWP(IDIM),POINT,POINT)
      ICNT=0
               DO 30 B=1,NV
               BSYM=ORBSYM(B+NO)
               ISYM=IEOR(BEASYM,BSYM)+1
               FI=FLOV(ISYM,1)
               LI=FLOV(ISYM,2)
                  ZL=ZLX(A,B)
                  DO 40 I=FI,LI
                  ICNT=ICNT+1
                     DO 50 U=1,NO
                     USYM=ORBSYM(U)
                     IF(USYM.NE.BESYM)GO TO 50
                     UIAB=TOFF(U,I,ZL)+TADD(A,B)
                     Z1(U,BE)=Z1(U,BE)+FMAT(ICNT)*Z2O(UIAB)
CF                   Z1(U,BE)=Z1(U,BE)+FMAT(BE,A,B,I)*Z2O(UI,AB)
   50             CONTINUE
   40          CONTINUE
   30       CONTINUE
   20    CONTINUE
   10 CONTINUE
    9 CONTINUE
C
      CALL RCLOSE(TPFMAT,3)
      RETURN
      END
C
C                         *********************
C-------------------------******  MTERM   *****-------------------------
C                         *********************
C
      SUBROUTINE MTERM(Z2,TZO,TZV,NO,NV,NO2,NV2,NTRO,NTRV,NTR,IOFF,
     .                 MOINTS,LENINT,JOUT,INO,INTRO,INTRV,NOV,INV,N2OV,
     .                 FLOV,ORBSYM,NIRRED,
     .                 DOFF,NOFF,DADD,NADD,TOFF,TADD,NDIMT2)
      IMPLICIT INTEGER(A-Z)
      REAL*8 Z2(NDIMT2  ),TZO(NO,NO),TZV(NV,NV),MOINTS(LENINT),VALO,VALV
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER DOFF(NOFF),DADD(NADD)
      INTEGER FLOV(NIRRED,4),ORBSYM(NO+NV)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV)
C
      DO 10 U=1,NO
      USYM=ORBSYM(U)
      FIU=FLOV(USYM+1,1)
      LIU=FLOV(USYM+1,2)
         DO 20 V=1,NO
         VSYM=ORBSYM(V)
         FIV=FLOV(VSYM+1,1)
         LIV=FLOV(VSYM+1,2)
         UVSYM=IEOR(USYM,VSYM)
            DO 30 BE=1,NV
            BESYM=ORBSYM(BE+NO)
            FA=FLOV(BESYM+1,3)-NO
            LA=FLOV(BESYM+1,4)-NO
            BEV=INO(BE)+V
            BEU=INO(BE)+U
            GASYM=IEOR(UVSYM,BESYM)+1
            FGA=FLOV(GASYM,3)-NO
            LGA=FLOV(GASYM,4)-NO
            LGA2=LGA
            IF(LGA.GT.BE)LGA2=BE
               DO 40 GA=FGA,LGA2
               GAV=INO(GA)+V
               GAU=INO(GA)+U
             UVBEGA=TOFF(U,V,1)+TADD(BE,GA)
                  DO 50 A=FA,LA
                  AU=INO(A)+U
                  AV=INO(A)+V
                  GAVAU=DOFF(MAX0(GAV,AU))+DADD(MIN0(GAV,AU))
                  GAUAV=DOFF(MAX0(GAU,AV))+DADD(MIN0(GAU,AV))
                  VALV=(MOINTS(GAVAU)+MOINTS(GAVAU)-MOINTS(GAUAV))*
     .                    TZV(A,BE)
                  Z2(UVBEGA)=Z2(UVBEGA)+VALV
   50             CONTINUE
                  DO 51 A=FGA,LGA
                  AU=INO(A)+U
                  AV=INO(A)+V
                  BEVAU=DOFF(MAX0(BEV,AU))+DADD(MIN0(BEV,AU))
                  BEUAV=DOFF(MAX0(BEU,AV))+DADD(MIN0(BEU,AV))
                  VALV=(MOINTS(BEUAV)+MOINTS(BEUAV)-MOINTS(BEVAU))
     .                    *TZV(A,GA)
                  Z2(UVBEGA)=Z2(UVBEGA)+VALV
   51             CONTINUE
                  DO 60 I=FIU,LIU
                     GAI=INO(GA)+I
                     BEI=INO(BE)+I
                     GAVBEI=DOFF(MAX0(GAV,BEI))+DADD(MIN0(GAV,BEI))
                     GAIBEV=DOFF(MAX0(GAI,BEV))+DADD(MIN0(GAI,BEV))
                     VALO=(MOINTS(GAVBEI)+MOINTS(GAVBEI)-MOINTS(GAIBEV))
     .                    *TZO(I,U)
                     Z2(UVBEGA)=Z2(UVBEGA)+VALO
   60             CONTINUE
                  DO 61 I=FIV,LIV
                     GAI=INO(GA)+I
                     BEI=INO(BE)+I
                     BEUGAI=DOFF(MAX0(BEU,GAI))+DADD(MIN0(BEU,GAI))
                     BEIGAU=DOFF(MAX0(BEI,GAU))+DADD(MIN0(BEI,GAU))
                     VALO=          (MOINTS(BEUGAI)+MOINTS(BEUGAI)-
     .                    MOINTS(BEIGAU))*TZO(I,V)
                     Z2(UVBEGA)=Z2(UVBEGA)+VALO
   61             CONTINUE
   40          CONTINUE
   30       CONTINUE
   20    CONTINUE
   10 CONTINUE
C
      RETURN
      END
C
C                         *********************
C-------------------------******  GTERM   *****-------------------------
C                         *********************
C
      SUBROUTINE GTERM(Z2,Z1,Z1O,Z2O,GOMAT,GVMAT,NO,NV,NO2,NV2,NTRO,NTRV
     .                 ,NTR,IOFF,JOUT,FOCK,T1,INO,INTRO,INTRV,NOV,INV,
     .            N2OV,ZLX,UOFF,FLOV,ORBSYM,NIRRED,TOFF,TADD,NDIMT2)
      IMPLICIT INTEGER(A-Z)
      REAL*8 Z2(NDIMT2  ),Z1(NO,NV),Z2O(NDIMT2  ),Z1O(NO,NV),
     .       GOMAT(NO,NO),GVMAT(NV,NV)
      REAL * 8 FOCK(NTR),VAL,T1(NO,NV)
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER ZLX(NV,NV),UOFF(NO,NO,2)
      INTEGER FLOV(NIRRED,4),ORBSYM(NO+NV)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV)
C
      DO 10 U=1,NO
      USYM=ORBSYM(U)
      FI=FLOV(USYM+1,1)
      LI=FLOV(USYM+1,2)
         DO 20 BE=1,NV
         BESYM=ORBSYM(BE+NO)
         FA2=FLOV(BESYM+1,3)-NO
         LA2=FLOV(BESYM+1,4)-NO
         UBESYM=IEOR(USYM,BESYM)
         UBE=IOFF(BE+NO)+U
         IF(USYM.NE.BESYM) GO TO 21
         Z1(U,BE)=Z1(U,BE)-2.D0*FOCK(UBE)
            DO 30 A=1,NV
            Z1(U,BE)=Z1(U,BE)+GVMAT(A,BE)*Z1O(U,A)
   30       CONTINUE
            DO 40 I=1,NO
            Z1(U,BE)=Z1(U,BE)+GOMAT(U,I)*Z1O(I,BE)
   40       CONTINUE
   21       CONTINUE
            DO 50 GA=1,BE
            GASYM=ORBSYM(GA+NO)
            FA1=FLOV(GASYM+1,3)-NO
            LA1=FLOV(GASYM+1,4)-NO
            VSYM=IEOR(GASYM,UBESYM)+1
            FV=FLOV(VSYM,1)
            LV=FLOV(VSYM,2)
               DO 60 V=FV,LV
               UVBEGA=TOFF(U,V,1)+TADD(BE,GA)
                  DO 70 A=FA1,LA1
                     ZLB=ZLX(BE,A)
                     UVBEA=TOFF(U,V,ZLB)+TADD(BE,A)
                     Z2(UVBEGA)=Z2(UVBEGA)+GVMAT(A,GA)*Z2O(UVBEA)
   70             CONTINUE
                  DO 71 A=FA2,LA2
                     ZLG=ZLX(GA,A)
                     VUGAA=TOFF(V,U,ZLG)+TADD(GA,A)
                     Z2(UVBEGA)=Z2(UVBEGA)+GVMAT(A,BE)*Z2O(VUGAA)
   71             CONTINUE
                  DO 100 I=FV,LV
                     UIBEGA=TOFF(U,I,1)+TADD(BE,GA)
                     Z2(UVBEGA)=Z2(UVBEGA)+GOMAT(V,I)*Z2O(UIBEGA)
  100             CONTINUE
                  DO 101 I=FI,LI
                     IVBEGA=TOFF(I,V,1)+TADD(BE,GA)
                     Z2(UVBEGA)=Z2(UVBEGA)+GOMAT(U,I)*Z2O(IVBEGA)
  101             CONTINUE
   60          CONTINUE
   50       CONTINUE
   20    CONTINUE
   10 CONTINUE
C
      RETURN
      END
C
C                         *********************
C-------------------------******  ITERM   *****-------------------------
C                         *********************
C
      SUBROUTINE ITERM(Z2,Z1O,I1MAT,NO,NV,NO2,NV2,NTRO,NTRV,NTR,IOFF,
     .                 JOUT,INO,INTRO,INTRV,NOV,INV,N2OV,
     .                 ZLX,FLOV,ORBSYM,NIRRED,
     .                 TOFF,TADD,NDIMT2)
      IMPLICIT INTEGER(A-Z)
      REAL*8 Z2(NDIMT2),Z1O(NO,NV),I1MAT(NO,NV)
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER ORBSYM(NO+NV),FLOV(NIRRED,4)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV),ZLX(NV,NV)
C
      DO 10 U=1,NO
         USYM=ORBSYM(U)
         DO 20 V=1,NO
            VSYM=ORBSYM(V)
            UVSYM=IEOR(USYM,VSYM)
            DO 30 BE=1,NV
               BESYM=ORBSYM(BE+NO)
               GASYM=IEOR(BESYM,UVSYM)+1
               FGA=FLOV(GASYM,3)-NO
               LGA=FLOV(GASYM,4)-NO
               IF(LGA.GT.BE)LGA=BE
               DO 40 GA=FGA,LGA
                  UVBEGA=TOFF(U,V,1)+TADD(BE,GA)
                  Z2(UVBEGA)=Z2(UVBEGA)+I1MAT(U,GA)*Z1O(V,BE)+
     .                        I1MAT(V,BE)*Z1O(U,GA)-I1MAT(V,GA)*
     .                        Z1O(U,BE)-I1MAT(V,GA)*Z1O(U,BE)-
     .                        I1MAT(U,BE)*Z1O(V,GA)-I1MAT(U,BE)*
     .                        Z1O(V,GA)
   40          CONTINUE
   30       CONTINUE
   20    CONTINUE
   10 CONTINUE
C
      RETURN
      END
C
C                         *********************
C-------------------------******  NORMZ   *****-------------------------
C                         *********************
C
      SUBROUTINE NORMZ(Z2,Z1,EIGVAL,NO,NV,NBF,NTR,NO2,NTRV,IOFF,JOUT,
     .                 INO,INTRO,INTRV,NOV,INV,N2OV,
     .                 ZLX,FLOV,ORBSYM,NIRRED,
     .                 TOFF,TADD,NDIMT2)
      IMPLICIT INTEGER(A-Z)
      REAL*8 Z2(NDIMT2  ),Z1(NO,NV),EIGVAL(NBF)
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER ORBSYM(NO+NV),FLOV(NIRRED,4)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV),ZLX(NV,NV)
C
      DO 10 U=1,NO
         USYM=ORBSYM(U)
         UU  =IOFF(U)+U
         DO 20 BE=1,NV
            BESYM=ORBSYM(BE+NO)
            UBESYM=IEOR(USYM,BESYM)
            BEBE=IOFF(BE+NO)+BE+NO
            Z1(U,BE)=Z1(U,BE)/(EIGVAL(BEBE)-EIGVAL(UU))
            DO 30 V=1,NO
               VSYM=ORBSYM(V)
               VV  =IOFF(V)+V
               GASYM=IEOR(VSYM,UBESYM)+1
               FGA=FLOV(GASYM,3)-NO
               LGA=FLOV(GASYM,4)-NO
               IF(LGA.GT.BE)LGA=BE
               DO 40 GA=FGA,LGA
                  GAGA=IOFF(GA+NO)+GA+NO
                  UVBEGA=TOFF(U,V,1)+TADD(BE,GA)
                  Z2(UVBEGA)=Z2(UVBEGA)/(EIGVAL(BEBE)+EIGVAL(GAGA)-
     .                        EIGVAL(UU)-EIGVAL(VV))
   40          CONTINUE
   30       CONTINUE
   20    CONTINUE
   10 CONTINUE
C
      RETURN
      END
C
C                         *********************
C-------------------------******  ZDIFF   *****-------------------------
C                         *********************
      SUBROUTINE ZDIFF(Z2,Z1,Z2O,Z1O,DELZ,NO,NV,NTR,NO2,NTRV,IOFF,JOUT,
     .                 INO,INTRO,INTRV,NOV,INV,N2OV,DELZ2,
     .                 ZLX,FLOV,ORBSYM,NIRRED,
     .                 TOFF,TADD,NDIMT2)
      IMPLICIT INTEGER(A-Z)
      REAL*8 Z2(NDIMT2),Z1(NO,NV),Z2O(NDIMT2),Z1O(NO,NV),DELZ,DSQRT
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER ORBSYM(NO+NV),FLOV(NIRRED,4)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV),ZLX(NV,NV)
      REAL*8 DELZ2,VAL1,VAL2
C
      DELZ=0.0D+00
      DELZ2=0.0D+00
      DO 10 U=1,NO
         USYM=ORBSYM(U)
         DO 20 BE=1,NV
            BESYM=ORBSYM(BE+NO)
            UBESYM=IEOR(USYM,BESYM)
            VAL1=(Z1O(U,BE)-Z1(U,BE))*(Z1O(U,BE)-Z1(U,BE))
            DELZ=DELZ+DSQRT(VAL1)
            DELZ2=DELZ2+VAL1
            DO 30 V=1,NO
               VSYM=ORBSYM(V)
               GASYM=IEOR(VSYM,UBESYM)+1
               FGA=FLOV(GASYM,3)-NO
               LGA=FLOV(GASYM,4)-NO
               IF(LGA.GT.BE)LGA=BE
               DO 40 GA=FGA,LGA
                  UVBEGA=TOFF(U,V,1)+TADD(BE,GA)
                  VAL2=
     .   +      (Z2O(UVBEGA)-Z2(UVBEGA))*(Z2O(UVBEGA)-Z2(UVBEGA))
                  DELZ=DELZ+DSQRT(VAL2)
                  DELZ2=DELZ2+VAL2
   40          CONTINUE
   30       CONTINUE
   20    CONTINUE
   10 CONTINUE
      DELZ2=DSQRT(DELZ2)
C
      RETURN
      END
C
C
C                         *********************
C-------------------------******   NEWZ  ******-------------------------
C                         *********************
C
      SUBROUTINE NEWZ(Z2,Z1,Z2O,Z1O,NO,NV,NTR,NO2,NTRV,IOFF,JOUT,INO,
     .                INTRO,INTRV,NOV,INV,N2OV,
     .                ORBSYM,FLOV,NIRRED,ZLX,TOFF,TADD,NDIMT2)
      IMPLICIT INTEGER(A-Z)
      REAL*8 Z2(NDIMT2  ),Z1(NO,NV),Z2O(NDIMT2  ),Z1O(NO,NV)
      INTEGER IOFF(NTR)
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NOV)
      INTEGER ORBSYM(NO+NV),FLOV(NIRRED,4),
     .        TOFF(NO,NO,2),TADD(NV,NV),ZLX(NV,NV)
C
      DO 10 U=1,NO
         USYM=ORBSYM(U)
         DO 20 BE=1,NV
            BESYM=ORBSYM(BE+NO)
            UBESYM=IEOR(USYM,BESYM)
            Z1O(U,BE)=Z1(U,BE)
            DO 30 V=1,NO
               VSYM=ORBSYM(V)
               GASYM=IEOR(VSYM,UBESYM)+1
               FGA=FLOV(GASYM,3)-NO
               LGA=FLOV(GASYM,4)-NO
               IF(LGA.GT.BE)LGA=BE
               DO 40 GA=FGA,LGA
                  UVBEGA=TOFF(U,V,1)+TADD(BE,GA)
                  Z2O(UVBEGA)=Z2(UVBEGA)
   40          CONTINUE
   30       CONTINUE
   20    CONTINUE
   10 CONTINUE
C
      RETURN
      END
C
C                         *********************
C-------------------------******  READ69 ******-------------------------
C                         *********************
C
      SUBROUTINE READ69(T1,PKT2,NO,NV,NDIMT2,ITAP69,FILE7,JOUT,
     .                  IT269,IZ169)
      IMPLICIT INTEGER (A-Z)
      REAL*8 T1(NO,NV),PKT2(NDIMT2),EREF,ECOR,ETOT
   66 FORMAT (2I5,F20.12)
C
      CALL SREAD(ITAP69,T1,INTOWP(NO*NV))
C*CCD CALL ZERO(T1,NO*NV)
C*CCD
C     DO 12 I=1,NO
C        DO 13 A=1,NV
C           WRITE (FILE7,66) I,A,T1(I,A)
C  13    CONTINUE
C  12 CONTINUE
      CALL RGETSA(ITAP69,IT269)
C     WRITE(*,*)'IT269',IT269
      CALL SREAD(ITAP69,PKT2,INTOWP(NDIMT2))
C
C    OJO NEXT 2 LINES FOR NEW CCDMAT
C
      CALL SREAD(ITAP69,EREF,INTOWP(1))
      CALL SREAD(ITAP69,ECOR,INTOWP(1))
      CALL RGETSA(ITAP69,IZ169)
      WRITE(*,*)
      WRITE(*,*)
      WRITE(6,*) 'REFERENCE   ENERGY FROM TAPE69 = ',EREF
      WRITE(6,*) 'CORRELATION ENERGY FROM TAPE69 = ',ECOR
      ETOT=EREF+ECOR
      WRITE(6,*) '   TOTAL    ENERGY FROM TAPE69 = ',ETOT
C
C     WRITE (JOUT,6047)
 6047 FORMAT (//,2X,' ******   T1 MATRIX   ******')
C     CALL MATOUT(T1,NO,NV,NO,NV,JOUT)
C
      RETURN
      END
C
C                         *********************
C-------------------------******  UNPKT2 ******-------------------------
C                         *********************
C
      SUBROUTINE UNPKT2(ORBSYM,FLOV,NIRRED,NO,NV,NBF,NO2,NTRV,NTR,
     .                  T2,PKT2,NDIMT2,JOUT)
      IMPLICIT INTEGER (A-Z)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NBF)
      REAL*8 T2(NO2,NTRV),PKT2(NDIMT2)
C
C     UNPACK T2
C
      CALL ZERO(T2,NO2*NTRV)
      NOFF=0
      DO 130 TSYM=1,NIRRED
      DO 130 USYM=1,NIRRED
      DO 130 VSYM=1,NIRRED
      UVSYM=IEOR(USYM-1,VSYM-1)+1
      IF(UVSYM.NE.TSYM) GO TO 125
      DO 120 U=FLOV(USYM,1),FLOV(USYM,2)
      DO 120 V=FLOV(VSYM,1),FLOV(VSYM,2)
      UV=(U-1)*NO+V
      NADD=0
      DO 119 BE=1,NV
      BESYM=ORBSYM(BE+NO)
C     IF(FZV(BE).EQ.1) GO TO 119
      DO 118 GA=1,BE
C     IF(FZV(GA).EQ.1) GO TO 118
      GASYM=ORBSYM(GA+NO)
      BEGSYM=IEOR(BESYM,GASYM)+1
      IF(BEGSYM.NE.TSYM)GO TO 115
      NOFF=NOFF+1
      NADD=NADD+1
C     BEGA=IOFF(BE)+GA
      BEGA=(BE*(BE-1))/2+GA
      T2(UV,BEGA)=PKT2(NOFF)
  115 CONTINUE
  118 CONTINUE
  119 CONTINUE
  120 CONTINUE
  125 CONTINUE
  130 CONTINUE
C     WRITE(JOUT,6047)
 6047 FORMAT(//,2X,' ******   T2 MATRIX FROM UNPACK T2  ******')
C     CALL MATOUT(T2,NO2,NTRV,NO2,NTRV,JOUT)
      END
C
C                         *********************
C-------------------------******  PACKT2 ******-------------------------
C                         *********************
C
      SUBROUTINE PACKT2(ORBSYM,FLOV,NIRRED,NO,NV,NBF,NO2,NTRV,NTR,
     .                  T2,PKT2,NDIMT2,JOUT)
      IMPLICIT INTEGER (A-Z)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NBF)
      REAL*8 T2(NO2,NTRV),PKT2(NDIMT2)
C
C     PACK T2
C
      NOFF=0
      DO 130 TSYM=1,NIRRED
      DO 130 USYM=1,NIRRED
      DO 130 VSYM=1,NIRRED
      UVSYM=IEOR(USYM-1,VSYM-1)+1
      IF(UVSYM.NE.TSYM) GO TO 125
      DO 120 U=FLOV(USYM,1),FLOV(USYM,2)
      DO 120 V=FLOV(VSYM,1),FLOV(VSYM,2)
      UV=(U-1)*NO+V
      NADD=0
      DO 119 BE=1,NV
      BESYM=ORBSYM(BE+NO)
C     IF(FZV(BE).EQ.1) GO TO 119
      DO 118 GA=1,BE
C     IF(FZV(GA).EQ.1) GO TO 118
      GASYM=ORBSYM(GA+NO)
      BEGSYM=IEOR(BESYM,GASYM)+1
      IF(BEGSYM.NE.TSYM)GO TO 115
      NOFF=NOFF+1
      NADD=NADD+1
C     BEGA=IOFF(BE)+GA
      BEGA=(BE*(BE-1))/2+GA
C     T2(UV,BEGA)=PKT2(NOFF)
      PKT2(NOFF)=T2(UV,BEGA)
  115 CONTINUE
  118 CONTINUE
  119 CONTINUE
  120 CONTINUE
  125 CONTINUE
  130 CONTINUE
C     WRITE(JOUT,6047)
 6047 FORMAT(//,2X,' ******   T2 MATRIX FROM UNPACK T2  ******')
C     CALL MATOUT(T2,NO2,NTRV,NO2,NTRV,JOUT)
      END
C
C                         *********************
C-------------------------******  ECORR  ******-------------------------
C                         *********************
C
      SUBROUTINE ECORR(T2,T1,MOINTS,LENINT,NO,NV,NO2,NV2,NTRO,NTRV,IOFF,
     .                 NTR,JOUT,INO,INTRO,INTRV,NOV,INV,N2OV,ZLX,UOFF,
     .                 FLOV,ORBSYM,NIRRED,DOFF,NOFF,DADD,NADD,
     .                 TOFF,TADD,NDIMT2)
      IMPLICIT INTEGER (A-Z)
      DIMENSION IOFF(NTR)
      REAL*8 T2(NDIMT2),T1(NO,NV),MOINTS(LENINT),EC
      INTEGER INO(NOV),INTRO(N2OV),INTRV(NO*NV),INV(NV)
      INTEGER DOFF(NOFF),DADD(NADD)
      INTEGER TOFF(NO,NO,2),TADD(NV,NV)
      INTEGER ZLX(NV,NV),UOFF(NO,NO,2)
      DIMENSION FLOV(NIRRED,4),ORBSYM(NO+NV)
C
      EC=0.0D+00
      DO 10 I=1,NO
      ISYM=ORBSYM(I)
         DO 20 A=1,NV
         ASYM=ORBSYM(A+NO)
         IASYM=IEOR(ISYM,ASYM)
            AI=INO(A)+I
            DO 30 J=1,NO
            JSYM=ORBSYM(J)
            BSYM=IEOR(IASYM,JSYM)+1
            FB=FLOV(BSYM,3)-NO
            LB=FLOV(BSYM,4)-NO
               DO 40 B=FB,LB
                  BJ=INO(B)+J
                  ZL=ZLX(A,B)
                  IJAB=TOFF(I,J,ZL)+TADD(A,B)
                  JIAB=TOFF(J,I,ZL)+TADD(A,B)
                  AIBJ=DOFF(MAX0(AI,BJ))+DADD(MIN0(AI,BJ))
                  EC=EC+MOINTS(AIBJ)*(T2(IJAB)+T2(IJAB)-T2(JIAB)+
     .               T1(I,A)*T1(J,B)+T1(I,A)*T1(J,B)-T1(J,A)*T1(I,B))
   40          CONTINUE
   30       CONTINUE
   20    CONTINUE
   10 CONTINUE
C
      WRITE(6,*) 'CORRELATION ENERGY FROM ZCCSD  = ',EC
      RETURN
      END
C=======================================================================
C
      SUBROUTINE DIISC (T1O,T1N,T2,S,NO,NV,NDIMT2,NIT,IT,IECORR,
     .                  EPSI,NGO,NDIIS,MINDIM,MAXDIM,CC,BB,TT1,DT1,TT2,
     .                  DT2)
      IMPLICIT INTEGER (A-Z)
      REAL * 16 DET
      REAL * 8 EPS,ONE,XM,XMAX,XEN,XON,XLAM
      REAL * 8 T1N,T1O,S,T2,ZERO,XFAC,XADD
      REAL * 8  CC(MAXDIM),BB(MAXDIM+1,MAXDIM+2),
     .          TT1(MAXDIM,NO,NV),DT1(MAXDIM,NO,NV),
     .          TT2(MAXDIM,NDIMT2),DT2(MAXDIM,NDIMT2)
      DIMENSION T1O(NO,NV),T1N(NO,NV),T2(NDIMT2),S(NDIMT2)
C
      ZERO=0.0D0
      ONE=1.D0
      EPS=10.D0 **(-EPSI)
      IECORR=0
C
C     DIIS EXTRAPOLATION
C
      IF(NIT.LT.NDIIS) GO TO 2400
      IF(IFLAG.EQ.1) THEN
      IFLAG=0
      NCOUNT=0
      GO TO 2400
      ENDIF
      NCOUNT=NCOUNT+1
      IT=IT+1
      IF(IT.LE.MAXDIM) GO TO 2040
      DO 2030 N=1,MAXDIM-1
      DO 2010 I=1,NO
      DO 2010 A=1,NV
      DT1(N,I,A)=DT1(N+1,I,A)
 2010 TT1(N,I,A)=TT1(N+1,I,A)
      DO 2020 UVBG=1,NDIMT2
      DT2(N,UVBG)=DT2(N+1,UVBG)
 2020 TT2(N,UVBG)=TT2(N+1,UVBG)
 2030 CONTINUE
      IT=MAXDIM
 2040 CONTINUE
      DO 2050 I=1,NO
      DO 2050 A=1,NV
      DT1(IT,I,A)=T1N(I,A)-T1O(I,A)
 2050 TT1(IT,I,A)=T1O(I,A)
      DO 2060 UVBG=1,NDIMT2
      DT2(IT,UVBG)=S(UVBG)-T2(UVBG)
 2060 TT2(IT,UVBG)=T2(UVBG)
      IF(IT.LT.MINDIM) GO TO 2400
      DO 2090 N=1,IT
      DO 2090 M=1,N
      BB(N,M)=ZERO
      DO 2070 I=1,NO
      DO 2070 A=1,NV
 2070 BB(N,M)=BB(N,M)+DT1(N,I,A)*DT1(M,I,A)
      DO 2080 UVBG=1,NDIMT2
 2080 BB(N,M)=BB(N,M)+DT2(N,UVBG)*DT2(M,UVBG)
      BB(M,N)=BB(N,M)
 2090 CONTINUE
C     FIND THE MAXIMUM AND SCALE
      XM=DABS(BB(1,1))
      DO 2094 N=1,IT
      DO 2094 M=1,N
      XFAC=DABS(BB(N,M))
      XMAX=DMAX1(XM,XFAC)
      XM=XMAX
 2094 CONTINUE
      DO 2095 N=1,IT
      DO 2095 M=1,IT
 2095 BB(N,M)=BB(N,M)/XM
      IT1=IT+1
      IT2=IT+2
      DO 2100 N=1,IT
      BB(N,IT1)=-ONE
 2100 BB(IT1,N)=-ONE
      BB(IT1,IT1)= ZERO
      DO 2110 N=1,IT
 2110 BB(N,IT2)= ZERO
      BB(IT1,IT2)=-ONE
      CALL FLINQ(BB,9,IT1,1,DET)
C     WRITE(6,*)'DET=',DET
C     WRITE(4,*)'DET=',DET
      XADD=ZERO
      DO 2120 N=1,IT
      CC(N)= BB(N,IT2)
      XADD=XADD+CC(N)
C     WRITE(6,*)'N=',N,'CC(N)=',CC(N)
 2120 CONTINUE
      XEN=BB(IT1,IT2)*XM
      XEN=DSQRT(XEN)
      XON=ZERO
C     WRITE(6,*)'CSUM=',XADD
C     WRITE(4,*)'CSUM=',XADD
      DO 2124 I=1,NO
      DO 2124 A=1,NV
      XON = XON + DT1(IT,I,A)*DT1(IT,I,A)
 2124 CONTINUE
      DO 2125 UVBG=1,NDIMT2
      XON = XON + DT2(IT,UVBG)*DT2(IT,UVBG)
 2125 CONTINUE
      XON=DSQRT(XON)
      WRITE(6,*)'XEN =',XEN
      WRITE(4,*)'XEN =',XEN
      WRITE(6,*)'XON =',XON
      WRITE(4,*)'XON =',XON
      IF(DABS(XEN).GT.EPS) GO TO 2400
      IF(NCOUNT.LE.NGO) GO TO 2400
      DO 2140 I=1,NO
      DO 2140 A=1,NV
 2140 T1N(I,A)= ZERO
      DO 2160 UVBG=1,NDIMT2
 2160 S(UVBG)= ZERO
      DO 2200 N=1,IT
      DO 2170 I=1,NO
      DO 2170 A=1,NV
 2170 T1N(I,A)= T1N(I,A)+CC(N)*TT1(N,I,A)
      DO 2180 UVBG=1,NDIMT2
 2180 S(UVBG)= S(UVBG)+CC(N)*TT2(N,UVBG)
 2200 CONTINUE
      WRITE(*,*)'DIIS EXTRAPOLATION HAS BEEN DONE'
      IFLAG=1
      IECORR=1
 2400 CONTINUE
      END
C
C
C
      SUBROUTINE NCOUNT(ORBSYM,FLOV,NIRRED,NO,NV,NT,FZO,FZV,NT1,NT2,
     .                  NSGOO,NSGVV,NSGOV,NSHOV,NSLOV,NSLVO,
     .                  NT3,NTAU,OPTION,DIMAR)
      IMPLICIT INTEGER (A-Z)
      COMMON/NEWPAR/NAB(8),NAI(8),NIJ(8),MAXOO,MAXVV,MAXOV
      DIMENSION FLOV(NIRRED,4),ORBSYM(NT),FZO(NO),FZV(NV),NT3(NIRRED)
      CHARACTER * 4 OPTION
C
      DO 5 I=1,NO
      FZO(I)=0
    5 CONTINUE
      DO 6 I=1,NV
      FZV(I)=0
    6 CONTINUE
C
C     COUNT THE NON-ZERO SYMMETRY AND ACTIVE T COEFFICIENTS AND
C     2E MO INTS ONLY FOR ALLOCATION PURPOSES
C
      NT1=0
      DO 100 USYM=1,NIRRED
      FU=FLOV(USYM,1)
      LU=FLOV(USYM,2)
      DO 100  U=FU,LU
      FBE=FLOV(USYM,3)-NO
      LBE=FLOV(USYM,4)-NO
      DO 100 BE=FBE,LBE
      NT1=NT1+1
  100 CONTINUE
C
      NT2=0
      DO 230 TSYM=1,NIRRED
      DO 230 USYM=1,NIRRED
      DO 230 VSYM=1,NIRRED
      UVSYM=IEOR(USYM-1,VSYM-1)+1
      IF(UVSYM.NE.TSYM) GO TO 225
      DO 220 U=FLOV(USYM,1),FLOV(USYM,2)
      DO 220 V=FLOV(VSYM,1),FLOV(VSYM,2)
      DO 218 BE=1,NV
      IF(FZV(BE).EQ.1)GO TO 218
      BESYM=ORBSYM(BE+NO)
      DO 217 GA=1,BE
      IF(FZV(GA).EQ.1)GO TO 217
      GASYM=ORBSYM(GA+NO)
      BEGSYM=IEOR(BESYM,GASYM)+1
      IF(BEGSYM.NE.TSYM)GO TO 215
      NT2=NT2+1
  215 CONTINUE
  217 CONTINUE
  218 CONTINUE
  220 CONTINUE
  225 CONTINUE
  230 CONTINUE
C
C     DIMENSION OF AR1-6
C
      MAXOO=0
      MAXVV=0
      MAXOV=0
C
      DO 20000 TSYM=1,NIRRED
      XAB=0
      DO 19490 A=1,NV
      IF(FZV(A).EQ.1)GO TO 19490
      ASYM=ORBSYM(A+NO)
      DO 19480 B=1,A
      IF(FZV(B).EQ.1)GO TO 19480
      BSYM=ORBSYM(B+NO)
      BASYM=IEOR(BSYM,ASYM)
      IF(BASYM.NE.TSYM-1)GO TO 19480
      XAB=XAB+1
      XIJ=0
      DO 19470 I=1,NO
      IF(FZO(I).EQ.1)GO TO 19470
      ISYM=ORBSYM(I)
      JSYM=IEOR(ISYM,BASYM)+1
      FJ=FLOV(JSYM,1)
      LJ=FLOV(JSYM,2)
      IF(LJ.GT.I)LJ=I
      DO 19460 J=FJ,LJ
      XIJ=XIJ+1
19460 CONTINUE
19470 CONTINUE
19480 CONTINUE
19490 CONTINUE
      IF(XIJ.GT.MAXOO)MAXOO=XIJ
      IF(XAB.GT.MAXVV)MAXVV=XAB
C     WRITE(*,*)'TSYM=',TSYM,' XIJ=',XIJ,' XAB=',XAB,'   ',XIJ*XAB
20000 CONTINUE
C
      DO 20001 TSYM=1,NIRRED
      XAI=0
      DO 15790 I=1,NO
      IF(FZO(I).EQ.1)GO TO 15790
      ISYM=ORBSYM(I)
      DO 15770 A=1,NV
      IF(FZV(A).EQ.1)GO TO 15770
      ASYM=ORBSYM(A+NO)
      IASYM=IEOR(ISYM,ASYM)
      IF(IASYM.NE.TSYM-1)GO TO 15770
      XAI=XAI+1
      XBJ=0
      DO 15750 J=1,NO
      IF(FZO(J).EQ.1)GO TO 15750
      JSYM=ORBSYM(J)
      BSYM=IEOR(JSYM,IASYM)+1
      FB=FLOV(BSYM,3)-NO
      LB=FLOV(BSYM,4)-NO
      DO 15730 B=FB,LB
      XBJ=XBJ+1
15730 CONTINUE
15750 CONTINUE
15770 CONTINUE
15790 CONTINUE
      NAI(TSYM)=XAI
      IF(XAI.GT.MAXOV)MAXOV=XAI
C     WRITE(*,*)'TSYM=',TSYM,' XBJ=',XBJ,' XAI=',XAI,'   ',XAI*XBJ
C
20001 CONTINUE
C
      WRITE(6,*)' '
      WRITE(*,*)'MAXOV=',MAXOV
      WRITE(*,*)'MAXOO=',MAXOO,' MAXVV=',MAXVV
      DIMAR=MAX0(MAXOO*MAXVV,MAXOV*MAXOV)
      WRITE(*,*)'DIMAR=', DIMAR
      WRITE(6,*)' '
 
C
C     COUNT SYMMETRY NON-ZERO T3
C
      NTAU=NT2
      IF(OPTION.EQ.'SDT1')THEN
      WRITE(6,*)
      DO 440 KCSYM=1,NIRRED
      NPFF=0
      DO 430 U=1,NO
      IF(FZO(U).EQ.1)GO TO 430
      USYM=ORBSYM(U)
      DO 420 V=1,NO
      IF(FZO(V).EQ.1)GO TO 420
      VSYM=ORBSYM(V)
      UVSYM=IEOR(USYM,VSYM)
      DO 418 BE=1,NV
      IF(FZV(BE).EQ.1)GO TO 418
      BESYM=ORBSYM(BE+NO)
C     DO 417 GA=1,NV
      DO 417 GA=1,BE
      IF(FZV(GA).EQ.1)GO TO 417
      GASYM=ORBSYM(GA+NO)
      BEGSYM=IEOR(BESYM,GASYM)
      TSYM=IEOR(UVSYM,BEGSYM)
      IF((KCSYM-1).NE.TSYM)GO TO 415
      NPFF=NPFF+1
C     WRITE(*,657)U,V,BE,GA,NPFF
  657 FORMAT(' U=',I3,' V=',I3,' BE=',I3,' GA=',I3,'NPFF= ',I6)
  415 CONTINUE
  417 CONTINUE
  418 CONTINUE
  420 CONTINUE
  430 CONTINUE
      NT3(KCSYM)=NPFF
  440 CONTINUE
      WRITE(6,7)NT3(1)
    7 FORMAT(1X,'NT3(1) =',I6)
      IF(NT3(1).NE.NT2)WRITE(*,*)'WARNING ...   NT3(1).NE.NT2'
      NTAU=NT3(1)
      DO 455 I=2,NIRRED
      IF(NT3(I).GT.NT3(1))THEN
      WRITE(*,*)'WARNING !!!  SOME NT3.GT.NT2'
      NTAU=NT3(I)
      ENDIF
      WRITE(6,8)I,NT3(I)
    8 FORMAT(1X,'NT3(',I1,') =',I6)
  455 CONTINUE
      ENDIF
C
      NSGOO=0
      DO 390 I=1,NO
      IF(FZO(I).EQ.1)GO TO 390
      ISYM=ORBSYM(I)
      DO 380 J=1,I
      IF(FZO(J).EQ.1)GO TO 380
      JSYM=ORBSYM(J)
      IJSYM=IEOR(ISYM,JSYM)
      DO 370 K=1,I
      IF(FZO(K).EQ.1)GO TO 370
      KSYM=ORBSYM(K)
      LL=K
      IF(K.EQ.I)LL=J
      DO 360 L=1,LL
      IF(FZO(L).EQ.1)GO TO 360
      LSYM=ORBSYM(L)
      KLSYM=IEOR(KSYM,LSYM)
      IF(IJSYM.NE.KLSYM) GO TO 350
      NSGOO=NSGOO+1
  350 CONTINUE
  360 CONTINUE
  370 CONTINUE
  380 CONTINUE
  390 CONTINUE
C
      NSGVV=0
      DO 490 I=1,NV
      IF(FZV(I).EQ.1)GO TO 490
      ISYM=ORBSYM(I+NO)
      DO 480 J=1,I
      IF(FZV(J).EQ.1)GO TO 480
      JSYM=ORBSYM(J+NO)
      IJSYM=IEOR(ISYM,JSYM)
      DO 470 K=1,I
      IF(FZV(K).EQ.1)GO TO 470
      KSYM=ORBSYM(K+NO)
      LL=K
      IF(K.EQ.I)LL=J
      DO 460 L=1,LL
      IF(FZV(L).EQ.1)GO TO 460
      LSYM=ORBSYM(L+NO)
      KLSYM=IEOR(KSYM,LSYM)
      IF(IJSYM.NE.KLSYM) GO TO 450
      NSGVV=NSGVV+1
  450 CONTINUE
  460 CONTINUE
  470 CONTINUE
  480 CONTINUE
  490 CONTINUE
C
      NSGOV=0
      DO 590 I=1,NO
      IF(FZO(I).EQ.1)GO TO 590
      ISYM=ORBSYM(I)
      DO 580 J=1,I
      IF(FZO(J).EQ.1)GO TO 580
      JSYM=ORBSYM(J)
      IJSYM=IEOR(ISYM,JSYM)
      DO 570 K=1,NV
      IF(FZV(K).EQ.1)GO TO 570
      KSYM=ORBSYM(K+NO)
      DO 560 L=1,K
      IF(FZV(L).EQ.1)GO TO 560
      LSYM=ORBSYM(L+NO)
      KLSYM=IEOR(KSYM,LSYM)
      IF(IJSYM.NE.KLSYM) GO TO 550
      NSGOV=NSGOV+1
  550 CONTINUE
  560 CONTINUE
  570 CONTINUE
  580 CONTINUE
  590 CONTINUE
C
      NSHOV=0
      DO 690 I=1,NV
      IF(FZV(I).EQ.1)GO TO 690
      ISYM=ORBSYM(I+NO)
      DO 680 J=1,NO
      IF(FZO(J).EQ.1)GO TO 680
      JSYM=ORBSYM(J)
      IJSYM=IEOR(ISYM,JSYM)
      DO 670 K=1,I
      IF(FZV(K).EQ.1)GO TO 670
      KSYM=ORBSYM(K+NO)
      LL=NO
      IF(K.EQ.I)LL=J
      DO 660 L=1,LL
      IF(FZO(L).EQ.1)GO TO 660
      LSYM=ORBSYM(L)
      KLSYM=IEOR(KSYM,LSYM)
      IF(IJSYM.NE.KLSYM) GO TO 650
      NSHOV=NSHOV+1
  650 CONTINUE
  660 CONTINUE
  670 CONTINUE
  680 CONTINUE
  690 CONTINUE
C
      NSLOV=0
      DO 790 I=1,NV
      IF(FZV(I).EQ.1)GO TO 790
      ISYM=ORBSYM(I+NO)
      DO 780 J=1,NO
      IF(FZO(J).EQ.1)GO TO 780
      JSYM=ORBSYM(J)
      IJSYM=IEOR(ISYM,JSYM)
      DO 770 K=1,NO
      IF(FZO(K).EQ.1)GO TO 770
      KSYM=ORBSYM(K)
      DO 760 L=1,K
      IF(FZO(L).EQ.1)GO TO 760
      LSYM=ORBSYM(L)
      KLSYM=IEOR(KSYM,LSYM)
      IF(IJSYM.NE.KLSYM) GO TO 750
      NSLOV=NSLOV+1
  750 CONTINUE
  760 CONTINUE
  770 CONTINUE
  780 CONTINUE
  790 CONTINUE
C
      NSLVO=0
      DO 890 I=1,NV
      IF(FZV(I).EQ.1)GO TO 890
      ISYM=ORBSYM(I+NO)
      DO 880 J=1,I
      IF(FZV(J).EQ.1)GO TO 880
      JSYM=ORBSYM(J+NO)
      IJSYM=IEOR(ISYM,JSYM)
      DO 870 K=1,NV
      IF(FZV(K).EQ.1)GO TO 870
      KSYM=ORBSYM(K+NO)
      DO 860 L=1,NO
      IF(FZO(L).EQ.1)GO TO 860
      LSYM=ORBSYM(L)
      KLSYM=IEOR(KSYM,LSYM)
      IF(IJSYM.NE.KLSYM) GO TO 850
      NSLVO=NSLVO+1
  850 CONTINUE
  860 CONTINUE
  870 CONTINUE
  880 CONTINUE
  890 CONTINUE
      END
C
C=======================================================================
C
      SUBROUTINE SYMARR(ORBSYM,FLOV,NIRRED,NO,NV,NT,NOV,NM,
     .                  FZO,FZV,NFZO,NFZV,
     .                  UOFF,VADD,ITR,ITV,NONO,NVNV,
     .                  AOFF,AADD,BOFF,BADD,COFF,CADD,
     .                  DOFF,DADD,EOFF,EADD,FOFF,FADD,
     .                  TOFF,TADD,OPTION,EMOFF,EMADD,LEMAT)
      IMPLICIT INTEGER (A-Z)
      CHARACTER *4 OPTION
      COMMON/INTS/NSGOO,NSGVV,NSGOV,NSHOV,NSLOV,NSLVO
      DIMENSION FLOV(NIRRED,4),ORBSYM(NT),UOFF(NO,NO,2),VADD(NV,NV),
     .                     FZO(NO),FZV(NV),NFZO(NIRRED),NFZV(NIRRED)
      DIMENSION AOFF(NONO),AADD(NONO),BOFF(NVNV),BADD(NVNV),COFF(NVNV),
     .          CADD(NONO),DOFF(NM)  ,DADD(NM)  ,EOFF(NM)  ,EADD(NONO),
     .          FOFF(NVNV),FADD(NM),EMOFF(NM),EMADD(NONO)
      DIMENSION ITR(NOV),ITV(NV)
      DIMENSION TOFF(NO,NO,2,NIRRED),TADD(NV,NV,NIRRED)
C
C     SET UP ARRAYS TO ADRESS T COEFF. AND 2E MO INTS.
C
      NOFF=0
      DO 130 TSYM=1,NIRRED
      DO 130 USYM=1,NIRRED
      DO 130 VSYM=1,NIRRED
      UVSYM=IEOR(USYM-1,VSYM-1)+1
      IF(UVSYM.NE.TSYM) GO TO 125
      DO 120 U=FLOV(USYM,1),FLOV(USYM,2)
      DO 120 V=FLOV(VSYM,1),FLOV(VSYM,2)
      NADD=0
      UOFF(U,V,1)=NOFF
      DO 119 BE=1,NV
      BESYM=ORBSYM(BE+NO)
      IF(FZV(BE).EQ.1) GO TO 119
      DO 118 GA=1,BE
      IF(FZV(GA).EQ.1) GO TO 118
      GASYM=ORBSYM(GA+NO)
      BEGSYM=IEOR(BESYM,GASYM)+1
      IF(BEGSYM.NE.TSYM)GO TO 115
      NOFF=NOFF+1
      NADD=NADD+1
      VADD(BE,GA)=NADD
      TOT=UOFF(U,V,1)+VADD(BE,GA)
C     WRITE(6,657) U,V,UOFF(U,V,1),BE,GA,VADD(BE,GA),TOT
  115 CONTINUE
  118 CONTINUE
  119 CONTINUE
  120 CONTINUE
  125 CONTINUE
  130 CONTINUE
      DO 150 U=1,NO
      DO 150 V=1,NO
  150 UOFF(V,U,2)=UOFF(U,V,1)
      DO 160 A=1,NV
      DO 160 B=1,A
C     ZLX(B,A)=2
C     ZLX(A,B)=1
  160 VADD(B,A)=VADD(A,B)
  657 FORMAT(' U=',I3,' V=',I3,' UOFF=',I6,' BE=',I3,' GA=',I3,
     .                        ' VADD=',I6,' TOT= ',I6)
C
C     FORM ARRAYS FOR T3
C
      IF(OPTION.EQ.'SDT1')THEN
      DO 890 T3SYM=1,NIRRED
      NOFF=0
      DO 880 TSYM=1,NIRRED
      DO 875 USYM=1,NIRRED
      DO 870 VSYM=1,NIRRED
      UVSYM=IEOR(USYM-1,VSYM-1)
      IF(UVSYM.NE.TSYM-1)GO TO 870
      DO 865 U=FLOV(USYM,1),FLOV(USYM,2)
      DO 860 V=FLOV(VSYM,1),FLOV(VSYM,2)
      NADD=0
      TOFF(U,V,1,T3SYM)=NOFF
      DO 850 BE=1,NV
      IF(FZV(BE).EQ.1)GO TO 850
      BESYM=ORBSYM(BE+NO)
C     DO 840 GA=1,NV
      DO 840 GA=1,BE
      IF(FZV(GA).EQ.1)GO TO 840
      GASYM=ORBSYM(GA+NO)
      BEGSYM=IEOR(BESYM,GASYM)
      XSYM=IEOR(UVSYM,BEGSYM)+1
      IF(XSYM.NE.T3SYM)GO TO 820
      NOFF=NOFF+1
      NADD=NADD+1
      TADD(BE,GA,T3SYM)=NADD
      TOT=TOFF(U,V,1,T3SYM)+TADD(BE,GA,T3SYM)
C     WRITE(6,657) U,V,TOFF(U,V,1,T3SYM),BE,GA,TADD(BE,GA,T3SYM),TOT
  820 CONTINUE
  840 CONTINUE
  850 CONTINUE
  860 CONTINUE
  865 CONTINUE
  870 CONTINUE
  875 CONTINUE
  880 CONTINUE
      DO 885 U=1,NO
      DO 885 V=1,NO
  885 TOFF(V,U,2,T3SYM)=TOFF(U,V,1,T3SYM)
      DO 887 BE=1,NV
      DO 887 GA=1,BE
  887 TADD(GA,BE,T3SYM)=TADD(BE,GA,T3SYM)
  890 CONTINUE
      ENDIF
C
C     A INTS  (OO,OO)
      NOFF=0
      DO 280 TSYM=1,NIRRED
      DO 270 ISYM=1,NIRRED
      DO 260 JSYM=1,ISYM
      IJSYM=IEOR(ISYM-1,JSYM-1)+1
      IF(IJSYM.NE.TSYM) GO TO 260
      FI=FLOV(ISYM,1)-NFZO(ISYM)
      DO 250 I=FI,FLOV(ISYM,2)
      JLIM=FLOV(JSYM,2)
      IF(ISYM.EQ.JSYM)JLIM=I
      FJ=FLOV(JSYM,1)-NFZO(JSYM)
      DO 250 J=FJ,JLIM
      NADD=0
      IJ=ITR(I)+J
      IF(FZO(I).EQ.1.OR.FZO(J).EQ.1)THEN
      AOFF(IJ)=NSGOO+1
      GO TO 202
      ENDIF
      AOFF(IJ)=NOFF
  202 CONTINUE
      DO 230 K=1,I
      KSYM=ORBSYM(K)
      LL=K
      IF(K.EQ.I)LL=J
      DO 220 L=1,LL
      LSYM=ORBSYM(L)
      KL=ITR(K)+L
      KLSYM=IEOR(KSYM,LSYM)+1
      IF(KLSYM.NE.TSYM)GO TO 210
      IF(FZO(I).EQ.1.OR.FZO(J).EQ.1)GO TO 205
      IF(FZO(K).EQ.1.OR.FZO(L).EQ.1)THEN
      AADD(KL)=NSGOO+1
      GO TO 205
      ENDIF
      NOFF=NOFF+1
      NADD=NADD+1
      AADD(KL)=NADD
  205 CONTINUE
      TOT=AOFF(IJ)+AADD(KL)
C     WRITE(6,657) I,J,AOFF(IJ),K,L,AADD(KL),TOT
  210 CONTINUE
  220 CONTINUE
  230 CONTINUE
  240 CONTINUE
  250 CONTINUE
  260 CONTINUE
  270 CONTINUE
  280 CONTINUE
C
C     B INTS   (VV,VV)
      NOFF=0
      DO 380 TSYM=1,NIRRED
      DO 370 ISYM=1,NIRRED
      DO 360 JSYM=1,ISYM
      IJSYM=IEOR(ISYM-1,JSYM-1)+1
      IF(IJSYM.NE.TSYM) GO TO 360
      FI=FLOV(ISYM,3)-NO
      LI=FLOV(ISYM,4)+NFZV(ISYM)-NO
      DO 350 I=FI,LI
      JLIM=FLOV(JSYM,4) +NFZV(JSYM)-NO
      IF(ISYM.EQ.JSYM)JLIM=I
      DO 350 J=FLOV(JSYM,3)-NO,JLIM
      NADD=0
      IJ=ITV(I)+J
      IF(FZV(I).EQ.1.OR.FZV(J).EQ.1)THEN
      BOFF(IJ)=NSGVV+1
      GO TO 302
      ENDIF
      BOFF(IJ)=NOFF
  302 CONTINUE
      DO 330 K=1,I
      KSYM=ORBSYM(K+NO)
      LL=K
      IF(K.EQ.I)LL=J
      DO 320 L=1,LL
      LSYM=ORBSYM(L+NO)
      KL=ITV(K)+L
      KLSYM=IEOR(KSYM,LSYM)+1
      IF(KLSYM.NE.TSYM)GO TO 310
      IF(FZV(I).EQ.1.OR.FZV(J).EQ.1)GO TO 305
      IF(FZV(K).EQ.1.OR.FZV(L).EQ.1)THEN
      BADD(KL)=NSGVV+1
      GO TO 305
      ENDIF
      NOFF=NOFF+1
      NADD=NADD+1
      BADD(KL)=NADD
  305 CONTINUE
      TOT=BOFF(IJ)+BADD(KL)
C     WRITE(6,657) I,J,BOFF(IJ),K,L,BADD(KL),TOT
  310 CONTINUE
  320 CONTINUE
  330 CONTINUE
  340 CONTINUE
  350 CONTINUE
  360 CONTINUE
  370 CONTINUE
  380 CONTINUE
C
C     C INTS   (VV,OO)
      NOFF=0
      DO 460 TSYM=1,NIRRED
      DO 460 ISYM=1,NIRRED
      DO 460 JSYM=1,ISYM
      IJSYM=IEOR(ISYM-1,JSYM-1)+1
      IF(IJSYM.NE.TSYM) GO TO 460
      FI=FLOV(ISYM,3)-NO
      LI=FLOV(ISYM,4)+NFZV(ISYM)-NO
      DO 450 I=FI,LI
      FJ=FLOV(JSYM,3)-NO
      LJ=FLOV(JSYM,4)+NFZV(JSYM)-NO
      IF(ISYM.EQ.JSYM)LJ=I
      DO 450 J=FJ,LJ
      NADD=0
      IJ=ITV(I)+J
      IF(FZV(I).EQ.1.OR.FZV(J).EQ.1)THEN
      COFF(IJ)=NSGOV+1
      GO TO 402
      ENDIF
      COFF(IJ)=NOFF
  402 CONTINUE
      DO 430 K=1,NO
      KSYM=ORBSYM(K)
      DO 420 L=1,K
      LSYM=ORBSYM(L)
      KL=ITR(K)+L
      KLSYM=IEOR(KSYM,LSYM)+1
      IF(KLSYM.NE.TSYM)GO TO 410
      IF(FZV(I).EQ.1.OR.FZV(J).EQ.1)GO TO 405
      IF(FZO(K).EQ.1.OR.FZO(L).EQ.1)THEN
      CADD(KL)=NSGOV+1
      GO TO 405
      ENDIF
      NOFF=NOFF+1
      NADD=NADD+1
      CADD(KL)=NADD
  405 CONTINUE
      TOT=COFF(IJ)+CADD(KL)
C     WRITE(6,657) I,J,COFF(IJ),K,L,CADD(KL),TOT
  410 CONTINUE
  420 CONTINUE
  430 CONTINUE
  440 CONTINUE
  450 CONTINUE
  460 CONTINUE
  470 CONTINUE
  480 CONTINUE
C
C     D INTS   (VO,VO)
      NOFF=0
      DO 560 TSYM=1,NIRRED
      DO 560 ISYM=1,NIRRED
      DO 560 JSYM=1,NIRRED
      IJSYM=IEOR(ISYM-1,JSYM-1)+1
      IF(IJSYM.NE.TSYM) GO TO 560
      FI=FLOV(ISYM,3)-NO
      LI=FLOV(ISYM,4)+NFZV(ISYM)-NO
      DO 550 I=FI,LI
      FJ=FLOV(JSYM,1)-NFZO(JSYM)
      LJ=FLOV(JSYM,2)
      DO 550 J=FJ,LJ
      NADD=0
      IJ=ITR(I)+J
      IF(FZV(I).EQ.1.OR.FZO(J).EQ.1)THEN
      DOFF(IJ)=NSHOV+1
      GO TO 502
      ENDIF
      DOFF(IJ)=NOFF
  502 CONTINUE
      DO 530 K=1,I
      KSYM=ORBSYM(K+NO)
      LL=NO
      IF(K.EQ.I)LL=J
      DO 520 L=1,LL
      LSYM=ORBSYM(L)
      KL=ITR(K)+L
      KLSYM=IEOR(KSYM,LSYM)+1
      IF(KLSYM.NE.TSYM)GO TO 510
      IF(FZV(I).EQ.1.OR.FZO(J).EQ.1)GO TO 505
      IF(FZV(K).EQ.1.OR.FZO(L).EQ.1)THEN
      DADD(KL)=NSHOV+1
      GO TO 505
      ENDIF
      NOFF=NOFF+1
      NADD=NADD+1
      DADD(KL)=NADD
  505 CONTINUE
      TOT=DOFF(IJ)+DADD(KL)
C     WRITE(6,657) I,J,DOFF(IJ),K,L,DADD(KL),TOT
  510 CONTINUE
  520 CONTINUE
  530 CONTINUE
  540 CONTINUE
  550 CONTINUE
  560 CONTINUE
  570 CONTINUE
  580 CONTINUE
C
C     E INTS   (VO,OO)
      NOFF=0
      DO 660 TSYM=1,NIRRED
      DO 660 ISYM=1,NIRRED
      DO 660 JSYM=1,NIRRED
      IJSYM=IEOR(ISYM-1,JSYM-1)+1
      IF(IJSYM.NE.TSYM) GO TO 660
      FI=FLOV(ISYM,3)-NO
      LI=FLOV(ISYM,4)+NFZV(ISYM)-NO
      DO 650 I=FI,LI
      FJ=FLOV(JSYM,1)-NFZO(JSYM)
      LJ=FLOV(JSYM,2)
      DO 650 J=FJ,LJ
      NADD=0
      IJ=ITR(I)+J
      IF(FZV(I).EQ.1.OR.FZO(J).EQ.1)THEN
      EOFF(IJ)=NSLOV+1
      GO TO 602
      ENDIF
      EOFF(IJ)=NOFF
  602 CONTINUE
      DO 630 K=1,NO
      KSYM=ORBSYM(K)
      DO 620 L=1,K
      LSYM=ORBSYM(L)
      KL=ITR(K)+L
      KLSYM=IEOR(KSYM,LSYM)+1
      IF(KLSYM.NE.TSYM)GO TO 610
      IF(FZV(I).EQ.1.OR.FZO(J).EQ.1)GO TO 605
      IF(FZO(K).EQ.1.OR.FZO(L).EQ.1)THEN
      EADD(KL)=NSLOV+1
      GO TO 605
      ENDIF
      NOFF=NOFF+1
      NADD=NADD+1
      EADD(KL)=NADD
  605 CONTINUE
      TOT=EOFF(IJ)+EADD(KL)
C     WRITE(6,657) I,J,EOFF(IJ),K,L,EADD(KL),TOT
  610 CONTINUE
  620 CONTINUE
  630 CONTINUE
  640 CONTINUE
  650 CONTINUE
  660 CONTINUE
  670 CONTINUE
  680 CONTINUE
C
C     EMAT
C
      NOFF=0
      DO 691 TSYM=1,NIRRED
      DO 681 ISYM=1,NIRRED
      DO 671 JSYM=1,NIRRED
      IJSYM=IEOR(ISYM-1,JSYM-1)+1
      IF(IJSYM.NE.TSYM) GO TO 671
      FI=FLOV(ISYM,3)-NO
      LI=FLOV(ISYM,4)+NFZV(ISYM)-NO
      DO 661 I=FI,LI
      FJ=FLOV(JSYM,1)-NFZO(JSYM)
      LJ=FLOV(JSYM,2)
      DO 651 J=FJ,LJ
      NADD=0
      IJ=ITR(I)+J
C     IF(FZV(I).EQ.1.OR.FZO(J).EQ.1)THEN
C     EMOFF(IJ)=2*NSLOV+1
C     GO TO 603
C     ENDIF
      EMOFF(IJ)=NOFF
C 603 CONTINUE
      DO 631 K=1,NO
      KSYM=ORBSYM(K)
      DO 621 L=1,NO
      LSYM=ORBSYM(L)
      KL=ITR(K)+L
      KLSYM=IEOR(KSYM,LSYM)+1
      IF(KLSYM.NE.TSYM)GO TO 611
C     IF(FZV(I).EQ.1.OR.FZO(J).EQ.1)GO TO 606
C     IF(FZO(K).EQ.1.OR.FZO(L).EQ.1)THEN
C     EMADD(KL)=NSLOV+1
C     GO TO 606
C     ENDIF
      NOFF=NOFF+1
      NADD=NADD+1
      EMADD(KL)=NADD
C 606 CONTINUE
      TOT=EMOFF(IJ)+EMADD(KL)
C     WRITE(6,657) I,J,EMOFF(IJ),K,L,EMADD(KL),TOT
  611 CONTINUE
  621 CONTINUE
  631 CONTINUE
  651 CONTINUE
  661 CONTINUE
  671 CONTINUE
  681 CONTINUE
  691 CONTINUE
      LEMAT=TOT
C
C     F INTS   (VV,VO)
C
      NOFF=0
      DO 760 TSYM=1,NIRRED
      DO 760 ISYM=1,NIRRED
      DO 760 JSYM=1,ISYM
      IJSYM=IEOR(ISYM-1,JSYM-1)+1
      IF(IJSYM.NE.TSYM) GO TO 760
      FI=FLOV(ISYM,3)-NO
      LI=FLOV(ISYM,4)+NFZV(ISYM)-NO
      DO 750 I=FI,LI
      FJ=FLOV(JSYM,3)-NO
      LJ=FLOV(JSYM,4)+NFZV(JSYM)-NO
      IF(ISYM.EQ.JSYM)LJ=I
      DO 750 J=FJ,LJ
      NADD=0
      IJ=ITV(I)+J
      IF(FZV(I).EQ.1.OR.FZV(J).EQ.1)THEN
      FOFF(IJ)=NSLVO+1
      GO TO 702
      ENDIF
      FOFF(IJ)=NOFF
  702 CONTINUE
      DO 730 K=1,NV
      KSYM=ORBSYM(K+NO)
      DO 720 L=1,NO
      LSYM=ORBSYM(L)
      KL=ITR(K)+L
      KLSYM=IEOR(KSYM,LSYM)+1
      IF(KLSYM.NE.TSYM)GO TO 710
      IF(FZV(I).EQ.1.OR.FZV(J).EQ.1)GO TO 705
      IF(FZV(K).EQ.1.OR.FZO(L).EQ.1)THEN
      FADD(KL)=NSLVO+1
      GO TO 705
      ENDIF
      NOFF=NOFF+1
      NADD=NADD+1
      FADD(KL)=NADD
  705 CONTINUE
      TOT=FOFF(IJ)+FADD(KL)
C     WRITE(6,657) I,J,FOFF(IJ),K,L,FADD(KL),TOT
  710 CONTINUE
  720 CONTINUE
  730 CONTINUE
  740 CONTINUE
  750 CONTINUE
  760 CONTINUE
  770 CONTINUE
  780 CONTINUE
      END
C
C=======================================================================
C
      SUBROUTINE DIISD (T1O,T1N,T2,S,NO,NV,NDIMT2,NIT,IT,IECORR,
     .                  EPSI,NGO,NDIIS,MINDIM,MAXDIM,
     .                  CC,BB,ITAP98,ITAP99,ITC,BB2)
      IMPLICIT INTEGER (A-Z)
      REAL * 16 DET
      REAL*8 BB,EPS,CC,ONE,XM,XMAX,XEN,XON,XLAM,BB2
      REAL*8 T1N,T1O,S,T2,A0,XFAC,XADD
      DIMENSION CC(MAXDIM),BB(MAXDIM+1,MAXDIM+2),BB2(MAXDIM+1,MAXDIM+2)
      DIMENSION T1O(NO,NV),T1N(NO,NV),T2(NDIMT2),S(NDIMT2)
C
C    NGO,NDIIS,EPSI,MINDIM  ARE DUMMY!
C
      A0 = 0.0D0
      ONE=1.D0
      EPS=10.D0 **(-EPSI)
      IECORR=0
C
C     DIIS EXTRAPOLATION
C
      IFLAG=0
      NCOUNT=0
      NCOUNT=NCOUNT+1
      IT=IT+1
      IF(IT.GT.MAXDIM) IT = MAXDIM
      ITC = ITC + 1
      IF(ITC.GT.MAXDIM) ITC = 1
C
      DO 2050 I=1,NO
      DO 2051 A=1,NV
      T1O(I,A) = T1N(I,A) - T1O(I,A)
 2051 CONTINUE
 2050 CONTINUE
C
      PT1 = (ITC-1)*INTOWP(NO*NV + NDIMT2) + 1
      PT2 = PT1 + INTOWP(NO*NV)
      CALL WWRITW(ITAP99,T1O,INTOWP(NO*NV),PT1,JUNK)
      CALL WWRITW(ITAP98,T1N,INTOWP(NO*NV),PT1,JUNK)
C
      DO 2060 UVBG=1,NDIMT2
      T2(UVBG) = S(UVBG) - T2(UVBG)
 2060 CONTINUE
C
      CALL WWRITW(ITAP99,T2,INTOWP(NDIMT2),PT2,JUNK)
      CALL WWRITW(ITAP98,S,INTOWP(NDIMT2),PT2,JUNK)
C
      DO 2090 N=1,IT
C
      PT1 = (N-1)*INTOWP(NO*NV + NDIMT2) + 1
      PT2 = PT1 + INTOWP(NO*NV)
      CALL WREADW(ITAP99,T1N,INTOWP(NO*NV),PT1,JUNK)
      CALL WREADW(ITAP99,S,INTOWP(NDIMT2),PT2,JUNK)
C
      BB2(N,ITC) = A0
C
      DO 2070 I=1,NO
      DO 2071 A=1,NV
      BB2(N,ITC) = BB2(N,ITC) + T1N(I,A)*T1O(I,A)
 2071 CONTINUE
 2070 CONTINUE
C
      DO 2080 UVBG=1,NDIMT2
      BB2(N,ITC) = BB2(N,ITC) + S(UVBG)*T2(UVBG)
 2080 CONTINUE
      BB2(ITC,N) = BB2(N,ITC)
 2090 CONTINUE
C
C  TRANSFER INTO THE BB ARRAY
C
      DO 10 N = 1,IT
      DO 20 M = 1,N-1
      BB(N,M) = BB2(N,M)
      BB(M,N) = BB2(M,N)
  20  CONTINUE
      BB(N,N) = BB2(N,N)
  10  CONTINUE
C
C     FIND THE MAXIMUM AND SCALE
      XM=DABS(BB(1,1))
      DO 2094 N=1,IT
      DO 2094 M=1,N
      XFAC=DABS(BB(N,M))
      XMAX=DMAX1(XM,XFAC)
      XM=XMAX
 2094 CONTINUE
      DO 2095 N=1,IT
      DO 2095 M=1,IT
 2095 BB(N,M)=BB(N,M)/XM
      IT1=IT+1
      IT2=IT+2
      DO 2100 N=1,IT
      BB(N,IT1)=-ONE
 2100 BB(IT1,N)=-ONE
      BB(IT1,IT1)= A0
      DO 2110 N=1,IT
 2110 BB(N,IT2)= A0
      BB(IT1,IT2)=-ONE
C     WRITE(*,*)'B MATRIX'
C     CALL MATOUT(BB,IT1,IT2,IT1,IT2,6)
      CALL FLINQ(BB,9,IT1,1,DET)
C     WRITE(6,*)'DET=',DET
C     WRITE(4,*)'DET=',DET
      XADD=A0
      DO 2120 N=1,IT
      CC(N)= BB(N,IT2)
      XADD=XADD+CC(N)
C     WRITE(6,*)'N=',N,'CC(N)=',CC(N)
 2120 CONTINUE
      XEN=BB(IT1,IT2)*XM
      XEN=DSQRT(XEN)
      XON=A0
C     WRITE(6,*)'CSUM=',XADD
C     WRITE(4,*)'CSUM=',XADD
C     WRITE(6,*)'  XEN = ',XEN,'  XON = ',XON
C     WRITE(4,*)'  XEN = ',XEN
C
      CALL ZERO(T1N,NO*NV)
      CALL ZERO(S,NDIMT2)
C
      DO 2200 N=1,IT
C
      PT1 = (N-1)*INTOWP(NO*NV + NDIMT2) + 1
      PT2 = PT1 + INTOWP(NO*NV)
      CALL WREADW(ITAP98,T1O,INTOWP(NO*NV),PT1,JUNK)
      CALL WREADW(ITAP98,T2,INTOWP(NDIMT2),PT2,JUNK)
C
      DO 2170 I=1,NO
      DO 2171 A=1,NV
      T1N(I,A) = T1N(I,A) + CC(N)*T1O(I,A)
 2171 CONTINUE
 2170 CONTINUE
C
      DO 2180 UVBG=1,NDIMT2
      S(UVBG) = S(UVBG) + CC(N)*T2(UVBG)
 2180 CONTINUE
C
 2200 CONTINUE
      IFLAG=1
      IECORR=1
 2400 CONTINUE
      RETURN
      END
